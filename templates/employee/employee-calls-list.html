{% extends 'employee/base.html' %} 

{% block content %}
<div class="page-wrapper">
    <div class="page-header d-print-none">
        <div class="container-xl">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <h2 class="page-title">My Call Performance</h2>
                    <div class="text-muted mt-1">
                        Showing your call data from <strong>{{ start_date|date:"M d, Y" }}</strong> to <strong>{{ end_date|date:"M d, Y" }}</strong>
                    </div>
                </div>
                <div class="col-auto ms-auto d-print-none">
                    <a href="{% url 'employee_performance_dashboard' %}" class="btn btn-primary">
                        Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="page-body">
        <div class="container-xl">
            <div class="card card-body mb-4">
                <form method="get" class="row g-3 align-items-end">
                    <div class="col-md-9">
                        <label class="form-label">Select Period</label>
                        <select name="period" class="form-select">
                            <option value="today" {% if period == 'today' %}selected{% endif %}>Today</option>
                            <option value="week" {% if period == 'week' %}selected{% endif %}>This Week</option>
                            <option value="month" {% if period == 'month' %}selected{% endif %}>This Month</option>
                            <option value="year" {% if period == 'year' %}selected{% endif %}>This Year</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary w-100">Apply Filter</button>
                    </div>
                </form>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="h1 mb-3">{{ total_calls }}</div>
                            <div class="text-muted">Total Calls Made</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="h1 mb-3 text-success">{{ connected_calls }}</div>
                            <div class="text-muted">Connected Calls</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="h1 mb-3 text-danger">{{ not_connected_calls }}</div>
                            <div class="text-muted">Not Connected Calls</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Call Status Breakdown</h3></div>
                        <div class="card-body">
                            <canvas id="callStatusPieChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Call Volume Over Time</h3></div>
                        <div class="card-body">
                            <canvas id="callVolumeBarChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h3 class="card-title">Candidates Called in this Period</h3></div>
                <div class="table-responsive">
                    <table class="table card-table table-vcenter text-nowrap datatable">
                        <thead>
                            <tr>
                                <th>Calling Status</th>
                                <th>Candidate Name</th>
                                <th>Mobile Number</th>
                                <th>Last Called</th>
                                <th>Call Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for candidate in candidates %}
                            <tr>
                                <td>{{ candidate.call_connection }}</td>
                                <td>{{ candidate.candidate_name }}</td>
                                <td>{{ candidate.candidate_mobile_number }}</td>
                                <td>{{ candidate.last_call_timestamp|date:"M d, Y H:i" }}</td>
                                <td>
                                    {% if candidate.call_connection == 'Connected' %}
                                        <span class="badge bg-success me-1"></span> Connected
                                    {% else %}
                                        <span class="badge bg-danger me-1"></span> Not Connected
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <a href="{% url 'employee_candidate_profile' candidate.id %}" class="btn btn-sm btn-outline-primary">View Profile</a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">You have not made any calls in this period.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- 1. Render Pie Chart for Call Status ---
    const pieCtx = document.getElementById('callStatusPieChart').getContext('2d');
    const callStatusPieChart = new Chart(pieCtx, {
        type: 'doughnut',
        data: {
            labels: ['Connected', 'Not Connected'],
            datasets: [{
                label: 'Call Status',
                data: [{{ connected_calls }}, {{ not_connected_calls }}],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.7)',  // Green for Connected
                    'rgba(220, 53, 69, 0.7)'   // Red for Not Connected
                ],
                borderColor: [
                    'rgba(40, 167, 69, 1)',
                    'rgba(220, 53, 69, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    });

    // --- 2. Render Bar Chart for Call Volume ---
    const barCtx = document.getElementById('callVolumeBarChart').getContext('2d');
    const callVolumeBarChart = new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: {{ bar_chart_labels|safe }},
            datasets: [{
                label: 'Calls Made',
                data: {{ bar_chart_data|safe }},
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        // Ensure y-axis only shows whole numbers for call counts
                        precision: 0
                    }
                }
            },
            plugins: {
                legend: {
                    display: false // Hide legend as it's self-explanatory
                }
            }
        }
    });
});
</script>
{% endblock %}