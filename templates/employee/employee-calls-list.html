{% extends 'employee/base.html' %} 

{% block content %}
<div class="page-wrapper">
    <div class="page-header d-print-none">
        <div class="container-xl">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <h2 class="page-title">My Call Performance</h2>
                    <div class="text-muted mt-1">
                        Showing your call data from <strong>{{ start_date|date:"M d, Y" }}</strong> to <strong>{{ end_date|date:"M d, Y" }}</strong>
                    </div>
                </div>
                <div class="col-auto ms-auto d-print-none">
                    <a href="{% url 'employee_performance_dashboard' %}" class="btn btn-primary">
                        Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="page-body">
        <div class="container-xl">
            <div class="card card-body mb-4">
                <form method="get" class="row g-3 align-items-end">
                    <div class="col-md-9">
                        <label class="form-label">Select Period</label>
                        <select name="period" class="form-select">
                            <option value="today" {% if period == 'today' %}selected{% endif %}>Today</option>
                            <option value="week" {% if period == 'week' %}selected{% endif %}>This Week</option>
                            <option value="month" {% if period == 'month' %}selected{% endif %}>This Month</option>
                            <option value="year" {% if period == 'year' %}selected{% endif %}>This Year</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary w-100">Apply Filter</button>
                    </div>
                </form>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="h1 mb-3">{{ total_calls }}</div>
                            <div class="text-muted">Total Activities</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="h1 mb-3 text-success">{{ connected_calls }}</div>
                            <div class="text-muted">Connected Calls</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="h1 mb-3 text-danger">{{ not_connected_calls }}</div>
                            <div class="text-muted">Not Connected Calls</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="h1 mb-3 text-warning">{{ leads_generated }}</div>
                            <div class="text-muted">Leads Generated</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Call Status Breakdown</h3></div>
                        <div class="card-body">
                            <div id="callStatusPieChart"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Activity Volume Trend</h3></div>
                        <div class="card-body">
                            <div id="callVolumeChart"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h3 class="card-title">All Activities in this Period</h3></div>
                <div class="table-responsive">
                    <table class="table card-table table-vcenter text-nowrap datatable">
                        <thead>
                            <tr>
                                <th>Candidate Name</th>
                                <th>Activity Type</th>
                                <th>Activity Time</th>
                                <th>Historical Call Status</th>
                                <th>Historical Lead Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for activity in activities %}
                            <tr>
                                <td>{{ activity.candidate.candidate_name }}</td>
                                <td>
                                    {% if activity.action == 'call_made' %}
                                        <span class="badge bg-blue-lt">Call Made</span>
                                    {% elif activity.action == 'created' %}
                                        <span class="badge bg-green-lt">Created</span>
                                    {% else %}
                                        <span class="badge bg-secondary-lt">{{ activity.get_action_display }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ activity.timestamp|date:"M d, Y H:i" }}</td>
                                <td>
                                    {% with logged_status=activity.changes.call_connection.new %}
                                        {% if activity.action == 'call_made' and logged_status is not None %}
                                            {% if logged_status == 'Connected' %}
                                                <span class="badge bg-success me-1"></span> Connected
                                            {% else %}
                                                <span class="badge bg-danger me-1"></span> {{ logged_status }}
                                            {% endif %}
                                        {% else %}
                                            {% if activity.candidate.call_connection == 'Connected' %}
                                                <span class="badge bg-success me-1"></span> Connected
                                            {% else %}
                                                <span class="badge bg-danger me-1"></span> {{ activity.candidate.call_connection|default:'Not Connected' }}
                                            {% endif %}
                                        {% endif %}
                                    {% endwith %}
                                </td>
                                <td>
                                    {% with lead_status=activity.changes.lead_generate.new %}
                                        {% if activity.action == 'call_made' and lead_status is not None %}
                                            {# Show the status from the historical log #}
                                            {% if lead_status == 'Hot' or lead_status == 'Converted' %}
                                                <span class="badge bg-warning-lt">{{ lead_status }}</span>
                                            {% else %}
                                                {{ lead_status|default:'-' }}
                                            {% endif %}
                                        {% else %}
                                            {# For 'created' events, show the candidate's current status #}
                                            {{ activity.candidate.lead_generate|default:'-' }}
                                        {% endif %}
                                    {% endwith %}
                                </td>
                                <td class="text-end">
                                    <a href="{% url 'employee_candidate_profile' activity.candidate.id %}" class="btn btn-sm btn-outline-primary">View Profile</a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center">You have no activities in this period.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- Render Pie Chart ---
    var pieOptions = {
        chart: { type: 'donut', height: 300 },
        series: [{{ connected_calls }}, {{ not_connected_calls }}],
        labels: ['Connected', 'Not Connected'],
        colors: ['#28a745', '#dc3545'],
        legend: { position: 'bottom' }
    };
    var pieChart = new ApexCharts(document.querySelector("#callStatusPieChart"), pieOptions);
    pieChart.render();

    // --- Render Area Chart ---
    var areaOptions = {
        chart: { type: 'area', height: 300, zoom: { enabled: false }, toolbar: { show: false } },
        series: [{ name: 'Activities', data: {{ chart_data|safe }} }],
        labels: {{ chart_labels|safe }},
        xaxis: { type: 'category' },
        yaxis: { min: 0, tickAmount: 4, labels: { formatter: (val) => val.toFixed(0) } },
        dataLabels: { enabled: false },
        stroke: { curve: 'smooth', width: 2 },
        fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.2, stops: [0, 90, 100] } },
        tooltip: { theme: 'dark' }
    };
    var areaChart = new ApexCharts(document.querySelector("#callVolumeChart"), areaOptions);
    areaChart.render();
});
</script>
{% endblock %}