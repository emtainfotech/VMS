{% extends 'employee/base.html' %} 

{% block content %}
<style>
    /* Style for the clickable cards to give user feedback on hover */
    .clickable-card .card:hover {
        border-color: #206bc4;
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15);
        cursor: pointer;
        transform: translateY(-2px);
        transition: all .2s ease-in-out;
    }
</style>

<div class="page-wrapper">
    <div class="page-header d-print-none">
        <div class="container-xl">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <h2 class="page-title">My Performance Report</h2>
                    <div class="text-muted mt-1">
                        Showing your activity from <strong>{{ start_date|date:"M d, Y" }}</strong> to <strong>{{ end_date|date:"M d, Y" }}</strong>
                    </div>
                </div>
                <div class="col-auto ms-auto d-print-none">
                    <a href="{% url 'employee_performance_dashboard' %}" class="btn btn-primary">
                        Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="page-body">
        <div class="container-xl">
            <div class="card card-body mb-4">
                <form method="get" class="row g-3 align-items-end">
                    <div class="col-md-9">
                        <label class="form-label">Select Period</label>
                        <select name="period" class="form-select" onchange="this.form.submit()">
                            <option value="today" {% if period == 'today' %}selected{% endif %}>Today</option>
                            <option value="week" {% if period == 'week' %}selected{% endif %}>This Week</option>
                            <option value="month" {% if period == 'month' %}selected{% endif %}>This Month</option>
                            <option value="year" {% if period == 'year' %}selected{% endif %}>This Year</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary w-100 d-none d-md-block">Apply Filter</button>
                    </div>
                </form>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-md-6 col-lg-3 clickable-card" data-filter-type="total">
                    <div class="card"><div class="card-body text-center"><div class="h1 mb-3">{{ total_calls }}</div><div class="text-muted">Total Activities</div></div></div>
                </div>
                <div class="col-md-6 col-lg-3 clickable-card" data-filter-type="connected">
                    <div class="card"><div class="card-body text-center"><div class="h1 mb-3 text-success">{{ connected_calls }}</div><div class="text-muted">Connected Calls</div></div></div>
                </div>
                <div class="col-md-6 col-lg-3 clickable-card" data-filter-type="not_connected">
                    <div class="card"><div class="card-body text-center"><div class="h1 mb-3 text-danger">{{ not_connected_calls }}</div><div class="text-muted">Not Connected Calls</div></div></div>
                </div>
                <div class="col-md-6 col-lg-3 clickable-card" data-filter-type="leads">
                    <div class="card"><div class="card-body text-center"><div class="h1 mb-3 text-warning">{{ leads_generated }}</div><div class="text-muted">Leads Generated</div></div></div>
                </div>
            </div>

            <div id="activity-details-container" class="mb-4"></div>

            <div class="row g-4 mb-4">
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Call Status Breakdown</h3></div>
                        <div class="card-body">
                            <div id="callStatusPieChart"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="row g-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header"><h3 class="card-title">Activity Volume Trend</h3></div>
                                <div class="card-body">
                                    <div id="activityVolumeChart"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header"><h3 class="card-title">Lead Generation Trend</h3></div>
                                <div class="card-body">
                                    <div id="leadGenerationChart"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h3 class="card-title">All Activities in this Period</h3></div>
                <div class="table-responsive">
                    <table class="table card-table table-vcenter text-nowrap datatable">
                        <thead>
                            <tr>
                                <th>Candidate Name</th>
                                <th>Activity Type</th>
                                <th>Activity Time</th>
                                <th>Historical Call Status</th>
                                <th>Historical Lead Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for activity in activities %}
                            <tr>
                                <td>{{ activity.candidate.candidate_name }}</td>
                                <td>
                                    {% if activity.action == 'call_made' %}
                                        <span class="badge bg-blue-lt">Call Made</span>
                                    {% elif activity.action == 'created' %}
                                        <span class="badge bg-green-lt">Created</span>
                                    {% else %}
                                        <span class="badge bg-secondary-lt">{{ activity.get_action_display }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ activity.timestamp|date:"M d, Y H:i" }}</td>
                                <td>
                                    {% with logged_status=activity.changes.call_connection.new %}
                                        {% if activity.action == 'call_made' and logged_status is not None %}
                                            {% if logged_status == 'Connected' %}
                                                <span class="badge bg-success me-1"></span> Connected
                                            {% else %}
                                                <span class="badge bg-danger me-1"></span> {{ logged_status }}
                                            {% endif %}
                                        {% else %}
                                            {% if activity.candidate.call_connection == 'Connected' %}
                                                <span class="badge bg-success me-1"></span> Connected
                                            {% else %}
                                                <span class="badge bg-danger me-1"></span> {{ activity.candidate.call_connection|default:'Not Connected' }}
                                            {% endif %}
                                        {% endif %}
                                    {% endwith %}
                                </td>
                                <td>
                                    {% with lead_status=activity.changes.lead_generate.new %}
                                        {% if activity.action == 'call_made' and lead_status is not None %}
                                            {% if lead_status == 'Hot' or lead_status == 'Converted' %}
                                                <span class="badge bg-warning-lt">{{ lead_status }}</span>
                                            {% else %}
                                                {{ lead_status|default:'-' }}
                                            {% endif %}
                                        {% else %}
                                            {{ activity.candidate.lead_generate|default:'-' }}
                                        {% endif %}
                                    {% endwith %}
                                </td>
                                <td class="text-end">
                                    <a href="{% url 'employee_candidate_profile' activity.candidate.id %}" class="btn btn-sm btn-outline-primary">View Profile</a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center">You have no activities in this period.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    
    function getBaseChartOptions(labels, seriesData, chartTitle, colors) {
        return {
            chart: { type: 'area', height: 175, zoom: { enabled: false }, toolbar: { show: false } },
            colors: colors,
            series: [{ name: chartTitle, data: seriesData }],
            labels: labels,
            xaxis: { type: 'category', labels: { style: { fontSize: '10px' } }, tooltip: { enabled: false } },
            yaxis: { min: 0, tickAmount: 3, labels: { formatter: (val) => val.toFixed(0) } },
            dataLabels: { enabled: false },
            stroke: { curve: 'smooth', width: 2 },
            fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.2, stops: [0, 90, 100] } },
            tooltip: { theme: 'dark' }
        };
    }

    // --- 1. Render Pie Chart ---
    var pieOptions = {
        chart: { type: 'donut', height: 400 },
        series: [{{ connected_calls }}, {{ not_connected_calls }}],
        labels: ['Connected', 'Not Connected'],
        colors: ['#28a745', '#dc3545'],
        legend: { position: 'bottom' }
    };
    var pieChart = new ApexCharts(document.querySelector("#callStatusPieChart"), pieOptions);
    pieChart.render();

    // --- 2. Render Trend Charts ---
    const activityChart = new ApexCharts(
        document.querySelector("#activityVolumeChart"), 
        getBaseChartOptions({{ activity_chart_labels|safe }}, {{ activity_chart_data|safe }}, 'Activities', ['#206bc4'])
    );
    activityChart.render();

    const leadGenerationChart = new ApexCharts(
        document.querySelector("#leadGenerationChart"), 
        getBaseChartOptions({{ leads_chart_labels|safe }}, {{ leads_chart_data|safe }}, 'Leads Generated', ['#f59f00'])
    );
    leadGenerationChart.render();

    // --- 3. Handle Clickable Summary Cards ---
    const detailsContainer = document.getElementById('activity-details-container');
    
    document.querySelectorAll('.clickable-card').forEach(card => {
        card.addEventListener('click', async function() {
            const filterType = this.dataset.filterType;
            
            detailsContainer.innerHTML = '<div class="card card-body text-center">Loading details...</div>';

            const startDate = "{{ start_date|date:'Y-m-d' }}";
            const endDate = "{{ end_date|date:'Y-m-d' }}";
            const url = `{% url 'get_employee_filtered_activity_list' %}?list_type=${filterType}&start_date=${startDate}&end_date=${endDate}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                const html = await response.text();
                detailsContainer.innerHTML = html;
                window.scrollTo({ top: detailsContainer.offsetTop - 80, behavior: 'smooth' });
            } catch (error) {
                console.error('Failed to fetch details:', error);
                detailsContainer.innerHTML = '<div class="card card-body text-center text-danger">Failed to load details.</div>';
            }
        });
    });

    // Event listener for the close button on the dynamically loaded table
    document.addEventListener('click', function(event) {
        if (event.target && event.target.id === 'close-details-table') {
            detailsContainer.innerHTML = '';
        }
    });
});
</script>
{% endblock %}