{% extends 'employee/base.html' %} 

{% block content %}
<div class="page-wrapper">
    <div class="page-header d-print-none">
        <div class="container-xl">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <h2 class="page-title">My Call Performance</h2>
                    <div class="text-muted mt-1">
                        Showing your call data from <strong>{{ start_date|date:"M d, Y" }}</strong> to <strong>{{ end_date|date:"M d, Y" }}</strong>
                    </div>
                </div>
                <div class="col-auto ms-auto d-print-none">
                    <a href="{% url 'employee_performance_dashboard' %}" class="btn btn-primary">
                        Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="page-body">
        <div class="container-xl">
            <div class="card card-body mb-4">
                <form method="get" class="row g-3 align-items-end">
                    <div class="col-md-9">
                        <label class="form-label">Select Period</label>
                        <select name="period" class="form-select">
                            <option value="today" {% if period == 'today' %}selected{% endif %}>Today</option>
                            <option value="week" {% if period == 'week' %}selected{% endif %}>This Week</option>
                            <option value="month" {% if period == 'month' %}selected{% endif %}>This Month</option>
                            <option value="year" {% if period == 'year' %}selected{% endif %}>This Year</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary w-100">Apply Filter</button>
                    </div>
                </form>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="h1 mb-3">{{ total_calls }}</div>
                            <div class="text-muted">Total Calls Made</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="h1 mb-3 text-success">{{ connected_calls }}</div>
                            <div class="text-muted">Connected Calls</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="h1 mb-3 text-danger">{{ not_connected_calls }}</div>
                            <div class="text-muted">Not Connected Calls</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Call Status Breakdown</h3></div>
                        <div class="card-body">
                            <div id="callStatusPieChart"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Call Volume Trend</h3></div>
                        <div class="card-body">
                            <div id="callVolumeChart"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h3 class="card-title">Candidates Called in this Period</h3></div>
                <div class="table-responsive">
                    <table class="table card-table table-vcenter text-nowrap datatable">
                        <thead>
                            <tr>
                                <th>Candidate Name</th>
                                <th>Mobile Number</th>
                                <th>Last Called On</th>
                                <th>Current Call Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for candidate in candidates %}
                            <tr>
                                <td>{{ candidate.candidate_name }}</td>
                                <td>{{ candidate.candidate_mobile_number }}</td>
                                <td>{{ candidate.last_call_timestamp|date:"M d, Y H:i" }}</td>
                                <td>
                                    {% if candidate.call_connection == 'Connected' %}
                                        <span class="badge bg-success me-1"></span> Connected
                                    {% else %}
                                        <span class="badge bg-danger me-1"></span> {{ candidate.call_connection|default:'Not Connected' }}
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <a href="{% url 'employee_candidate_profile' candidate.id %}" class="btn btn-sm btn-outline-primary">View Profile</a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">You have not made any calls in this period.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- Render Pie Chart with ApexCharts ---
    var pieOptions = {
        chart: {
            type: 'donut',
            height: 300
        },
        series: [{{ connected_calls }}, {{ not_connected_calls }}],
        labels: ['Connected', 'Not Connected'],
        colors: ['#28a745', '#dc3545'], // Green for Connected, Red for Not Connected
        legend: {
            position: 'bottom'
        }
    };

    var pieChart = new ApexCharts(document.querySelector("#callStatusPieChart"), pieOptions);
    pieChart.render();

    // --- Render Area Chart with ApexCharts ---
    var areaOptions = {
        chart: {
            type: 'area', // Area chart gives a nice modern feel
            height: 300,
            zoom: {
                enabled: false // Disable zooming for a cleaner look
            },
            toolbar: {
                show: false // Hide the download/zoom menu
            }
        },
        series: [{
            name: 'Calls Made',
            data: {{ chart_data|safe }}
        }],
        labels: {{ chart_labels|safe }},
        xaxis: {
            type: 'category'
        },
        yaxis: {
            min: 0,
            tickAmount: 5, // Controls how many lines on the y-axis
            labels: {
                formatter: function (val) {
                    return val.toFixed(0); // Ensure whole numbers
                }
            }
        },
        dataLabels: {
            enabled: false // Hide the numbers on the data points
        },
        stroke: {
            curve: 'smooth', // Creates the smooth, curved line
            width: 2
        },
        fill: {
            type: 'gradient',
            gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.7,
                opacityTo: 0.2,
                stops: [0, 90, 100]
            }
        },
        tooltip: {
            theme: 'dark'
        }
    };

    var areaChart = new ApexCharts(document.querySelector("#callVolumeChart"), areaOptions);
    areaChart.render();
});
</script>
{% endblock %}