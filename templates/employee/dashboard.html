{% extends 'employee/base.html' %}

{% block content %}
<div class="page-wrapper">
  <!-- Page header -->
  <div class="page-header d-print-none">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <!-- Page pre-title -->

          <div class="page-pretitle">Overview</div>
          <h2 class="page-title d-flex justify-content-between" style="margin-bottom: 50px;">
            Dashboard
            <span id="datetime" style="font-size: 16px; font-weight: normal; margin-left: 20px;"></span>
          </h2>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Function to format date and time
    function getCurrentDateTime() {
      const now = new Date();
      const options = {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: true
      };
      return now.toLocaleString('en-US', options);
    }
  
    // Insert date and time into the span
    document.getElementById("datetime").innerText = getCurrentDateTime();
    
  
    // Optional: update every second
    setInterval(() => {
      document.getElementById("datetime").innerText = getCurrentDateTime();
    }, 1000);
  </script>
  
  <!-- Page body -->
  <div class="page-body">
    <div class="container-xl">
      <div class="row row-deck row-cards">
          
          {% comment %} personal details  {% endcomment %}

          <div class="col-md-6 col-lg-4">
            <div class="card ">
              <div class="card-body">
                <div class="card-header bg-dark">
                  <div class="d-flex align-items-center">
                    <span >
                      <img src="{{user.employee.employee_photo.url}}" class="avatar avatar-lg avatar-rounded border border-white border-2 flex-shrink-0 me-2" alt="Img">
                    </span>
                    <div>
                      <h3 class="text-white mb-1">{{user.employee.first_name}} {{user.employee.last_name}}</h3>
                      <div class="d-flex align-items-center">
                        <p class="text-white mb-0 fs-7">{{user.employee.designation}}</p>
                        <p class="text-white mb-0 fs-7">&nbsp;&nbsp;<span class="badge bg-warning"></span>&nbsp;&nbsp;{{user.employee.department}}</p>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <span class="d-block text-secondary mb-1 fs-13">Phone Number</span>
                    <h4 class="fw-semibold  mb-1">{{user.employee.contact_number}}</h4>
                  </div>
                  <div class="mb-3">
                    <span class="d-block text-secondary mb-1 fs-13">Email Address</span>
                    <h4 class="fw-semibold  mb-1">{{user.employee.email}}</h4>
                  </div>
                  <div class="mb-3">
                    <span class="d-block text-secondary mb-1 fs-13">Report Office</span>
                    <h4 class="fw-semibold  mb-1">{{additional_info.reporting_to}}</h4>
                  </div>
                  <div>
                    <span class="d-block text-secondary mb-1 fs-13">Joined on</span>
                    <h4 class="fw-semibold  mb-1">{{user.employee.joining_date}}</h4>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {% comment %} Attendance Details {% endcomment %}

          <div class="col-md-6 col-lg-4">
            <div class="card">
              <div class="card-status-top bg-green"></div>
              <div class="card-header">
                <h3 class="card-title">Attendance Details</h3>
              </div>
              <div class="card">
                <div class="card-body">
                  <div id="chart-demo-pie"></div>
                </div>
              </div>
            </div>
          </div>

          {% comment %} Leave details  {% endcomment %}

          <div class="col-md-6 col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Leave Details</h3>
                </div>
                <div class="card-body">
                    <div class="row align-items-center" id="attendance-details">
                        <!-- Data will be inserted here dynamically -->
                    </div>
                    <div class="col-sm-12">
                        <div>
                            <a href="{% url 'employee_leave_request_view' %}" class="btn btn-dark w-100" >Apply New Leave</a>
                        </div>
                      </div>
                  </div>
              </div>
          </div>
        
          <script>
              document.addEventListener("DOMContentLoaded", function () {
                  fetch("{% url "employee_attendance_details" %}") // Update with actual URL
                      .then(response => response.json())
                      .then(data => {
                          let detailsContainer = document.getElementById("attendance-details");
                          let labels = {
                              "Total Leaves": "Total Leaves",
                              "Taken": "Taken",
                              "Absent": "Absent",
                              "Request": "Request",
                              "Worked Days": "Worked Days",
                              "Loss of Pay": "Loss of Pay"
                          };
                          
                          Object.keys(data).forEach(key => {
                              let value = data[key];
                              let col = document.createElement("div");
                              col.className = "col-sm-6 mb-4";
                              col.innerHTML = `
                                  <span class="d-block mb-1">${labels[key]}</span>
                                  <h4>${value}</h4>
                              `;
                              detailsContainer.appendChild(col);
                          });
                      })
                      .catch(error => console.error("Error loading attendance details:", error));
              });
          </script>
        
          {% comment %} Punch In and Punch Out {% endcomment %}

          <div class="col-xl-4 d-flex">
            <div class="card flex-fill border border-warning rounded-3 shadow-sm attendance-bg">
              <div class="card-body">
                <!-- Attendance Title and Date -->
                <div class="mb-4 text-center">
                  <h4 class="fw-semibold  mb-1">Attendance</h4>
                  <h4 class="">{{ now }}</h4>
                </div>
          
                <!-- Circle Progress -->
                <div class="position-relative mx-auto mb-3" style="width: 120px; height: 120px;">
                  <div class="circle-progress position-absolute top-0 start-0 end-0 bottom-0 border border-success rounded-circle d-flex align-items-center justify-content-center">
                    <div class="progress-content text-center">
                      {% if session and not session.punch_out_time %}
                      <h5 class="mb-0" id="totalLoginTime">{{ total_punch_in_time_formatted }}</h5>
                      {% else %}
                      <h5 class="mb-0">{{ total_punch_in_time_formatted }}</h5>
                      {% endif %}
                    </div>
                  </div>
                </div>
          
                <!-- Production Hours -->
                <div class="text-center">
                  <!-- Punch In or Punch Out -->
                  <h4 class="fw-medium d-flex align-items-center justify-content-center mb-4">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-fingerprint">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M18.9 7a8 8 0 0 1 1.1 5v1a6 6 0 0 0 .8 3" />
                          <path d="M8 11a4 4 0 0 1 8 0v1a10 10 0 0 0 2 6" />
                          <path d="M12 11v2a14 14 0 0 0 2.5 8" />
                          <path d="M8 15a18 18 0 0 0 1.8 6" />
                          <path d="M4.9 19a22 22 0 0 1 -.9 -7v-1a8 8 0 0 1 12 -6.95" />
                      </svg>
                      &nbsp; Punch In at {{ first_punch_in_time }}
                  </h4>
              
                  {% if session and not session.punch_out_time %}
                  <!-- Show Punch Out button if punched in -->
                  <form id="punchOutForm" method="post" action="{% url 'punch_out' %}">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-warning w-100 text-white">Punch Out</button>
                  </form>
                  {% else %}
                  <!-- Show Punch In button if not punched in -->
                  <form id="punchInForm" method="post" action="{% url 'punch_in' %}">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-warning w-100 text-white">Punch In</button>
                  </form>
                  {% endif %}
              </div>
              
              <div class="modal modal-blur fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" role="dialog" aria-hidden="true">
                <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
                  <div class="modal-content">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    <div class="modal-status bg-success"></div>
                    <div class="modal-body text-center py-4">
                      <!-- Download SVG icon from http://tabler-icons.io/i/circle-check -->
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon mb-2 text-green icon-lg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /><path d="M9 12l2 2l4 -4" /></svg>
                      <div class="modal-body" id="modalMessage">
                        <!-- Message will be injected here -->
                    </div>
                      {% comment %} <div class="text-secondary">Your payment of $290 has been successfully submitted. Your invoice has been sent to support@tabler.io.</div> {% endcomment %}
                    </div>
                  </div>
                </div>
              </div>

              {% comment %} <!-- Bootstrap Modal -->
              <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                      <div class="modal-content">
                          <div class="modal-header bg-success text-white">
                              <h5 class="modal-title" id="successModalLabel">Success</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body" id="modalMessage">
                              <!-- Message will be injected here -->
                          </div>
                          <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                          </div>
                      </div>
                  </div>
              </div> {% endcomment %}
              
              </div>
            </div>
          </div>
                  
          <style>
            
                
              .circle-progress {
                width: 120px;
                height: 120px;
                border: 6px solid #e6e6e6;
                border-top-color: #28a745; /* Green color for progress */
                border-radius: 50%;
                position: relative;
                {% comment %} animation: rotate-circle 1s linear infinite; {% endcomment %}
              }

              @keyframes rotate-circle {
                0% {
                  transform: rotate(0deg);
                }
                100% {
                  transform: rotate(360deg);
                }
              }

              .progress-content {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
              }
              .btn-warning {
                background-color: #ff6600;
                border: none;
              }

              .btn-warning:hover {
                background-color: #e65c00;
              }

          </style>    

          {% comment %} Time Calculation {% endcomment %}

          <style>
              .work-hours {
                display: flex;
                align-items: center;
                font-size: 1.5rem;
                font-weight: bold;
            }
            
            .work-hours h2 {
                margin-bottom: 0;
                margin-right: 5px;
            }
            
            .work-hours span {
                font-size: 1.2rem;
                color: #555;
            }
          </style>

          <div class="col-xl-8 d-flex">
            <div class="row flex-fill">
                <div class="col-xl-3 col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <div class="">
                                <span class="avatar avatar-sm bg-orange mb-2"><svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="1"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-clock-24"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12a9 9 0 0 0 5.998 8.485m12.002 -8.485a9 9 0 1 0 -18 0" /><path d="M12 7v5" /><path d="M12 15h2a1 1 0 0 1 1 1v1a1 1 0 0 1 -1 1h-1a1 1 0 0 0 -1 1v1a1 1 0 0 0 1 1h2" /><path d="M18 15v2a1 1 0 0 0 1 1h1" /><path d="M21 15v6" /></svg></span>
                                <div class="work-hours">
                                  <h2 class="mb-2" id="total_hours_today">0</h2>
                                  <p style="font-weight: 200;">/</p>
                                  <span class="fs-20 text-gray-5"> 9</span>
                                </div>
                                <p class="fw-medium text-truncate">Total Hours Today</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <div class="">
                                <span class="avatar avatar-sm bg-green mb-2"><svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-calendar-week"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z" /><path d="M16 3v4" /><path d="M8 3v4" /><path d="M4 11h16" /><path d="M7 14h.013" /><path d="M10.01 14h.005" /><path d="M13.01 14h.005" /><path d="M16.015 14h.005" /><path d="M13.015 17h.005" /><path d="M7.01 17h.005" /><path d="M10.01 17h.005" /></svg></span>
                                <div class="work-hours">
                                  <h2 class="mb-2" id="total_hours_week">0</h2>
                                  <p style="font-weight: 200;">/</p>
                                  <span class="fs-20 text-gray-5">54</span>
                                </div>
                                <p class="fw-medium text-truncate">Total Hours Week</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <div class="">
                                <span class="avatar avatar-sm bg-info mb-2"><svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="currentColor"  class="icon icon-tabler icons-tabler-filled icon-tabler-calendar-month"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 12a1 1 0 0 1 1 1v4a1 1 0 0 1 -2 0v-4a1 1 0 0 1 1 -1" /><path d="M12 12a1 1 0 0 1 1 1v4a1 1 0 0 1 -2 0v-4a1 1 0 0 1 1 -1" /><path d="M16 12a1 1 0 0 1 1 1v4a1 1 0 0 1 -2 0v-4a1 1 0 0 1 1 -1" /><path d="M16 2a1 1 0 0 1 .993 .883l.007 .117v1h1a3 3 0 0 1 2.995 2.824l.005 .176v12a3 3 0 0 1 -2.824 2.995l-.176 .005h-12a3 3 0 0 1 -2.995 -2.824l-.005 -.176v-12a3 3 0 0 1 2.824 -2.995l.176 -.005h1v-1a1 1 0 0 1 1.993 -.117l.007 .117v1h6v-1a1 1 0 0 1 1 -1m3 7h-14v9.625c0 .705 .386 1.286 .883 1.366l.117 .009h12c.513 0 .936 -.53 .993 -1.215l.007 -.16z" /></svg></span>
                                <div class="work-hours">
                                  <h2 class="mb-2" id="total_hours_month">0</h2>
                                  <p style="font-weight: 200;">/</p>
                                  <span class="fs-20 text-gray-5"> 216</span>
                                </div>
                                <p class="fw-medium text-truncate">Total Hours Month</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <div class="">
                                <span class="avatar avatar-sm bg-pink mb-2"><svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-calendar-time"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" /><path d="M18 18m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" /><path d="M15 3v4" /><path d="M7 3v4" /><path d="M3 11h16" /><path d="M18 16.496v1.504l1 1" /></svg></span>
                                <h2 class="mb-2" id="month_overtime">0</h2>
                                <p></p>
                                <p class="fw-medium text-truncate">Overtime this Month</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-xl-3">
                                    <div class="mb-4">
                                        <p class="d-flex align-items-center mb-1"><span class="badge bg-orange badge-blink"></span>&nbsp;Total Working hours</p>
                                        
                                        <h3 id="another_today_total_working_time">0</h3>
                                    </div>
                                </div>
                                <div class="col-xl-3">
                                    <div class="mb-4">
                                        <p class="d-flex align-items-center mb-1"><span class="badge bg-green badge-blink"></span>&nbsp;Productive Hours</p>
                                        <h3 id="today_productive_hours">0</h3>
                                    </div>
                                </div>
                                <div class="col-xl-3">
                                    <div class="mb-4">
                                        <p class="d-flex align-items-center mb-1"><span class="badge bg-yellow badge-blink"></span>&nbsp;Break hours</p>
                                        <h3 id="today_break_hours">0</h3>
                                    </div>
                                </div>
                                <div class="col-xl-3">
                                    <div class="mb-4">
                                        <p class="d-flex align-items-center mb-1"><span class="badge bg-blue badge-blink"></span>&nbsp;Overtime</p>
                                        <h3 id="today_overtime">0</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
          </div>
          
          <script>
            document.addEventListener("DOMContentLoaded", function () {
                fetch("{% url "work_hours_summary" %}")
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById("total_hours_today").innerText = data.total_hours_today;
                        document.getElementById("total_hours_week").innerText = data.total_hours_week;
                        document.getElementById("total_hours_month").innerText = data.total_hours_month;
                        document.getElementById("month_overtime").innerText = data.month_overtime;
                        document.getElementById("today_productive_hours").innerText = data.today_productive_hours;
                        document.getElementById("today_break_hours").innerText = data.today_break_hours;
                        document.getElementById("today_overtime").innerText = data.today_overtime;
                        document.getElementById("another_today_total_working_time").innerText = data.another_today_total_working_time;
                    });
            });
          </script>
            
          {% comment %} Meeting Schedule {% endcomment %}
        
          <div class="col-md-12 col-lg-4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Meeting Schedule</h3>
              </div>
              <div class="card-table table-responsive">
                <table class="table table-vcenter">
                  <thead>
                    <tr>
                      <th>Meeting Title</th>
                      <th>Department</th>
                      <th>Meeting Date</th>
                      <th>Meeting Time</th>
                      <th>Meeting location</th>
                    </tr>
                  </thead>
                  <tr>
                    {% for meeting in meetings %}
                    <td>
                      {{meeting.title}}
                    </td>
                    <td class="text-secondary">{{meeting.department}}</td>
                    <td class="text-secondary">{{meeting.date}}</td>
                    <td class="text-secondary">{{meeting.time}}</td>
                    <td class="text-secondary"> {{meeting.location}}</td>
                    {% endfor %}
                  </tr>
                </table>
              </div>
            </div>
          </div>
          
          {% comment %} Today's Attendance {% endcomment %}

          <div class="col-md-12 col-lg-4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Today's Attendance</h3>
              </div>
              <div class="card-table table-responsive">
                <table class="table table-vcenter table-nowrap text-nowrap table-hover   table-align-middle"> 
                  <thead>
                    <tr>
                      <th>Login Time</th>
                      <th>Logout Time Time</th>
                      <th>Total Time Worked</th>
                      <th>Logout Reason</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for session in sessions %}
                    <tr>
                      <td class="text-secondary">{{ session.punch_in_time }}</td>
                      <td class="text-secondary">{{ session.punch_out_time }}</td>
                      <td class="text-secondary">{{ session.total_time }}</td>
                      <td class="text-secondary">{{ session.punch_out_reason }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          {% comment %} Today Expense {% endcomment %}

          <div class="col-lg-4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Today Expense</h3>
              </div>
              <div class="card-table table-responsive">
                <table class="table table-vcenter">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Reason</th>
                      <th>Ammount</th>
                      <th>Date</th>
                      <th>Attech</th>
                    </tr>
                  </thead>
                  <tr>
                    {% for office_expense in office_expenses %}
                    <td class="text-secondary">{{office_expense.employee_name}}</td>
                    <td class="text-secondary">{{office_expense.item_name}}</td>
                    <td class="text-secondary">{{office_expense.amount}}</td>
                    <td class="text-secondary">{{office_expense.purchase_date}}</td>
                    
                    <td class="text-secondary">{% if office_expense.attech %}
                      <a href="{{ office_expense.attech.url }}" target="_blank">View Attachment</a>
                    {% else %}
                      No Attachment
                    {% endif %}</td>
                  </tr>
                  {% endfor %}
                </table>
              </div>
            </div>
          </div>
          
          {% comment %} Activity {% endcomment %}

          <div class="col-lg-4">
            <div class="card">
              <div class="card-header border-0">
                <div class="card-title">Notification's</div>
              </div>
              <div class="card-table table-responsive">
                <table class="table table-vcenter table-nowrap text-nowrap table-hover">
                  <thead>
                    <tr>
                      <th>No</th>
                      <th>Title</th>
                      <th>Message</th>
                      <th>Time</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for notification in notifications %}
                    <tr>
                      <td class="w-1">
                        <span class="avatar avatar-sm">{{forloop.counter}}</span>
                      </td>
                      <td>
                        <div>{{ notification.notification_type }}</div>
                      </td>
                      <td>
                        <div> {{ notification.message }}</div>
                      </td>
                      <td class="text-nowrap text-secondary">{{ notification.created_at }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          {% comment %} Work Anniversary and Birthday {% endcomment %}
          
          <div class="col-md-4 col-lg-4">
            <div class="card">
              <div id="employee-cards-container" class="row mt-2" style="margin: 5px;">
                <!-- Cards will be dynamically inserted here -->
              </div>
            </div>
          </div>

          {% comment %} Team Members {% endcomment %}

          <div class="col-md-12 col-lg-4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Team Members</h3>
              </div>
              <div class="card-table table-responsive">
                <table class="table table-vcenter table-nowrap text-nowrap table-hover table-align-middle">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Email</th>
                      <th>Designation</th>
                    </tr>
                  </thead>
                  <tbody id="employee-table-body">
                    <!-- Rows will be populated dynamically -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <script>
            document.addEventListener("DOMContentLoaded", function() {
              fetch("{% url "same_designation_list_json" %}")
                .then(response => response.json())
                .then(data => {
                  if (data.employees) {
                    const tableBody = document.getElementById("employee-table-body");
                    data.employees.forEach(emp => {
                      const row = `
                        <tr>
                          <td>${emp.name}</td>
                          <td>${emp.email || 'N/A'}</td>
                          <td>${emp.designation}</td>
                        </tr>
                      `;
                      tableBody.innerHTML += row;
                    });
                  } else {
                    console.error("No employees found or an error occurred.");
                  }
                })
                .catch(error => console.error("Error fetching employee data:", error));
            });
          </script>
          
          {% comment %} To-Do List {% endcomment %}

          <div class="col-md-12 col-lg-4">
            <div class="card">
              <div class="card-header border-0 display-flex align-items-center justify-content-between">
                <h3 class="card-title">To-Do List</h3>
                {% comment %} <input type="text" id="newTask" class="form-control my-2" placeholder="Add a new task">{% endcomment %}
                <button data-bs-toggle="modal" data-bs-target="#modal-to-do" class="btn btn-primary btn-pill sm">Add Task</button> 
              </div>
              <div class="table-responsive">
                <table class="table card-table table-vcenter" id="taskTable">
                  <tbody>
                    <!-- Tasks will be dynamically added here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
      
          <script>
            document.addEventListener("DOMContentLoaded", function() {
              const taskTableBody = document.querySelector("#taskTable tbody");
              const newTaskInput = document.getElementById("newTask");
              const addTaskButton = document.getElementById("addTask");
        
              // Load tasks from localStorage
              function loadTasks() {
                const tasks = JSON.parse(localStorage.getItem("tasks")) || [];
                tasks.forEach(task => {
                  addTaskToDOM(task.text, task.completed);
                });
              }
        
              // Add a task to the DOM
              function addTaskToDOM(taskText, isCompleted = false) {
                const row = document.createElement("tr");
                row.innerHTML = `
                  <td class="w-1 pe-0">
                    <input type="checkbox" class="form-check-input m-0 align-middle" ${isCompleted ? "checked" : ""}>
                  </td>
                  <td class="w-100 ${isCompleted ? "text-decoration-line-through" : ""}">
                    <span class="text-reset">${taskText}</span>
                  </td>
                  <td>
                    <button class="btn btn-danger btn-pill btn-sm remove-task">Remove</button>
                  </td>
                `;
        
                // Add event listeners for checkbox and remove button
                row.querySelector("input[type='checkbox']").addEventListener("change", function() {
                  toggleTaskCompletion(taskText);
                });
                row.querySelector(".remove-task").addEventListener("click", function() {
                  removeTask(taskText);
                  row.remove();
                });
        
                taskTableBody.appendChild(row);
              }
        
              // Save tasks to localStorage
              function saveTasks() {
                const tasks = [];
                taskTableBody.querySelectorAll("tr").forEach(row => {
                  const taskText = row.querySelector("span").textContent;
                  const isCompleted = row.querySelector("input[type='checkbox']").checked;
                  tasks.push({ text: taskText, completed: isCompleted });
                });
                localStorage.setItem("tasks", JSON.stringify(tasks));
              }
        
              // Add a new task
              addTaskButton.addEventListener("click", function() {
                const taskText = newTaskInput.value.trim();
                if (taskText) {
                  addTaskToDOM(taskText);
                  saveTasks();
                  newTaskInput.value = "";
                }
              });
        
              // Toggle task completion
              function toggleTaskCompletion(taskText) {
                const taskRows = taskTableBody.querySelectorAll("tr");
                taskRows.forEach(row => {
                  const span = row.querySelector("span");
                  if (span.textContent === taskText) {
                    const isCompleted = row.querySelector("input[type='checkbox']").checked;
                    span.classList.toggle("text-decoration-line-through", isCompleted);
                  }
                });
                saveTasks();
              }
        
              // Remove a task
              function removeTask(taskText) {
                const tasks = JSON.parse(localStorage.getItem("tasks")) || [];
                const updatedTasks = tasks.filter(task => task.text !== taskText);
                localStorage.setItem("tasks", JSON.stringify(updatedTasks));
              }
        
              // Initial load
              loadTasks();
            });
          </script>

          {% comment %} Tasks Assigned {% endcomment %}

          <div class="col-md-12 col-lg-4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Tasks Assigned</h3>
              </div>
              <div class="table-responsive">
                <table class="table card-table table-vcenter">
                  
                  <thead>
                    <tr>
                      <th>No</th>
                      <th>Title</th>
                      <th>Description</th>
                      <th>Priority</th>
                      <th>Due Date</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for task in tasks %}
                  <tr>
                    <td >
                      {{forloop.counter}}
                    </td>
                    <td class="w-10">
                      {{task.title}}
                    </td>
                    <td class="text-nowrap text-secondary">{{task.description}}
                    </td>
                    <td class="text-nowrap">
                        </svg>{{task.priority}}
                    </td>
                    <td class="text-nowrap">{{task.due_date}}
                    </td>
                    <td>
                      <form method="post" action="{% url 'update_task_status' task.id %}">
                        {% csrf_token %}
                        <select class="form-select" name="status" onchange="this.form.submit()" style="width: auto;">
                          <option value="Pending" {% if task.status == 'Pending' %}selected{% endif %}>Pending</option>
                          <option value="In Progress" {% if task.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                          <option value="Completed" {% if task.status == 'Completed' %}selected{% endif %}>Completed</option>
                        </select>
                      </form>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  
  
<!-- PunchOut Reason Modal -->
<div class="modal modal-blur fade" id="modal-report" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Punch Out Reason</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="logout-form" method="POST" action="{% url 'punch_out' %}">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Reason</label>
            <select class="form-control" name="punch_out_reason" required>
              <option value="Lunch Break">Lunch Break</option>
              <option value="Short Break">Short Break</option>
              <option value="Meeting Break">In Meeting</option>
              <option value="Shift Finished">Shift Finished</option>
              <option value="Personal Reasons">Personal Reasons</option>
              <option value="Medical Leave">Medical Leave</option>
              <option value="On Call">On Call</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <a href="#" class="btn btn-link link-secondary" data-bs-dismiss="modal">Cancel</a>
          <button type="submit" class="btn btn-primary ms-auto">Punch Out</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- To-Do list Modal -->
<div class="modal modal-blur fade" id="modal-to-do" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Add Task</label>
      <input type="text" id="newTask" class="form-control" placeholder="Add a new task">
        </div>
      </div>
        <div class="modal-footer">
          <a href="#" class="btn btn-link link-secondary" data-bs-dismiss="modal">Cancel</a>
          <button type="submit" id="addTask" class="btn btn-primary ms-auto">Add Task</button>
        </div>
    </div>
  </div>
</div>

{% comment %} Punch In & Out Script {% endcomment %}

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("logout-form");

    form.addEventListener("submit", function (e) {
      e.preventDefault(); // Prevent the default form submission

      const formData = new FormData(form);
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      fetch("{% url 'punch_out' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.message) {
          alert(data.message); // Optionally display a success message
          document.querySelector("#modal-report").classList.remove("show"); // Close the modal
          document.querySelector(".modal-backdrop").remove(); // Remove backdrop
          location.reload();
          // Optionally update page elements like logout time
          if (data.punch_out_time) {
            document.querySelector("#logout-time-display").textContent = "Logout Time: " + data.punch_out_time;
          }
        } else if (data.error) {
          alert(data.error); // Handle error
        }
      })
      .catch(error => console.error("Error:", error));
    });
  });
</script>

{% comment %} Birthdays and Anniversaries {% endcomment %}

<script>
  document.addEventListener("DOMContentLoaded", function () {
    fetch("{% url 'birthdays_anniversaries' %}") // Replace with the actual URL
        .then((response) => response.json())
        .then((data) => {
            const container = document.getElementById("employee-cards-container");
            const parentContainer = container.closest(".col-md-4.col-lg-4"); // Get the parent div

            // Clear previous content
            container.innerHTML = "";

            let hasData = false; // Flag to check if there are any birthdays or anniversaries

            data.birthdays_today.forEach((employee) => {
                hasData = true;
                container.innerHTML += `
                    <div class="col-lg-12">
                      <div class="card">
                        <div class="ribbon bg-red">Birthday</div>
                        <div class="row row-0">
                          <div class="col-3">
                            <img src="${employee.photo_url}" class="w-100 h-100 object-cover card-img-start" alt="${employee.name}">
                          </div>
                          <div class="col">
                            <div class="card-body">
                              <h3 class="card-title">${employee.name}</h3>
                              <p class="text-secondary">Designation: ${employee.designation}</p>
                              <p class="text-secondary">Birthday: ${employee.date_of_birth}</p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                `;
            });

            data.anniversaries_today.forEach((employee) => {
                hasData = true;
                container.innerHTML += `
                    <div class="col-lg-12 mt-2">
                      <div class="card">
                        <div class="ribbon bg-red">Work Anniversary</div>
                        <div class="row row-0">
                          <div class="col-3">
                            <img src="${employee.photo_url}" class="w-100 h-100 object-cover card-img-start" alt="${employee.name}">
                          </div>
                          <div class="col">
                            <div class="card-body">
                              <h3 class="card-title">${employee.name}</h3>
                              <p class="text-secondary">Designation: ${employee.designation}</p>
                              <p class="text-secondary">Work Anniversary: ${employee.joining_date}</p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                `;
            });

            // Show or hide the parent container based on data availability
            if (hasData) {
                parentContainer.style.display = "block";
            } else {
                parentContainer.style.display = "none";
            }
        })
        .catch(error => console.error("Error fetching data:", error));
});
</script>

{% comment %} Attendence Timer  {% endcomment %}

<script>
  function parseTimeString(timeStr) {
      // Extract hours, minutes, and seconds using regex
      const match = timeStr.match(/(\d+)h\s*(\d+)m\s*(\d+)s/);
      if (!match) return 0;
      const [, hours, minutes, seconds] = match.map(Number);
      return hours * 3600 + minutes * 60 + seconds;
  }

  function formatTime(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return `${h}h ${m}m ${s}s`;
  }

  function startTimer(initialTime) {
      let totalSeconds = parseTimeString(initialTime);
      const displayElement = document.getElementById("totalLoginTime");

      function updateTime() {
          totalSeconds++;
          displayElement.textContent = formatTime(totalSeconds);
      }

      setInterval(updateTime, 1000);
  }

  document.addEventListener("DOMContentLoaded", function () {
      const initialTime = document.getElementById("totalLoginTime").textContent.trim();
      startTimer(initialTime);
  });
</script>

{% comment %} Punch In Error Handling {% endcomment %}

<script>
 // Function to show modal with message
function showModal(message) {
  document.getElementById('modalMessage').textContent = message;
  let modal = new bootstrap.Modal(document.getElementById('successModal'));
  modal.show();
}

// Handle Punch In form submission
document.getElementById('punchInForm')?.addEventListener('submit', function(e) {
  e.preventDefault();
  fetch(this.action, {
      method: 'POST',
      headers: {
          'X-CSRFToken': '{{ csrf_token }}'
      }
  })
  .then(response => response.json())
  .then(data => {
      if (data.message) {
          showModal(data.message);  // Show success modal
          setTimeout(() => location.reload(), 5000);  // Reload after 2 sec
      } else {
          showModal('Punch In failed');
      }
  })
  .catch(error => console.error('Error:', error));
});

// Handle Punch Out form submission
document.getElementById('punchOutForm')?.addEventListener('submit', function(e) {
  e.preventDefault();
  fetch(this.action, {
      method: 'POST',
      headers: {
          'X-CSRFToken': '{{ csrf_token }}'
      }
  })
  .then(response => response.json())
  .then(data => {
      if (data.message) {
          showModal(data.message);  // Show success modal
          setTimeout(() => location.reload(), 2000);  // Reload after 2 sec
      } else {
          showModal('Punch Out failed');
      }
  })
  .catch(error => console.error('Error:', error));
});

</script>

{% comment %} Leave Details {% endcomment %}

<script>
  document.addEventListener("DOMContentLoaded", function () {
    fetch("{% url "employee_leave_details" %}")
      .then(response => response.json())
      .then(data => {
        window.ApexCharts && (new ApexCharts(document.getElementById('chart-demo-pie'), {
          chart: {
            type: "donut",
            fontFamily: 'inherit',
            height: 240,
            animations: {
              enabled: true
            },
          },
          series: data.series,
          labels: data.labels,
          colors: [
            tabler.getColor("green"),
            tabler.getColor("orange"),
            tabler.getColor("red"),
            tabler.getColor("primary"),
            tabler.getColor("yellow"),
          ],
          legend: {
            show: true,
            position: 'bottom',
          },
          tooltip: {
            theme: 'dark'
          },
        })).render();
      })
      .catch(error => console.error("Error loading attendance data:", error));
  });
</script>


{% endblock %}


