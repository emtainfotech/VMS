{% extends 'employee/performance-base.html' %}

{% block content %}
<div class="page-wrapper">
    <div class="page-header d-print-none">
        <div class="container-xl">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <h2 class="page-title">Candidate Management</h2>
                    <div class="text-muted mt-1">
                        <span id="total-candidates-display">{{ page_obj.paginator.count }}</span> candidates found
                    </div>
                </div>
                <div class="col-auto ms-auto d-print-none">
                    <div class="btn-list">
                        <a href="{% url 'employee_candidate_registration' %}" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M12 5l0 14" /><path d="M5 12l14 0" /></svg>
                            Add New Candidate
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="page-body">
        <div class="container-xl">
            <div class="card">
                <div class="card-header">
                    <div class="row align-items-center g-2">
                        <div class="col-12 col-md-4">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" /><path d="M21 21l-6 -6" /></svg>
                                </span>
                                <input type="text" id="searchInput" class="form-control" placeholder="Search candidates..." aria-label="Search candidates">
                            </div>
                        </div>
                        <div class="col-12 col-md-8 d-flex flex-wrap align-items-center justify-content-md-end g-2">
                            <div class="me-md-2 mb-2 mb-md-0 d-flex flex-grow-1 flex-md-grow-0">
                                <input type="date" id="dateFrom" class="form-control" title="From Date">
                            </div>
                            <div class="me-md-2 mb-2 mb-md-0 d-flex flex-grow-1 flex-md-grow-0">
                                <input type="date" id="dateTo" class="form-control" title="To Date">
                            </div>
                            <!-- Connection Status Filter -->
                            <div class="filter-dropdown-container me-md-2 mb-2 mb-md-0 d-flex align-items-center flex-grow-1 flex-md-grow-0">
                                <label class="form-label mb-0 me-2 text-nowrap">Connection:</label>
                                <div class="dropdown-toggle-button" id="connectionStatusDropdownToggle">
                                    <span id="connectionStatusSelectedCount">All Connections</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon dropdown-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 9l4 4l4 -4" /></svg>
                                </div>
                                <div class="filter-options-pane" id="connectionStatusFilterOptions">
                                    <!-- Options will be populated by JS -->
                                </div>
                            </div>
                            <!-- Lead Source Filter -->
                            <div class="filter-dropdown-container me-md-2 mb-2 mb-md-0 d-flex align-items-center flex-grow-1 flex-md-grow-0">
                                <label class="form-label mb-0 me-2 text-nowrap">Lead Source:</label>
                                <div class="dropdown-toggle-button" id="leadSourceDropdownToggle">
                                    <span id="leadSourceSelectedCount">All Sources</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon dropdown-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 9l4 4l4 -4" /></svg>
                                </div>
                                <div class="filter-options-pane" id="leadSourceFilterOptions">
                                    <!-- Options will be populated by JS -->
                                </div>
                            </div>
                            <!-- Lead Status Filter -->
                            <div class="filter-dropdown-container d-flex align-items-center flex-grow-1 flex-md-grow-0">
                                <label class="form-label mb-0 me-2 text-nowrap">Lead Status:</label>
                                <div class="dropdown-toggle-button" id="statusDropdownToggle">
                                    <span id="statusSelectedCount">All Statuses</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon dropdown-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 9l4 4l4 -4" /></svg>
                                </div>
                                <div class="filter-options-pane" id="statusFilterOptions">
                                    <!-- Options will be populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive table-scrollable-body" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-vcenter table-hover table-nowrap" id="candidatesTable">
                        <thead>
                            <tr>
                                <th class="w-1">#</th>
                                <th>Connection Status</th>
                                <th>Candidate</th>
                                <th>Contact</th>
                                <th>Source</th>
                                <th>Lead Status</th>
                                <th>Experience</th>
                                <th>Calling Remark</th>
                                <th>Current Status</th>
                                <th>Registered</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="candidates-tbody">
                            {% include 'employee/partials/candidate_rows.html' %}
                        </tbody>
                    </table>
                </div>
                
                <div id="loading-indicator" style="display: none; text-align: center; padding: 20px;">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* All your existing styles remain unchanged here */
    .status-badge{display:inline-block;padding:.25rem .5rem;border-radius:50rem;font-size:.75rem;font-weight:600;line-height:1;text-align:center;white-space:nowrap;vertical-align:baseline}.status-hot{background-color:rgba(253,126,20,.1);color:#fd7e14}.status-converted{background-color:rgba(32,201,151,.1);color:#20c997}.status-cold{background-color:rgba(250,82,82,.1);color:#fa5252}.status-not-interested{background-color:rgba(108,117,125,.1);color:#6c757d}.status-connect-later{background-color:rgba(0,123,255,.1);color:#007bff}.status-dnd{background-color:rgba(220,53,69,.1);color:#dc3545}.status-other{background-color:rgba(102,16,242,.1);color:#6610f2}.avatar-container{width:40px;height:40px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center}@media (max-width:768px){.card-header .row>div{width:100%}.card-header .input-group{margin-bottom:1rem}}.table-responsive.table-scrollable-body{position:relative}#candidatesTable thead th{position:sticky;top:0;background-color:var(--tblr-card-bg,white);z-index:10;box-shadow:0 2px 2px -1px rgba(0,0,0,.1)}.filter-dropdown-container{position:relative;width:100%;flex-grow:1;flex-basis:auto}@media (min-width:768px){.filter-dropdown-container{flex-grow:0;max-width:200px}}.dropdown-toggle-button{display:flex;align-items:center;justify-content:space-between;padding:.5rem .75rem;border:1px solid var(--tblr-border-color);border-radius:var(--tblr-border-radius);background-color:var(--tblr-input-bg,white);color:var(--tblr-body-color);cursor:pointer;-webkit-user-select:none;user-select:none;line-height:1.5;transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out}.dropdown-toggle-button:hover{border-color:var(--tblr-border-color-hover)}.dropdown-toggle-button:focus,.dropdown-toggle-button.active{border-color:var(--tblr-primary);box-shadow:var(--tblr-focus-ring-shadow);outline:0}.dropdown-icon{margin-left:.5rem;transition:transform .2s;stroke-width:2;color:var(--tblr-icon-color)}.dropdown-toggle-button.active .dropdown-icon{transform:rotate(180deg)}.filter-options-pane{position:absolute;top:calc(100% + 5px);left:0;z-index:1000;background-color:var(--tblr-card-bg,white);border:1px solid var(--tblr-border-color);border-radius:var(--tblr-border-radius);padding:.75rem;box-shadow:var(--tblr-box-shadow-lg);min-width:220px;max-height:250px;overflow-y:auto;display:none;box-sizing:border-box}.filter-options-pane.show{display:block}.filter-options-pane .form-check{margin-bottom:.5rem;color:var(--tblr-body-color)}.filter-options-pane .form-check:last-child{margin-bottom:0}.filter-options-pane .form-check-label{margin-left:.5rem}.filter-options-pane .select-all-checkbox+.form-check-label{font-weight:700;color:var(--tblr-body-color)}.cursor-pointer{cursor:pointer}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // --- STATE MANAGEMENT ---
    let currentPage = 1;
    let hasNextPage = {{ page_obj.has_next|yesno:"true,false" }};
    let isLoading = false;
    let filterTimeout;

    // --- DOM ELEMENTS ---
    const searchInput = document.getElementById('searchInput');
    const dateFromInput = document.getElementById('dateFrom');
    const dateToInput = document.getElementById('dateTo');
    const tableBody = document.getElementById('candidates-tbody');
    const scrollContainer = document.querySelector('.table-scrollable-body');
    const loadingIndicator = document.getElementById('loading-indicator');
    const totalCandidatesDisplay = document.getElementById('total-candidates-display');

    // --- FILTER CONFIGURATION ---
    const filterConfigs = {
        connectionStatus: {
            toggle: document.getElementById('connectionStatusDropdownToggle'),
            pane: document.getElementById('connectionStatusFilterOptions'),
            countSpan: document.getElementById('connectionStatusSelectedCount'),
            allText: 'All Connections',
            paramName: 'connection_status[]',
            dataAttr: 'data-connection-status'
        },
        leadSource: {
            toggle: document.getElementById('leadSourceDropdownToggle'),
            pane: document.getElementById('leadSourceFilterOptions'),
            countSpan: document.getElementById('leadSourceSelectedCount'),
            allText: 'All Sources',
            paramName: 'lead_source[]',
            dataAttr: 'data-lead-source'
        },
        status: {
            toggle: document.getElementById('statusDropdownToggle'),
            pane: document.getElementById('statusFilterOptions'),
            countSpan: document.getElementById('statusSelectedCount'),
            allText: 'All Statuses',
            paramName: 'status[]',
            dataAttr: 'data-status'
        }
    };

    /**
     * Fetches candidates from the API based on current filters and page.
     */
    async function fetchCandidates(page = 1, append = false) {
        if (isLoading) return;
        isLoading = true;
        loadingIndicator.style.display = 'block';

        const params = new URLSearchParams();
        params.append('page', page);
        
        if (searchInput.value) params.append('search', searchInput.value.trim());
        if (dateFromInput.value) params.append('date_from', dateFromInput.value);
        if (dateToInput.value) params.append('date_to', dateToInput.value);

        for (const key in filterConfigs) {
            const config = filterConfigs[key];
            config.pane.querySelectorAll('.filter-checkbox:checked').forEach(cb => {
                params.append(config.paramName, cb.value);
            });
        }

        const apiUrl = `{% url 'filter_candidates_api' %}?${params.toString()}`;

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();

            if (append) {
                tableBody.insertAdjacentHTML('beforeend', data.rows_html);
            } else {
                tableBody.innerHTML = data.rows_html;
                totalCandidatesDisplay.textContent = data.total_count;
                scrollContainer.scrollTop = 0;
            }

            hasNextPage = data.has_next;
            currentPage = page;
            reinitializeTooltips();
        } catch (error) {
            console.error("Failed to fetch candidates:", error);
        } finally {
            isLoading = false;
            loadingIndicator.style.display = 'none';
        }
    }

    /**
     * Debounces filter changes to avoid excessive API calls.
     */
    function handleFilterChange() {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(() => {
            fetchCandidates(1, false);
        }, 500);
    }
    
    /**
     * Populates filter dropdowns with unique values from the initially loaded table rows.
     */
    function populateFilterOptions() {
        const initialRows = document.querySelectorAll('#candidatesTable tbody tr');
        const uniqueValues = { connectionStatus: new Set(), leadSource: new Set(), status: new Set() };

        initialRows.forEach(row => {
            for (const key in filterConfigs) {
                uniqueValues[key].add(row.getAttribute(filterConfigs[key].dataAttr));
            }
        });

        const toTitleCase = str => str ? str.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Unknown';

        for (const key in filterConfigs) {
            const config = filterConfigs[key];
            const values = Array.from(uniqueValues[key]).filter(Boolean).sort();
            
            let optionsHTML = `
                <div class="input-icon mb-2">
                    <input type="text" class="form-control dropdown-search-input" placeholder="Search...">
                </div>
                <label class="form-check cursor-pointer">
                    <input class="form-check-input select-all-checkbox" type="checkbox">
                    <span class="form-check-label font-weight-bold">Select All</span>
                </label>
            `;
            
            values.forEach(value => {
                optionsHTML += `
                    <label class="form-check cursor-pointer">
                        <input class="form-check-input filter-checkbox" type="checkbox" value="${value}">
                        <span class="form-check-label">${toTitleCase(value)}</span>
                    </label>
                `;
            });
            config.pane.innerHTML = optionsHTML;
        }
    }

    /**
     * Sets up all event listeners for the page.
     */
    function initializeEventListeners() {
        [searchInput, dateFromInput, dateToInput].forEach(el => el.addEventListener('input', handleFilterChange));

        document.addEventListener('click', (e) => {
            for (const key in filterConfigs) {
                const config = filterConfigs[key];
                const isClickInside = config.toggle.contains(e.target) || config.pane.contains(e.target);
                if (e.target === config.toggle) {
                    config.pane.classList.toggle('show');
                    config.toggle.classList.toggle('active');
                } else if (!isClickInside) {
                    config.pane.classList.remove('show');
                    config.toggle.classList.remove('active');
                }
            }
        });

        for (const key in filterConfigs) {
            const config = filterConfigs[key];
            config.pane.addEventListener('change', (e) => {
                if (e.target.matches('.filter-checkbox, .select-all-checkbox')) {
                    const checkboxes = config.pane.querySelectorAll('.filter-checkbox');
                    if (e.target.matches('.select-all-checkbox')) {
                        checkboxes.forEach(cb => cb.checked = e.target.checked);
                    }
                    updateSelectedCount(key);
                    handleFilterChange();
                }
            });
            config.pane.addEventListener('input', (e) => {
                if (e.target.matches('.dropdown-search-input')) {
                    const searchTerm = e.target.value.toLowerCase();
                    config.pane.querySelectorAll('.form-check').forEach(label => {
                        if(label.querySelector('.select-all-checkbox')) return;
                        const text = label.textContent.toLowerCase();
                        label.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                }
            });
        }
    }

    function updateSelectedCount(key) {
        const config = filterConfigs[key];
        const checkedCount = config.pane.querySelectorAll('.filter-checkbox:checked').length;
        const totalCount = config.pane.querySelectorAll('.filter-checkbox').length;
        const selectAll = config.pane.querySelector('.select-all-checkbox');
        
        if (checkedCount === 0) {
            config.countSpan.textContent = config.allText;
            selectAll.checked = false;
            selectAll.indeterminate = false;
        } else if (checkedCount === totalCount) {
            config.countSpan.textContent = config.allText;
            selectAll.checked = true;
            selectAll.indeterminate = false;
        } else {
            config.countSpan.textContent = `${checkedCount} selected`;
            selectAll.checked = false;
            selectAll.indeterminate = true;
        }
    }

    function reinitializeTooltips() {
        // Dispose of existing tooltips to prevent duplicates
        const existingTooltips = bootstrap.Tooltip.getInstance(document.body);
        if (existingTooltips) {
             document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
                const instance = bootstrap.Tooltip.getInstance(el);
                if(instance) instance.dispose();
            });
        }
        // Create new ones
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }

    // --- INITIALIZATION ---
    populateFilterOptions();
    initializeEventListeners();
    reinitializeTooltips();

    scrollContainer.addEventListener('scroll', () => {
        const { scrollTop, scrollHeight, clientHeight } = scrollContainer;
        if (scrollTop + clientHeight >= scrollHeight - 250 && hasNextPage && !isLoading) {
            fetchCandidates(currentPage + 1, true);
        }
    });

    tableBody.addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        if (!row) return;
        if (e.target.closest('a, button, input, select, .actions-cell')) return;
        const profileLink = row.querySelector('.profile-link');
        if (profileLink) window.location.href = profileLink.href;
    });
});
</script>
{% endblock content %}
