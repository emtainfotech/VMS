{% extends 'employee/performance-base.html' %}

{% block content %}
<div class="page-wrapper">
    <div class="page-header d-print-none">
        <div class="container-xl">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <h2 class="page-title">Candidate Management</h2>
                    <div class="text-muted mt-1">
                        <span id="total-candidates-display">{{ page_obj.paginator.count }}</span> candidates found
                    </div>
                </div>
                <div class="col-auto ms-auto d-print-none">
                    <div class="btn-list">
                        <a href="{% url 'employee_candidate_registration' %}" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M12 5l0 14" /><path d="M5 12l14 0" /></svg>
                            Add New Candidate
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="page-body">
        <div class="container-xl">
            <div class="card">
                <div class="card-header">
                    <div class="row align-items-center g-2 w-100">
                        <div class="col-12 col-md-4">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" /><path d="M21 21l-6 -6" /></svg>
                                </span>
                                <input type="text" id="searchInput" class="form-control" placeholder="Search candidates..." aria-label="Search candidates">
                            </div>
                        </div>
                        <div class="col-12 col-md-8 d-flex justify-content-md-end">
                            <div class="btn-list">
                                <button id="clearAllFiltersBtn" class="btn btn-light" style="display: none;">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-filter-off" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M3 3l18 18"></path><path d="M8.5 8.5c.337 -1.33 .944 -2.528 1.772 -3.5h3.456a1 1 0 0 1 .8 1.6l-2.4 2.9a1 1 0 0 0 0 1l.594 .742m2.053 2.566l2.353 2.942a1 1 0 0 1 -.8 1.6h-12a1 1 0 0 1 -.8 -1.6l2.4 -2.9a1 1 0 0 0 0 -1l-2.4 -2.9a1 1 0 0 1 .8 -1.6h2.31"></path></svg>
                                    Clear Filters
                                </button>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#filterModal">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4h16v2.172a2 2 0 0 1 -.586 1.414l-4.414 4.414v7l-6 2v-8.5l-4.414 -4.414a2 2 0 0 1 -.586 -1.414v-2.172z" /></svg>
                                    Filter
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive table-scrollable-body" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-vcenter table-hover table-nowrap" id="candidatesTable">
                        <thead>
                            <tr>
                                <th class="w-1">#</th>
                                <th>Connection Status</th>
                                <th>Candidate</th>
                                <th>Contact</th>
                                <th>Source</th>
                                <th>Lead Status</th>
                                <th>Experience</th>
                                <th>Calling Remark</th>
                                <th>Current Status</th>
                                <th>Registered</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="candidates-tbody">
                            {% include 'employee/partials/candidate_rows.html' %}
                        </tbody>
                    </table>
                </div>
                
                <div id="loading-indicator" style="display: none; text-align: center; padding: 20px;">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="filterModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Filter Candidates</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="dateFrom" class="form-label">Date From</label>
                        <input type="date" id="dateFrom" class="form-control" title="From Date">
                    </div>
                    <div class="col-md-6">
                        <label for="dateTo" class="form-label">Date To</label>
                        <input type="date" id="dateTo" class="form-control" title="To Date">
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Connection Status</label>
                        <div class="filter-options-pane" id="connectionStatusFilterOptions" style="position: relative; display: block; border: 1px solid #ddd; border-radius: 4px; padding: .75rem; max-height: 250px; overflow-y: auto;">
                            </div>
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label">Lead Source</label>
                        <div class="filter-options-pane" id="leadSourceFilterOptions" style="position: relative; display: block; border: 1px solid #ddd; border-radius: 4px; padding: .75rem; max-height: 250px; overflow-y: auto;">
                            </div>
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label">Lead Status</label>
                        <div class="filter-options-pane" id="statusFilterOptions" style="position: relative; display: block; border: 1px solid #ddd; border-radius: 4px; padding: .75rem; max-height: 250px; overflow-y: auto;">
                            </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn me-auto" id="modalClearFiltersBtn">Clear Filters</button>
                <button type="button" class="btn btn-primary" id="modalApplyFiltersBtn" data-bs-dismiss="modal">Apply Filters</button>
            </div>
        </div>
    </div>
</div>


<style>
    /* All your existing styles remain unchanged here */
    .status-badge{display:inline-block;padding:.25rem .5rem;border-radius:50rem;font-size:.75rem;font-weight:600;line-height:1;text-align:center;white-space:nowrap;vertical-align:baseline}.status-hot{background-color:rgba(253,126,20,.1);color:#fd7e14}.status-converted{background-color:rgba(32,201,151,.1);color:#20c997}.status-cold{background-color:rgba(250,82,82,.1);color:#fa5252}.status-not-interested{background-color:rgba(108,117,125,.1);color:#6c757d}.status-connect-later{background-color:rgba(0,123,255,.1);color:#007bff}.status-dnd{background-color:rgba(220,53,69,.1);color:#dc3545}.status-other{background-color:rgba(102,16,242,.1);color:#6610f2}.avatar-container{width:40px;height:40px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center}@media (max-width:768px){.card-header .row>div{width:100%}.card-header .input-group{margin-bottom:1rem}}.table-responsive.table-scrollable-body{position:relative}#candidatesTable thead th{position:sticky;top:0;z-index:10;box-shadow:0 2px 2px -1px rgba(0,0,0,.1)}.filter-dropdown-container{position:relative;width:100%;flex-grow:1;flex-basis:auto}@media (min-width:768px){.filter-dropdown-container{flex-grow:0;max-width:200px}}.dropdown-toggle-button{display:flex;align-items:center;justify-content:space-between;padding:.5rem .75rem;border:1px solid var(--tblr-border-color);border-radius:var(--tblr-border-radius);color:var(--tblr-body-color);cursor:pointer;-webkit-user-select:none;user-select:none;line-height:1.5;transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out}.dropdown-toggle-button:hover{border-color:var(--tblr-border-color-hover)}.dropdown-toggle-button:focus,.dropdown-toggle-button.active{border-color:var(--tblr-primary);box-shadow:var(--tblr-focus-ring-shadow);outline:0}.dropdown-icon{margin-left:.5rem;transition:transform .2s;stroke-width:2;color:var(--tblr-icon-color)}.dropdown-toggle-button.active .dropdown-icon{transform:rotate(180deg)}.filter-options-pane{box-sizing:border-box}.filter-options-pane .form-check{margin-bottom:.5rem;color:var(--tblr-body-color)}.filter-options-pane .form-check:last-child{margin-bottom:0}.filter-options-pane .form-check-label{margin-left:.5rem}.filter-options-pane .select-all-checkbox+.form-check-label{font-weight:700;color:var(--tblr-body-color)}.cursor-pointer{cursor:pointer}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // --- STATE MANAGEMENT ---
    let currentPage = 1;
    let hasNextPage = {{ page_obj.has_next|yesno:"true,false" }};
    let isLoading = false;
    let searchTimeout;
    const FILTERS_STORAGE_KEY = 'candidateFilters';

    // --- DOM ELEMENTS ---
    const searchInput = document.getElementById('searchInput');
    const dateFromInput = document.getElementById('dateFrom');
    const dateToInput = document.getElementById('dateTo');
    const tableBody = document.getElementById('candidates-tbody');
    const scrollContainer = document.querySelector('.table-scrollable-body');
    const loadingIndicator = document.getElementById('loading-indicator');
    const totalCandidatesDisplay = document.getElementById('total-candidates-display');
    const modalApplyBtn = document.getElementById('modalApplyFiltersBtn');
    const modalClearBtn = document.getElementById('modalClearFiltersBtn');
    const clearAllFiltersBtn = document.getElementById('clearAllFiltersBtn');
    
    // --- FILTER CONFIGURATION ---
    const filterConfigs = {
        connectionStatus: {
            pane: document.getElementById('connectionStatusFilterOptions'),
            paramName: 'connection_status',
            dataAttr: 'data-connection-status'
        },
        leadSource: {
            pane: document.getElementById('leadSourceFilterOptions'),
            paramName: 'lead_source',
            dataAttr: 'data-lead-source'
        },
        status: {
            pane: document.getElementById('statusFilterOptions'),
            paramName: 'status',
            dataAttr: 'data-status'
        }
    };

    /**
     * Saves the current state of all filters to localStorage.
     */
    function saveFiltersToStorage() {
        const filters = {
            search: searchInput.value.trim(),
            date_from: dateFromInput.value,
            date_to: dateToInput.value,
        };
        for (const key in filterConfigs) {
            const config = filterConfigs[key];
            filters[config.paramName] = Array.from(config.pane.querySelectorAll('.filter-checkbox:checked')).map(cb => cb.value);
        }
        localStorage.setItem(FILTERS_STORAGE_KEY, JSON.stringify(filters));
        updateClearAllButtonVisibility();
    }

    /**
     * Loads filter state from localStorage and applies it to the input fields.
     */
    function loadFiltersFromStorage() {
        const savedFilters = JSON.parse(localStorage.getItem(FILTERS_STORAGE_KEY) || '{}');

        searchInput.value = savedFilters.search || '';
        dateFromInput.value = savedFilters.date_from || '';
        dateToInput.value = savedFilters.date_to || '';

        for (const key in filterConfigs) {
            const config = filterConfigs[key];
            const values = savedFilters[config.paramName] || [];
            if (values.length > 0) {
                config.pane.querySelectorAll('.filter-checkbox').forEach(cb => {
                    cb.checked = values.includes(cb.value);
                });
            }
            updateSelectAllCheckbox(key);
        }
        updateClearAllButtonVisibility();
    }
    
    /**
     * Clears all filters, removes them from storage, and refreshes the data.
     */
    function clearAllFilters() {
        localStorage.removeItem(FILTERS_STORAGE_KEY);
        
        // Reset form fields
        searchInput.value = '';
        dateFromInput.value = '';
        dateToInput.value = '';
        for (const key in filterConfigs) {
            filterConfigs[key].pane.querySelectorAll('.filter-checkbox, .select-all-checkbox').forEach(cb => cb.checked = false);
            updateSelectAllCheckbox(key);
        }

        updateClearAllButtonVisibility();
        fetchCandidates(1, false);
    }
    
    /**
     * Shows or hides the "Clear All Filters" button based on whether any filters are active.
     */
    function updateClearAllButtonVisibility() {
        const savedFilters = JSON.parse(localStorage.getItem(FILTERS_STORAGE_KEY) || '{}');
        let isFilterApplied = false;

        if (savedFilters.search || savedFilters.date_from || savedFilters.date_to) {
            isFilterApplied = true;
        } else {
            for (const key in filterConfigs) {
                if (savedFilters[filterConfigs[key].paramName] && savedFilters[filterConfigs[key].paramName].length > 0) {
                    isFilterApplied = true;
                    break;
                }
            }
        }
        
        clearAllFiltersBtn.style.display = isFilterApplied ? 'inline-flex' : 'none';
    }


    /**
     * Fetches candidates from the API based on current filters and page.
     */
    async function fetchCandidates(page = 1, append = false) {
        if (isLoading) return;
        isLoading = true;
        if (!append) {
             loadingIndicator.style.display = 'block';
        }
       
        const savedFilters = JSON.parse(localStorage.getItem(FILTERS_STORAGE_KEY) || '{}');
        const params = new URLSearchParams();
        params.append('page', page);
        
        if (savedFilters.search) params.append('search', savedFilters.search);
        if (savedFilters.date_from) params.append('date_from', savedFilters.date_from);
        if (savedFilters.date_to) params.append('date_to', savedFilters.date_to);

        for (const key in filterConfigs) {
            const config = filterConfigs[key];
            const values = savedFilters[config.paramName] || [];
            values.forEach(value => {
                 params.append(`${config.paramName}[]`, value);
            });
        }

        const apiUrl = `{% url 'filter_candidates_api' %}?${params.toString()}`;

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();

            if (append) {
                tableBody.insertAdjacentHTML('beforeend', data.rows_html);
            } else {
                tableBody.innerHTML = data.rows_html;
                totalCandidatesDisplay.textContent = data.total_count;
                scrollContainer.scrollTop = 0;
            }

            hasNextPage = data.has_next;
            currentPage = page;
            reinitializeTooltips();
        } catch (error) {
            console.error("Failed to fetch candidates:", error);
        } finally {
            isLoading = false;
            loadingIndicator.style.display = 'none';
        }
    }

    /**
     * Populates filter dropdowns with unique values from the initially loaded table rows.
     */
    function populateFilterOptions() {
        const initialRows = document.querySelectorAll('#candidatesTable tbody tr');
        const uniqueValues = { connectionStatus: new Set(), leadSource: new Set(), status: new Set() };

        initialRows.forEach(row => {
            for (const key in filterConfigs) {
                uniqueValues[key].add(row.getAttribute(filterConfigs[key].dataAttr));
            }
        });

        const toTitleCase = str => str ? str.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Unknown';

        for (const key in filterConfigs) {
            const config = filterConfigs[key];
            const values = Array.from(uniqueValues[key]).filter(Boolean).sort();
            
            let optionsHTML = `
                <div class="input-icon mb-2">
                    <input type="text" class="form-control dropdown-search-input" placeholder="Search...">
                </div>
                <label class="form-check cursor-pointer">
                    <input class="form-check-input select-all-checkbox" type="checkbox">
                    <span class="form-check-label font-weight-bold">Select All</span>
                </label>
            `;
            
            values.forEach(value => {
                optionsHTML += `
                    <label class="form-check cursor-pointer">
                        <input class="form-check-input filter-checkbox" type="checkbox" value="${value}">
                        <span class="form-check-label">${toTitleCase(value)}</span>
                    </label>
                `;
            });
            config.pane.innerHTML = optionsHTML;
        }
    }
    
    function updateSelectAllCheckbox(key) {
        const config = filterConfigs[key];
        const checkboxes = config.pane.querySelectorAll('.filter-checkbox');
        const checkedCount = config.pane.querySelectorAll('.filter-checkbox:checked').length;
        const selectAll = config.pane.querySelector('.select-all-checkbox');
        
        if (checkedCount === 0) {
            selectAll.checked = false;
            selectAll.indeterminate = false;
        } else if (checkedCount === checkboxes.length) {
            selectAll.checked = true;
            selectAll.indeterminate = false;
        } else {
            selectAll.checked = false;
            selectAll.indeterminate = true;
        }
    }

    function reinitializeTooltips() {
        const existingTooltips = bootstrap.Tooltip.getInstance(document.body);
        if (existingTooltips) {
             document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
                 const instance = bootstrap.Tooltip.getInstance(el);
                 if(instance) instance.dispose();
            });
        }
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }

    /**
     * Sets up all event listeners for the page.
     */
    function initializeEventListeners() {
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                saveFiltersToStorage();
                fetchCandidates(1, false);
            }, 500);
        });

        modalApplyBtn.addEventListener('click', () => {
            saveFiltersToStorage();
            fetchCandidates(1, false);
        });
        
        modalClearBtn.addEventListener('click', () => {
             dateFromInput.value = '';
             dateToInput.value = '';
             for (const key in filterConfigs) {
                filterConfigs[key].pane.querySelectorAll('.filter-checkbox, .select-all-checkbox').forEach(cb => cb.checked = false);
                updateSelectAllCheckbox(key);
             }
        });
        
        clearAllFiltersBtn.addEventListener('click', clearAllFilters);
        
        for (const key in filterConfigs) {
            const config = filterConfigs[key];
            config.pane.addEventListener('change', (e) => {
                if (e.target.matches('.filter-checkbox, .select-all-checkbox')) {
                    if (e.target.matches('.select-all-checkbox')) {
                       config.pane.querySelectorAll('.filter-checkbox').forEach(cb => cb.checked = e.target.checked);
                    }
                    updateSelectAllCheckbox(key);
                }
            });
            config.pane.addEventListener('input', (e) => {
                if (e.target.matches('.dropdown-search-input')) {
                    const searchTerm = e.target.value.toLowerCase();
                    config.pane.querySelectorAll('.form-check').forEach(label => {
                        if(label.querySelector('.select-all-checkbox')) return;
                        const text = label.textContent.toLowerCase();
                        label.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                }
            });
        }
        
        scrollContainer.addEventListener('scroll', () => {
            const { scrollTop, scrollHeight, clientHeight } = scrollContainer;
            if (scrollTop + clientHeight >= scrollHeight - 250 && hasNextPage && !isLoading) {
                fetchCandidates(currentPage + 1, true);
            }
        });

        tableBody.addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            if (!row || e.target.closest('a, button, input, select, .actions-cell')) return;
            const profileLink = row.querySelector('.profile-link');
            if (profileLink) window.location.href = profileLink.href;
        });
    }

    // --- INITIALIZATION ---
    populateFilterOptions();
    loadFiltersFromStorage();
    initializeEventListeners();
    fetchCandidates(1, false); // Initial fetch based on loaded filters
    reinitializeTooltips();
});
</script>
{% endblock content %}