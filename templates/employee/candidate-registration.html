{% extends 'employee/performance-base.html' %}

{% block content %}
    <div class="page-body">
        <div class="container-xl">
            <div class="row row-cards">
                <div class="col-12">
                    <div class="card-header">
                        <h4 class="card-title">Candidate Details</h4>
                    </div>
                    <div class="card-body">
                        <div class="row g-5">
                            <div class="col-lg-12">
                                <div class="row row-cards">
                                    <div class="col-12">
                                        <form method="POST" enctype="multipart/form-data" class="card" id="candidateForm" novalidate>
                                            {% csrf_token %}
                                            <div class="card-body">
                                                <div id="formErrors" class="alert alert-danger d-none"></div>
                                                <div class="row row-cards">
                                                    <div class="col-md-5">
                                                        <div class="mb-3">
                                                            <label class="form-label">Candidate Name</label>
                                                            <input type="text" class="form-control" name="candidate_name" 
                                                                    placeholder="Candidate Name" 
                                                                    pattern="[A-Za-z ]{3,}" 
                                                                    title="Name should contain only letters and spaces (minimum 3 characters)" 
                                                                    required>
                                                            <div class="invalid-feedback">Please provide a valid name (letters only, min 3 characters).</div>
                                                            <input type="hidden" class="form-control" name="submit_by" value="{{user.username}}" required>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-sm-6 col-md-4">
                                                        <div class="mb-3">
                                                            <label class="form-label">Mobile Number</label>
                                                            <input type="tel" class="form-control" name="candidate_mobile_number" 
                                                                    placeholder="Mobile Number" 
                                                                    pattern="[0-9]{10}" 
                                                                    title="Please enter a valid 10-digit mobile number"
                                                                    required>
                                                            <div class="invalid-feedback">Please provide a valid 10-digit mobile number.</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-sm-4 col-md-3">
                                                        <div class="mb-3">
                                                            <label class="form-label">Alternate Mobile Number</label>
                                                            <input type="tel" class="form-control" name="candidate_alternate_mobile_number" 
                                                                    placeholder="Alternate Mobile Number"
                                                                    pattern="[0-9]{10}"
                                                                    title="Please enter a valid 10-digit mobile number">
                                                            <div class="invalid-feedback">Please provide a valid 10-digit mobile number.</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-sm-4 col-md-4">
                                                        <div class="mb-3">
                                                            <label class="form-label">Email Address</label>
                                                            <input type="email" class="form-control" name="candidate_email_address" 
                                                                    placeholder="Email Address"
                                                                    pattern="^[^\s@]+@[^\s@]+\.[^\s@]+$"
                                                                    title="Please enter a valid email address">
                                                            <div class="invalid-feedback">Please provide a valid email address.</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-sm-6 col-md-2">
                                                        <div class="mb-3">
                                                            <div class="form-label">Gender</div>
                                                            <select name="gender" class="form-select" required>
                                                                <option value="" disabled selected>Select Gender</option>
                                                                <option value="Male" {% if Candidate_registration.gender == "Male" %}selected{% endif %}>Male</option>
                                                                <option value="Female" {% if Candidate_registration.gender == "Female" %}selected{% endif %}>Female</option>
                                                            </select>
                                                            <div class="invalid-feedback">Please select a gender.</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-sm-6 col-md-3">
                                                        <div class="mb-3">
                                                            <label class="form-label">Lead Source</label>
                                                            <select name="lead_source" class="form-select" id="lead_source_select" required>
                                                                <option value="" disabled selected>Select Lead Source</option>
                                                                <option value="EVMS" {% if Candidate_registration.lead_source == "EVMS" %}selected{% endif %}>EVMS</option>
                                                                <option value="Walk-In" {% if Candidate_registration.lead_source == "Walk-In" %}selected{% endif %}>Walk-In</option>
                                                                <option value="Job Hai" {% if Candidate_registration.lead_source == "Job Hai" %}selected{% endif %}>Job Hai</option>
                                                                <option value="Naukari" {% if Candidate_registration.lead_source == "Naukari" %}selected{% endif %}>Naukari</option>
                                                                <option value="Apna" {% if Candidate_registration.lead_source == "Apna" %}selected{% endif %}>Apna</option>
                                                                <option value="Expertia" {% if Candidate_registration.lead_source == "Expertia" %}selected{% endif %}>Expertia</option>
                                                                <option value="Instagram" {% if Candidate_registration.lead_source == "Instagram" %}selected{% endif %}>Instagram</option>
                                                                <option value="Website" {% if Candidate_registration.lead_source == "Website" %}selected{% endif %}>Website</option>
                                                                <option value="Indeed" {% if Candidate_registration.lead_source == "Indeed" %}selected{% endif %}>Indeed</option>
                                                                <option value="Facebook" {% if Candidate_registration.lead_source == "Facebook" %}selected{% endif %}>Facebook</option>
                                                                <option value="Linkedin" {% if Candidate_registration.lead_source == "Linkedin" %}selected{% endif %}>Linkedin</option>
                                                                <option value="Other" {% if Candidate_registration.lead_source == "Other" %}selected{% endif %}>Other</option>
                                                            </select>
                                                            <div class="invalid-feedback">Please select a lead source.</div>

                                                            <input type="text" name="other_lead_source" id="lead_source_other_input" class="form-control mt-2"
                                                                    placeholder="Please specify..." 
                                                                    style="display: none;"
                                                                    >
                                                        </div>
                                                    </div>
                                                    <script>
                                                        document.addEventListener("DOMContentLoaded", function () {
                                                            const leadSourceSelect = document.getElementById("lead_source_select");
                                                            const otherInput = document.getElementById("lead_source_other_input");

                                                            function toggleOtherInput() {
                                                                if (leadSourceSelect.value === "Other") {
                                                                    otherInput.style.display = "block";
                                                                    otherInput.required = true;
                                                                } else {
                                                                    otherInput.style.display = "none";
                                                                    otherInput.required = false;
                                                                }
                                                            }

                                                            leadSourceSelect.addEventListener("change", toggleOtherInput);
                                                            toggleOtherInput(); // call on load for edit mode
                                                        });
                                                    </script>
                                                    
                                                    <div class="col-sm-6 col-md-3">
                                                        <div class="mb-3">
                                                            <label class="form-label">Preferred Location</label>
                                                            <select class="form-select" id="select-prefered-location" name="preferred_location" multiple  placeholder="Select Prefered Location" >
                                                                {% for district in districts %}
                                                                <option value="{{ district }}" {% if Candidate_registration.preferred_location == district %}selected{% endif %}>
                                                                    {{ district }}
                                                                </option>
                                                                {% endfor %}
                                                                <option value="Other" id="other-location-option">Other</option>
                                                            </select>
                                                            
                                                            <input type="text" id="other-location-input" name="other_preferred_location"
                                                                    class="form-control mt-2 d-none" placeholder="Enter other location" 
                                                                    value="{% if Candidate_registration.other_preferred_location %}{{ Candidate_registration.other_preferred_location }}{% endif %}" />
                                                            
                                                            <div class="invalid-feedback">Please select at least one preferred location.</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-sm-6 col-md-3">
                                                        <div class="mb-3">
                                                            <label class="form-label">Origin Location</label>
                                                            <select type="text" class="form-select" name="origin_location" id="originLocationSelect" >
                                                                <option value="" disabled selected>Select Origin location</option>
                                                                {% for district in districts %}
                                                                <option value="{{ district }}" {% if Candidate_registration.origin_location == district %}selected{% endif %}>
                                                                    {{ district }}
                                                                </option>
                                                                {% endfor %}
                                                                <option value="Others" {% if Candidate_registration.origin_location == "Others" %}selected{% endif %}>Others</option>
                                                            </select>
                                                            <div class="invalid-feedback">Please select an origin location.</div>
                                                        </div>
                                                    </div>

                                                    <div class="col-sm-6 col-md-3" id="otherOriginField" style="display: none;">
                                                        <div class="mb-3">
                                                            <label class="form-label">Please specify other location</label>
                                                            <input type="text" class="form-control" name="other_origin_location" placeholder="Enter other origin location">
                                                        </div>
                                                    </div>

                                                    <script>
                                                    // Toggle 'Other Origin Location' input field
                                                    document.getElementById('originLocationSelect').addEventListener('change', function () {
                                                        const otherField = document.getElementById('otherOriginField');
                                                        if (this.value === 'Others') {
                                                            otherField.style.display = 'block';
                                                        } else {
                                                            otherField.style.display = 'none';
                                                        }
                                                    });
                                                    </script>
                                                    
                                                    <div class="col-sm-6 col-md-3">
                                                        <div class="mb-3">
                                                            <div class="form-label">Qualification</div>
                                                            <select class="form-select" name="qualification" id="qualificationSelect" >
                                                                <option value="" disabled selected>Select highest qualification</option>
                                                                <option value="Secondary School" {% if Candidate_registration.qualification == "Secondary School" %}selected{% endif %}>Secondary School</option>
                                                                <option value="Higher Secondary School" {% if Candidate_registration.qualification == "Higher Secondary School" %}selected{% endif %}>Higher Secondary School</option>
                                                                <option value="Graduate" {% if Candidate_registration.qualification == "Graduate" %}selected{% endif %}>Graduate</option>
                                                                <option value="Post-Graduate" {% if Candidate_registration.qualification == "Post-Graduate" %}selected{% endif %}>Post-Graduate</option>
                                                                <option value="Ph.D." {% if Candidate_registration.qualification == "Ph.D." %}selected{% endif %}>Ph.D.</option>
                                                                <option value="Others" {% if Candidate_registration.qualification == "Others" %}selected{% endif %}>Others</option>
                                                            </select>
                                                            <div class="invalid-feedback">Please select a qualification.</div>
                                                        </div>
                                                    </div>

                                                    <div class="col-sm-6 col-md-3" id="otherQualificationField" style="display: none;">
                                                        <div class="mb-3">
                                                            <label class="form-label">Please specify</label>
                                                            <input type="text" class="form-control" name="other_qualification" placeholder="Enter your qualification">
                                                        </div>
                                                    </div>

                                                    <script>
                                                    document.getElementById('qualificationSelect').addEventListener('change', function () {
                                                        const otherField = document.getElementById('otherQualificationField');
                                                        if (this.value === 'Others') {
                                                            otherField.style.display = 'block';
                                                        } else {
                                                            otherField.style.display = 'none';
                                                        }
                                                    });
                                                    </script>
                                                    
                                                    <div class="col-sm-6 col-md-3">
                                                        <div class="mb-3">
                                                            <label class="form-label">Diploma If Any</label>
                                                            <input type="text" class="form-control" name="diploma" placeholder="Diploma">
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-sm-6 col-md-4">
                                                        <div class="mb-3">
                                                            <label class="form-label">Sector</label>
                                                            <select type="text" class="form-select" placeholder="Select Sectors"
                                                                    id="select-sector" name="sector" multiple >
                                                                {% for job_sector in job_sectors %}
                                                                <option value="{{ job_sector }}" {% if Candidate_registration.sector == job_sector %}selected{% endif %}>
                                                                    {{ job_sector }}
                                                                </option>
                                                                {% endfor %}
                                                                <option value="Others">Others</option>
                                                            </select>
                                                            <div class="invalid-feedback">Please select at least one sector.</div>
                                                        </div>
                                                    </div>

                                                    <div class="col-sm-6 col-md-4" id="otherSectorField" style="display: none;">
                                                        <div class="mb-3">
                                                            <label class="form-label">Please specify other sector</label>
                                                            <input type="text" class="form-control" name="other_sector" placeholder="Enter other sector">
                                                        </div>
                                                    </div>

                                                    <script>
                                                    document.getElementById('select-sector').addEventListener('change', function () {
                                                        const selectedOptions = Array.from(this.selectedOptions).map(opt => opt.value);
                                                        const otherField = document.getElementById('otherSectorField');

                                                        if (selectedOptions.includes('Others')) {
                                                            otherField.style.display = 'block';
                                                        } else {
                                                            otherField.style.display = 'none';
                                                        }
                                                    });
                                                    </script>

                                                    <div class="col-sm-6 col-md-4">
                                                        <div class="mb-3">
                                                            <label class="form-label">Department</label>
                                                            <select type="text" class="form-select" placeholder="Select Departments"
                                                                    id="select-department" name="department" multiple >
                                                                {% for department in departments %}
                                                                <option value="{{ department }}" {% if Candidate_registration.department == department %}selected{% endif %}>
                                                                    {{ department }}
                                                                </option>
                                                                {% endfor %}
                                                                <option value="Others">Others</option>
                                                            </select>
                                                            <div class="invalid-feedback">Please select at least one department.</div>
                                                        </div>
                                                    </div>

                                                    <div class="col-sm-6 col-md-4" id="otherDepartmentField" style="display: none;">
                                                        <div class="mb-3">
                                                            <label class="form-label">Please specify other department</label>
                                                            <input type="text" class="form-control" name="other_department" placeholder="Enter other department">
                                                        </div>
                                                    </div>

                                                    <script>
                                                    // Toggle "Other Department" input
                                                    document.getElementById('select-department').addEventListener('change', function () {
                                                        const selectedOptions = Array.from(this.selectedOptions).map(opt => opt.value);
                                                        const otherField = document.getElementById('otherDepartmentField');

                                                        if (selectedOptions.includes('Others')) {
                                                            otherField.style.display = 'block';
                                                        } else {
                                                            otherField.style.display = 'none';
                                                        }
                                                    });
                                                    </script>
                                                    
                                                    <div class="col-sm-6 col-md-2">
                                                        <div class="mb-3">
                                                            <label class="form-label">Experience (In Year)</label>
                                                            <input type="number" class="form-control" name="experience_year" 
                                                                    placeholder="Experience (In Year)" min="0" max="50">
                                                            <div class="invalid-feedback">Please enter valid years (0-50).</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-sm-6 col-md-2">
                                                        <div class="mb-3">
                                                            <label class="form-label">Experience (In Month)</label>
                                                            <input type="number" name='experience_month' class="form-control" 
                                                                    placeholder="Experience (In Month)" min="0" max="11">
                                                            <div class="invalid-feedback">Please enter valid months (0-11).</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-sm-6 col-md-3">
                                                        <div class="mb-3">
                                                            <label class="form-label">Current Company</label>
                                                            <input type="text" name='current_company' class="form-control" placeholder="Current Company">
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-md-3">
                                                        <div class="mb-3">
                                                            <label class="form-label">Current Working Status</label>
                                                            <select class="form-control form-select" name='current_working_status' >
                                                                <option value="" disabled selected>Select Status</option>
                                                                <option value="Employed" {% if Candidate_registration.current_working_status == "Employed" %}selected{% endif %}>Employed</option>
                                                                <option value="Un-Employed" {% if Candidate_registration.current_working_status == "Un-Employed" %}selected{% endif %}>Un-Employed</option>
                                                            </select>
                                                            <div class="invalid-feedback">Please select current working status.</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-sm-6 col-md-3">
                                                        <label class="form-label">Current Salary</label>
                                                        <div class="mb-3 input-group">
                                                            <input type="number" class="form-control" name="current_salary" 
                                                                    placeholder="Current Salary" min="0" step="1">
                                                            <select class="form-select" name="current_salary_type">
                                                                <option value="(CTC)" {% if candidate.current_salary_type == '(CTC)' %}selected{% endif %}>CTC</option>
                                                                <option value="(Per Month)" {% if candidate.current_salary_type == '(Per Month)' %}selected{% endif %}>Per Month</option>
                                                                <option value="(In Hand)" {% if candidate.current_salary_type == '(In Hand)' %}selected{% endif %}>In Hand</option>
                                                                <option value="(Per Annum)" {% if candidate.current_salary_type == '(Per Annum)' %}selected{% endif %}>Per Annum</option>
                                                            </select>
                                                            <div class="invalid-feedback">Please enter a valid salary.</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-sm-6 col-md-3">
                                                        <label class="form-label">Expected Salary</label>
                                                        <div class="mb-3 input-group">
                                                            <input type="number" name='expected_salary' class="form-control" 
                                                                    placeholder="Expected Salary" min="0" step="1">
                                                            <select class="form-select" name="expected_salary_type">
                                                                <option value="(CTC)" {% if candidate.expected_salary_type == '(CTC)' %}selected{% endif %}>CTC</option>
                                                                <option value="(Per Month)" {% if candidate.expected_salary_type == '(Per Month)' %}selected{% endif %}>Per Month</option>
                                                                <option value="(In Hand)" {% if candidate.expected_salary_type == '(In Hand)' %}selected{% endif %}>In Hand</option>
                                                                <option value="(Per Annum)" {% if candidate.expected_salary_type == '(Per Annum)' %}selected{% endif %}>Per Annum</option>
                                                            </select>
                                                            <div class="invalid-feedback">Please enter a valid expected salary.</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-sm-6 col-md-6">
                                                        <div class="mb-3">
                                                            <label class="form-label">Candidate Photo</label>
                                                            <input type="file" name='candidate_photo' class="form-control" 
                                                                    accept="image/*" />
                                                            <small class="text-muted">Max size: 2MB, Formats: JPG, PNG</small>
                                                            <div class="invalid-feedback">Please upload a valid image file (JPG/PNG, max 2MB).</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-sm-6 col-md-6">
                                                        <div class="mb-3">
                                                            <label class="form-label">Candidate Resume</label>
                                                            <input type="file" name="candidate_resume" class="form-control" id="candidateResumeInput"
                                                                    accept="application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,image/*">
                                                            <small class="text-muted">Max size: 5MB, Formats: PDF, DOC, DOCX, Image</small>
                                                            <div id="resumeLinkWrapper" class="mt-2 position-relative"></div>
                                                        </div>
                                                    </div>

                                                    <style>
                                                    .preview-popup {
                                                        position: absolute;
                                                        top: 25px;
                                                        left: 0;
                                                        width: 300px;
                                                        max-height: 300px;
                                                        z-index: 999;
                                                        background: white;
                                                        border: 1px solid #ccc;
                                                        display: none;
                                                        padding: 5px;
                                                        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
                                                    }

                                                    .preview-popup img,
                                                    .preview-popup embed {
                                                        width: 100%;
                                                        height: auto;
                                                        max-height: 280px;
                                                    }
                                                    </style>

                                                    <script>
                                                    document.getElementById('candidateResumeInput').addEventListener('change', function (e) {
                                                        const file = e.target.files[0];
                                                        const wrapper = document.getElementById('resumeLinkWrapper');
                                                        wrapper.innerHTML = '';

                                                        if (!file) return;

                                                        const fileType = file.type;
                                                        const fileURL = URL.createObjectURL(file);

                                                        const link = document.createElement('a');
                                                        link.href = fileURL;
                                                        link.target = '_blank';
                                                        link.textContent = 'View Resume';
                                                        link.className = 'text-primary text-decoration-underline';
                                                        link.style.cursor = 'pointer';

                                                        const popup = document.createElement('div');
                                                        popup.className = 'preview-popup';

                                                        // Detect and build preview
                                                        if (fileType.startsWith('image/')) {
                                                            const img = document.createElement('img');
                                                            img.src = fileURL;
                                                            popup.appendChild(img);
                                                        } else if (fileType === 'application/pdf') {
                                                            const embed = document.createElement('embed');
                                                            embed.src = fileURL;
                                                            embed.type = 'application/pdf';
                                                            embed.style.height = '280px';
                                                            popup.appendChild(embed);
                                                        } else {
                                                            const msg = document.createElement('p');
                                                            msg.textContent = 'Preview not available for this file type.';
                                                            msg.className = 'text-muted';
                                                            popup.appendChild(msg);
                                                        }

                                                        // Hover behavior
                                                        link.addEventListener('mouseenter', () => popup.style.display = 'block');
                                                        link.addEventListener('mouseleave', () => popup.style.display = 'none');
                                                        popup.addEventListener('mouseenter', () => popup.style.display = 'block');
                                                        popup.addEventListener('mouseleave', () => popup.style.display = 'none');

                                                        wrapper.appendChild(link);
                                                        wrapper.appendChild(popup);
                                                    });
                                                    </script>
                                                    
                                                    <hr>
                                                    
                                                    <div class="col-md-3">
                                                        <div class="mb-3">
                                                            <label class="form-label">Call Connection</label>
                                                            <select class="form-control form-select" name='call_connection' required>
                                                                <option value="" disabled selected>Select Status</option>
                                                                <option value="Connected" {% if Candidate_registration.call_connection == "Connected" %}selected{% endif %}>Connected</option>
                                                                <option value="Not Connected" {% if Candidate_registration.call_connection == "Not Connected" %}selected{% endif %}>Not Connected</option>
                                                            </select>
                                                            <div class="invalid-feedback">Please select call connection status.</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-md-3">
                                                        <div class="mb-3">
                                                            <label class="form-label">Calling Remark</label>
                                                            <select class="form-control form-select" name='calling_remark'>
                                                                <option value="" disabled selected>Select Status</option>
                                                                <option value="Lead Generate" {% if Candidate_registration.calling_remark == "Lead Generate" %}selected{% endif %}>Lead Generate</option>
                                                                <option value="Follow-Up" {% if Candidate_registration.calling_remark == "Follow-Up" %}selected{% endif %}>Follow-Up</option>
                                                                <option value="Shortlisted for Banking Counselling" {% if Candidate_registration.calling_remark == "Shortlisted for Banking Counselling" %}selected{% endif %}>Shortlisted for Banking Counselling</option>
                                                                <option value="RNR" {% if Candidate_registration.calling_remark == "RNR" %}selected{% endif %}>RNR</option>
                                                                <option value="Switch Off" {% if Candidate_registration.calling_remark == "Switch Off" %}selected{% endif %}>Switch Off</option>
                                                                <option value="Not Intrested" {% if Candidate_registration.calling_remark == "Not Intrested" %}selected{% endif %}>Not Intrested</option>
                                                                <option value="Sharing Resume" {% if Candidate_registration.calling_remark == "Sharing Resume" %}selected{% endif %}>Sharing Resume</option>
                                                                <option value="Hold" {% if Candidate_registration.calling_remark == "Hold" %}selected{% endif %}>Hold</option>
                                                                <option value="Not Eligeble" {% if Candidate_registration.calling_remark == "Not Eligeble" %}selected{% endif %}>Not Eligeble</option>
                                                                <option value="Call Back" {% if Candidate_registration.calling_remark == "Call Back" %}selected{% endif %}>Call Back</option>
                                                                <option value="Coming Tomorrow" {% if Candidate_registration.calling_remark == "Coming Tomorrow" %}selected{% endif %}>Coming Tomorrow</option>
                                                                <option value="Busy" {% if Candidate_registration.calling_remark == "Busy" %}selected{% endif %}>Busy</option>
                                                                <option value="Not Available" {% if Candidate_registration.calling_remark == "Not Available" %}selected{% endif %}>Not Available</option>
                                                                <option value="Got a Job" {% if Candidate_registration.calling_remark == "Got a Job" %}selected{% endif %}>Got a Job</option>
                                                                <option value="Call After Some Time" {% if Candidate_registration.calling_remark == "Call After Some Time" %}selected{% endif %}>Call After Some Time</option>
                                                                <option value="No Incoming" {% if Candidate_registration.calling_remark == "No Incoming" %}selected{% endif %}>No Incoming</option>
                                                                <option value="Temporary Not Available" {% if Candidate_registration.calling_remark == "Temporary Not Available" %}selected{% endif %}>Temporary Not Available</option>
                                                                <option value="Out Of Town" {% if Candidate_registration.calling_remark == "Out Of Town" %}selected{% endif %}>Out Of Town</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-md-3">
                                                        <div class="mb-3">
                                                            <label class="form-label">Lead Status</label>
                                                            <select class="form-control form-select" name='lead_generate' >
                                                                <option value="" disabled selected>Select Status</option>
                                                                <option value="Hot" {% if candidate.lead_generate == "Hot" %}selected{% endif %}>
                                                                    Hot <span class="text-muted">(Positive prospect but pending for Conversion for Interview scheduling)</span>
                                                                </option>
                                                                <option value="Cold" {% if candidate.lead_generate == "Cold" %}selected{% endif %}>
                                                                    Cold <span class="text-muted">(Not so interested)</span>
                                                                </option>
                                                                <option value="Converted" {% if candidate.lead_generate == "Converted" %}selected{% endif %}>
                                                                    Converted <span class="text-muted">(for Scheduling Interview)</span>
                                                                </option>
                                                                <option value="Not interested" {% if candidate.lead_generate == "Not interested" %}selected{% endif %}>
                                                                    Not interested <span class="text-muted">(Looking for different Jobs/Salary Range - mention in Remarks)</span>
                                                                </option>
                                                                <option value="Connect later" {% if candidate.lead_generate == "Connect later" %}selected{% endif %}>
                                                                    Connect later <span class="text-muted">(mention Follow-up date and time)</span>
                                                                </option>
                                                                <option value="DND" {% if candidate.lead_generate == "DND" %}selected{% endif %}>
                                                                    DND <span class="text-muted">(Candidate does not want to receive calls/messages)</span>
                                                                </option>
                                                                <option value="Other" {% if candidate.lead_generate == "Other" %}selected{% endif %}>
                                                                    Other <span class="text-muted">(mention in remarks)</span>
                                                                </option>
                                                            </select>
                                                            <div class="invalid-feedback">Please select lead generate status.</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-md-3">
                                                        <div class="mb-3">
                                                            <label class="form-label">Next Follow-Up Date</label>
                                                            <input type="datetime-local" name='next_follow_up_date_time' class="form-control" 
                                                                    min="{{ today|date:'Y-m-d' }}">
                                                            <div class="invalid-feedback">Please select a valid future date.</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-md-12">
                                                        <div class="mb-3">
                                                            <label class="form-label">Remark</label>
                                                            <textarea name='remark' class="form-control" placeholder="Remark" maxlength="500"></textarea>
                                                            <small class="text-muted">Max 500 characters</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="card-footer text-end">
                                                    <button type="submit" class="btn btn-primary">Submit</button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal modal-blur fade" id="duplicateModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
            <div class="modal-content">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="modal-status bg-warning"></div>
                <div class="modal-body text-center py-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon mb-2 text-warning icon-lg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M10.25 17.25h-5.25a2 2 0 0 1 -2 -2v-9a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v3"></path>
                        <path d="M7 9h6"></path>
                        <path d="M10 3m0 1a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v1a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1z"></path>
                        <path d="M19.001 19m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0"></path>
                        <path d="M19.001 16.5v2.5h2.5"></path>
                    </svg>
                    <h3>Duplicate Found</h3>
                    <div class="text-secondary" id="duplicateMessage">The mobile number <strong id="duplicateMobileNumber"></strong> is already registered under the name of <strong id="duplicateCandidateName"></strong>.</div>
                </div>
                <div class="modal-footer">
                    <div class="w-100">
                        <div class="row">
                            <div class="col"><a href="#" class="btn w-100" data-bs-dismiss="modal">Skip</a></div>
                            <div class="col"><a href="#" class="btn btn-warning w-100" id="reviewProfileLink">Review & Edit Profile</a></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/static/dist/libs/nouislider/dist/nouislider.min.js?1692870487" defer></script>
    <script src="/static/dist/libs/litepicker/dist/litepicker.js?1692870487" defer></script>
    <script src="/static/dist/libs/tom-select/dist/js/tom-select.base.min.js?1692870487" defer></script>
    <script src="/static/dist/js/tabler.min.js?1692870487" defer></script>
    <script src="/static/dist/js/demo.min.js?1692870487" defer></script>
    
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const form = document.getElementById("candidateForm");
        const errorDiv = document.getElementById("formErrors");
        
        // Form validation
        form.addEventListener("submit", function(event) {
            event.preventDefault();
            
            // Reset error display
            errorDiv.classList.add('d-none');
            errorDiv.innerHTML = '';
            
            if (!form.checkValidity()) {
                event.stopPropagation();
                form.classList.add('was-validated');
                return;
            }
            
            // Custom validation for multi-select fields
            const multiSelectFields = ['preferred_location', 'sector', 'department'];
            let isValid = true;
            
            multiSelectFields.forEach(fieldName => {
                const field = document.querySelector(`[name="${fieldName}"]`);
                if (field && field.required && field.selectedOptions.length === 0) {
                    field.classList.add('is-invalid');
                    isValid = false;
                }
            });
            
            // Validate experience months if years are provided
            const expYears = document.querySelector('[name="experience_year"]');
            const expMonths = document.querySelector('[name="experience_month"]');
            
            if (expYears.value && !expMonths.value) {
                expMonths.setCustomValidity("Please specify months if years are provided");
                expMonths.classList.add('is-invalid');
                isValid = false;
            } else {
                expMonths.setCustomValidity("");
            }
            
            // Validate expected salary is >= current salary if both provided
            const currentSalary = document.querySelector('[name="current_salary"]');
            const expectedSalary = document.querySelector('[name="expected_salary"]');
            
            if (currentSalary.value && expectedSalary.value && 
                parseInt(expectedSalary.value) < parseInt(currentSalary.value)) {
                expectedSalary.setCustomValidity("Expected salary should be greater than or equal to current salary");
                expectedSalary.classList.add('is-invalid');
                isValid = false;
            } else {
                expectedSalary.setCustomValidity("");
            }
            
            // Validate file sizes and types
            const photo = document.querySelector('[name="candidate_photo"]');
            if (photo.files.length > 0) {
                const file = photo.files[0];
                const validTypes = ['image/jpeg', 'image/png'];
                if (!validTypes.includes(file.type)) {
                    photo.setCustomValidity("Please upload an image in JPG or PNG format");
                    photo.classList.add('is-invalid');
                    isValid = false;
                } else if (file.size > 2 * 1024 * 1024) { // 2MB
                    photo.setCustomValidity("Photo size should be less than 2MB");
                    photo.classList.add('is-invalid');
                    isValid = false;
                } else {
                    photo.setCustomValidity("");
                }
            }
            
            const resume = document.querySelector('[name="candidate_resume"]');
            if (resume.files.length > 0) {
                const file = resume.files[0];
                const validTypes = ['application/pdf', 'application/msword', 
                                    'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
                if (!validTypes.includes(file.type)) {
                    resume.setCustomValidity("Please upload a resume in PDF, DOC or DOCX format");
                    resume.classList.add('is-invalid');
                    isValid = false;
                } else if (file.size > 5 * 1024 * 1024) { // 5MB
                    resume.setCustomValidity("Resume size should be less than 5MB");
                    resume.classList.add('is-invalid');
                    isValid = false;
                } else {
                    resume.setCustomValidity("");
                }
            }
            
            if (!isValid) {
                form.classList.add('was-validated');
                return;
            }
            
            // Submit form via AJAX
            const formData = new FormData(form);
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        if (response.status === 409 && err.status === 'duplicate') {
                            throw err;
                        }
                        throw err;
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    window.location.href = data.redirect_url;
                } else {
                    console.error('Unexpected response:', data);
                }
            })
            .catch(error => {
                if (error.status === 'duplicate') {
                    const duplicateModal = new bootstrap.Modal(document.getElementById('duplicateModal'));
                    document.getElementById('duplicateMobileNumber').textContent = formData.get('candidate_mobile_number');
                    document.getElementById('duplicateCandidateName').textContent = error.candidate_name;
                    document.getElementById('reviewProfileLink').href = error.candidate_profile_url;
                    
                    duplicateModal.show();
                    
                    document.querySelector('[name="candidate_mobile_number"]').classList.remove('is-invalid');

                } else if (error.errors) {
                    // Display other errors
                    errorDiv.innerHTML = error.errors.map(err => `<div>${err}</div>`).join('');
                    errorDiv.classList.remove('d-none');
                    
                    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    if (error.errors.some(err => err.includes('Mobile number'))) {
                        const mobileField = document.querySelector('[name="candidate_mobile_number"]');
                        mobileField.classList.add('is-invalid');
                        mobileField.focus();
                    }
                    if (error.errors.some(err => err.includes('Email address'))) {
                        const emailField = document.querySelector('[name="candidate_email_address"]');
                        emailField.classList.add('is-invalid');
                        if (!document.activeElement.matches('[name="candidate_mobile_number"]')) {
                            emailField.focus();
                        }
                    }
                } else {
                    // Generic error handling
                    errorDiv.innerHTML = '<div>An unexpected error occurred. Please try again.</div>';
                    errorDiv.classList.remove('d-none');
                    console.error('Error:', error);
                }
            });
        });
        
        // Real-time validation for fields
        const fieldsToValidate = [
            'candidate_name', 'candidate_mobile_number', 'candidate_alternate_mobile_number',
            'candidate_email_address', 'experience_year', 'experience_month',
            'current_salary', 'expected_salary'
        ];
        
        fieldsToValidate.forEach(fieldName => {
            const field = document.querySelector(`[name="${fieldName}"]`);
            if (field) {
                field.addEventListener('input', function() {
                    if (field.checkValidity()) {
                        field.classList.remove('is-invalid');
                        field.classList.add('is-valid');
                    } else {
                        field.classList.remove('is-valid');
                        field.classList.add('is-invalid');
                    }
                });
            }
        });
        
        // Initialize TomSelect for multi-select fields
        if (window.TomSelect) {
            new TomSelect(document.getElementById('select-prefered-location'), {
                copyClassesToDropdown: false,
                dropdownParent: 'body',
                controlInput: '<input>',
                render: {
                    item: function(data, escape) {
                        if (data.customProperties) {
                            return '<div><span class="dropdown-item-indicator">' + data.customProperties + '</span>' + escape(data.text) + '</div>';
                        }
                        return '<div>' + escape(data.text) + '</div>';
                    },
                    option: function(data, escape) {
                        if (data.customProperties) {
                            return '<div><span class="dropdown-item-indicator">' + data.customProperties + '</span>' + escape(data.text) + '</div>';
                        }
                        return '<div>' + escape(data.text) + '</div>';
                    },
                },
                onItemAdd: function() {
                    this.control_input.checkValidity();
                }
            });
            
            new TomSelect(document.getElementById('select-sector'), {
                copyClassesToDropdown: false,
                dropdownParent: 'body',
                controlInput: '<input>',
                render: {
                    item: function(data, escape) {
                        if (data.customProperties) {
                            return '<div><span class="dropdown-item-indicator">' + data.customProperties + '</span>' + escape(data.text) + '</div>';
                        }
                        return '<div>' + escape(data.text) + '</div>';
                    },
                    option: function(data, escape) {
                        if (data.customProperties) {
                            return '<div><span class="dropdown-item-indicator">' + data.customProperties + '</span>' + escape(data.text) + '</div>';
                        }
                        return '<div>' + escape(data.text) + '</div>';
                    },
                },
                onItemAdd: function() {
                    this.control_input.checkValidity();
                }
            });
            
            new TomSelect(document.getElementById('select-department'), {
                copyClassesToDropdown: false,
                dropdownParent: 'body',
                controlInput: '<input>',
                render: {
                    item: function(data, escape) {
                        if (data.customProperties) {
                            return '<div><span class="dropdown-item-indicator">' + data.customProperties + '</span>' + escape(data.text) + '</div>';
                        }
                        return '<div>' + escape(data.text) + '</div>';
                    },
                    option: function(data, escape) {
                        if (data.customProperties) {
                            return '<div><span class="dropdown-item-indicator">' + data.customProperties + '</span>' + escape(data.text) + '</div>';
                        }
                        return '<div>' + escape(data.text) + '</div>';
                    },
                },
                onItemAdd: function() {
                    this.control_input.checkValidity();
                }
            });
        }
    });
    </script>
    
    <style>
        #formErrors {
        margin: 1rem;
        padding: 1rem;
    }

    #formErrors div {
        margin-bottom: 0.5rem;
    }

    #formErrors div:last-child {
        margin-bottom: 0;
    }
    </style>
</body>
</html>
{% endblock content %}