{% extends 'crm/base.html' %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interview Schedule Matrix</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .table-container { max-height: 75vh; overflow-y: auto; border: 1px solid #dee2e6; }
        thead th { position: sticky; top: 0; background-color: #343a40 !important; color: white; z-index: 10; }
        tbody th { position: sticky; left: 0; background-color: ; z-index: 9; border-right: 2px solid #dee2e6; }
        tfoot th, tfoot td { position: sticky; bottom: 0; background-color:  !important; z-index: 10; }
        
        .clickable-cell { cursor: pointer; transition: background 0.2s; }
        .clickable-cell:hover { background-color:  !important; }
        
        /* Header Styling */
        .company-header { font-size: 0.75rem; color: ; display: block; text-transform: uppercase; }
        .job-header { font-size: 0.9rem; display: block; font-weight: bold; }
    </style>
</head>
<body class=" p-4">
<div class="page-wrapper">
    <div class="container-xl">
    
        <div class="row mb-4 align-items-center">
            <div class="col-md-4">
                <h3 class="fw-bold mb-0">ðŸ“… Interview Schedule</h3>
                <small class="text-muted">Tracking Scheduled & Rescheduled Interviews</small>
            </div>
            <div class="col-md-8">
                <form method="GET" class="row g-2 justify-content-end">
                    <div class="col-auto">
                        <select name="date_range" class="form-select form-select-sm">
                            <option value="today" {% if selected_date == 'today' %}selected{% endif %}>Today</option>
                            <option value="week" {% if selected_date == 'week' %}selected{% endif %}>This Week</option>
                            <option value="month" {% if selected_date == 'month' %}selected{% endif %}>This Month</option>
                            <option value="year" {% if selected_date == 'year' %}selected{% endif %}>This Year</option>
                            <option value="all" {% if selected_date == 'all' %}selected{% endif %}>All Time</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <select name="employee_id" class="form-select form-select-sm">
                            <option value="">All Employees</option>
                            {% for emp in employees %}
                                <option value="{{ emp.id }}" {% if selected_emp == emp.id %}selected{% endif %}>{{ emp.first_name }} {{ emp.last_name }} ({{ emp.employee_id }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary btn-sm">Filter</button>
                        <a href="." class="btn btn-outline-secondary btn-sm">Reset</a>
                    </div>
                </form>
            </div>
        </div>

        <div class="table-container bg-white shadow-sm">
            <table class="table table-bordered table-hover mb-0 text-nowrap text-center align-middle">
                <thead>
                    <tr>
                        <th style="min-width: 100px; z-index: 20; left: 0;">Date</th>
                        {% for col_tuple in vacancy_headers %}
                            <th class="fw-normal px-3">
                                <span class="company-header">{{ col_tuple.0 }}</span>
                                <span class="job-header">{{ col_tuple.1 }}</span>
                            </th>
                        {% empty %}
                            <th>No Vacancies Found</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in matrix_rows %}
                    <tr>
                        <th scope="row" class="text-center">
                            {{ row.date|date:"d M" }}
                            <br><small class="fw-light text-muted">{{ row.date|date:"Y" }}</small>
                        </th>

                        {% for cell in row.counts %}
                            {% if cell.count > 0 %}
                                <td class="clickable-cell bg-primary-subtle text-primary fw-bold fs-6"
                                    onclick="openInterviewModal('{{ cell.date_str }}', '{{ cell.company|escapejs }}', '{{ cell.job|escapejs }}')">
                                    {{ cell.count }}
                                </td>
                            {% else %}
                                <td class="text-muted fw-light">-</td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    {% empty %}
                    <tr><td colspan="100%" class="p-5 text-muted">No data found for {{ label }}</td></tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <th class="text-center text-dark fw-bold border-end">TOTAL</th>
                        {% for total in footer_counts %}
                            <td class="fw-bold text-dark bg-light">
                                {{ total|default:"0" }}
                            </td>
                        {% endfor %}
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="mt-3 text-end">
            <span class="badge bg-dark fs-6">Grand Total Scheduled: {{ grand_total }}</span>
        </div>
    </div>
</div>

<div class="modal fade" id="interviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title">Scheduled Interviews</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Loading details...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    function openInterviewModal(dateStr, company, job) {
        // 1. Show the modal
        const myModal = new bootstrap.Modal(document.getElementById('interviewModal'));
        myModal.show();

        // 2. Set Loading State
        const contentDiv = document.getElementById('modalContent');
        contentDiv.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Loading candidates for ${company}...</p>
            </div>`;

        // 3. Fetch Data via AJAX
        const url = `{% url 'get_interview_details' %}?date=${dateStr}&company=${encodeURIComponent(company)}&job=${encodeURIComponent(job)}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                contentDiv.innerHTML = data.html;
            })
            .catch(error => {
                contentDiv.innerHTML = `<p class="text-danger text-center">Error loading data. Please try again.</p>`;
                console.error('Error:', error);
            });
    }
</script>

</body>
</html>
{% endblock content %}