{% extends 'crm/base.html' %}

{% block content %}
<div class="page-wrapper">
    <div class="page-header d-print-none">
        <div class="container-xl">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <h2 class="page-title">Candidate Management</h2>
                    <div class="text-muted mt-1">
                        <span id="total-candidates">{{ total_candidates_count }}</span> candidates found
                    </div>
                </div>
                <div class="col-auto ms-auto d-print-none">
                    <div class="btn-list">
                        <a href="{% url 'admin_candidate_registration' %}" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 7v4m0 0v4m0-4h4m-4 0H8" /><path d="M16 21v-2a4 4 0 0 0 -8 0v2" /><circle cx="12" cy="7" r="4" /></svg>
                            Add New Candidate
                        </a>
                        <a href="{% url 'download_candidates' %}" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" /><path d="M7 11l5 5l5 -5" /><path d="M12 4v12" /></svg>
                            Download Candidate Data
                        </a>
                        <a href="{% url 'admin_candidate_bulk_upload' %}" class="btn btn-primary">
                             <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" /><path d="M7 11l5 -5l5 5" /><path d="M12 6v12" /></svg>
                            Bulk Upload Candidates
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="page-body">
        <div class="container-xl">
            <div class="card">
                <div class="card-header">
                    <div class="row g-2 align-items-center w-100">
                        <div class="col-12 col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" /><path d="M21 21l-6 -6" /></svg></span>
                                <input type="text" id="searchInput" class="form-control" placeholder="Search candidates..." aria-label="Search candidates">
                            </div>
                        </div>
                        <div class="col-12 col-md-8 d-flex flex-wrap align-items-center justify-content-md-end g-2">
                            <div class="me-md-2 mb-2 mb-md-0 d-flex flex-grow-1 flex-md-grow-0">
                                <input type="date" id="dateFrom" class="form-control" title="From Date">
                            </div>
                            <div class="me-md-2 mb-2 mb-md-0 d-flex flex-grow-1 flex-md-grow-0">
                                <input type="date" id="dateTo" class="form-control" title="To Date">
                            </div>
                            <div class="filter-dropdown-container me-md-2 mb-2 mb-md-0 d-flex align-items-center flex-grow-1 flex-md-grow-0">
                                <label class="form-label mb-0 me-2 text-nowrap">Connection:</label>
                                <div class="dropdown-toggle-button" data-target="connectionStatusFilterOptions">
                                    <span id="connectionStatusSelectedCount">All</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon dropdown-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 9l4 4l4 -4" /></svg>
                                </div>
                                <div class="filter-options-pane" id="connectionStatusFilterOptions">
                                    <div class="input-icon mb-2"><input type="text" class="form-control dropdown-search-input" placeholder="Search..." data-filter-target="connectionStatusCheckboxes"><span class="input-icon-addon"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"/><path d="M21 21l-6 -6"/></svg></span></div>
                                    <label class="form-check cursor-pointer"><input class="form-check-input select-all-checkbox" type="checkbox"><span class="form-check-label font-weight-bold">All</span></label>
                                    <div id="connectionStatusCheckboxes"></div>
                                </div>
                            </div>
                            <div class="filter-dropdown-container me-md-2 mb-2 mb-md-0 d-flex align-items-center flex-grow-1 flex-md-grow-0">
                                <label class="form-label mb-0 me-2 text-nowrap">Lead Source:</label>
                                <div class="dropdown-toggle-button" data-target="leadSourceFilterOptions">
                                    <span id="leadSourceSelectedCount">All</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon dropdown-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 9l4 4l4 -4" /></svg>
                                </div>
                                <div class="filter-options-pane" id="leadSourceFilterOptions">
                                     <div class="input-icon mb-2"><input type="text" class="form-control dropdown-search-input" placeholder="Search..." data-filter-target="leadSourceCheckboxes"><span class="input-icon-addon"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"/><path d="M21 21l-6 -6"/></svg></span></div>
                                    <label class="form-check cursor-pointer"><input class="form-check-input select-all-checkbox" type="checkbox"><span class="form-check-label font-weight-bold">All</span></label>
                                    <div id="leadSourceCheckboxes"></div>
                                </div>
                            </div>
                            <div class="filter-dropdown-container me-md-2 mb-2 mb-md-0 d-flex align-items-center flex-grow-1 flex-md-grow-0">
                                <label class="form-label mb-0 me-2 text-nowrap">Employee:</label>
                                <div class="dropdown-toggle-button" data-target="employeeFilterOptions">
                                    <span id="employeeSelectedCount">All Employees</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon dropdown-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 9l4 4l4 -4" /></svg>
                                </div>
                                <div class="filter-options-pane" id="employeeFilterOptions">
                                     <div class="input-icon mb-2"><input type="text" class="form-control dropdown-search-input" placeholder="Search..." data-filter-target="employeeCheckboxes"><span class="input-icon-addon"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"/><path d="M21 21l-6 -6"/></svg></span></div>
                                    <label class="form-check cursor-pointer"><input class="form-check-input select-all-checkbox" type="checkbox"><span class="form-check-label font-weight-bold">Select All</span></label>
                                    <div id="employeeCheckboxes"></div>
                                </div>
                            </div>
                            <div class="filter-dropdown-container d-flex align-items-center flex-grow-1 flex-md-grow-0">
                                <label class="form-label mb-0 me-2 text-nowrap">Lead Status:</label>
                                <div class="dropdown-toggle-button" data-target="statusFilterOptions">
                                    <span id="statusSelectedCount">All Statuses</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon dropdown-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 9l4 4l4 -4" /></svg>
                                </div>
                                <div class="filter-options-pane" id="statusFilterOptions">
                                     <div class="input-icon mb-2"><input type="text" class="form-control dropdown-search-input" placeholder="Search..." data-filter-target="statusCheckboxes"><span class="input-icon-addon"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"/><path d="M21 21l-6 -6"/></svg></span></div>
                                    <label class="form-check cursor-pointer"><input class="form-check-input select-all-checkbox" type="checkbox"><span class="form-check-label font-weight-bold">Select All</span></label>
                                    <div id="statusCheckboxes"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive table-scrollable-body" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-vcenter table-hover table-nowrap" id="candidatesTable">
                        <thead>
                            <tr>
                                <th class="w-1">#</th>
                                <th>Connection Status</th>
                                <th>Candidate</th>
                                <th>Contact</th>
                                <th>Lead Source</th>
                                <th>Lead Status</th>
                                <th>Experience</th>
                                <th>Employee</th>
                                <th>Registered</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="candidates-tbody">
                            {% for candidate in candidates %}
                                {% include 'crm/partials/candidate_row.html' with forloop=forloop %}
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    <div id="load-more-container" class="p-4 text-center" style="display: none;">
                        <button id="load-more-btn" class="btn btn-primary">Load More Candidates</button>
                    </div>

                    <div id="loading-indicator" class="p-4 text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                    
                    <div id="no-results-message" class="p-5 text-center" style="display: none;">
                        <h4 class="text-muted">No candidates found matching your criteria.</h4>
                    </div>
                </div>

                <div class="card-footer d-flex align-items-center">
                    <div class="pagination-info">
                        Showing <span id="showingFrom">1</span> to <span id="showingTo">{{ candidates|length }}</span> of <span id="totalCount">{{ total_candidates_count }}</span> candidates
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{{ filter_options|json_script:"filter-options-data" }}

<script type="text/template" id="candidate-row-template">
    <tr data-id="{id}">
        <td>{index}</td>
        <td>{connectionBadge}</td>
        <td>
            <div class="d-flex align-items-center">
                <div class="me-3">{avatar}</div>
                <div>
                    <div class="font-weight-medium"><a href="{profile_url}" class="text-truncate profile-link">{name}</a></div>
                    <div class="text-muted small">{uniqueCode}</div>
                </div>
            </div>
        </td>
        <td><div class="text-muted">{contactInfo}</div></td>
        <td><span class="text-muted">{leadSourceDisplay}</span></td>
        <td><span class="status-badge status-{data_status}">{leadStatusDisplay}</span></td>
        <td><div class="text-muted">{experienceDisplay}</div></td>
        <td class="text-muted">{employeeName}</td>
        <td class="text-muted" title="{full_registered_time}">{registered_time}</td>
        <td class="text-center actions-cell">
            <div class="btn-list d-flex justify-content-center align-items-center flex-nowrap">
                <a href="{profile_url}" class="btn btn-sm btn-icon" title="View Profile" data-bs-toggle="tooltip"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" /><path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" /></svg></a>
                {resumeButtons}
                <button onclick="confirmDelete({id}, '{name_escaped}', '{model_type}')" class="btn btn-sm btn-icon btn-danger" title="Delete Candidate" data-bs-toggle="tooltip"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-trash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M4 7l16 0"></path><path d="M10 11l0 6"></path><path d="M14 11l0 6"></path><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"></path><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"></path></svg></button>
            </div>
        </td>
    </tr>
</script>

<style>
    .status-badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 50rem; font-size: 0.75rem; font-weight: 600; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; }
    .status-hot { background-color: rgba(253, 126, 20, 0.1); color: #fd7e14; }
    .status-converted { background-color: rgba(32, 201, 151, 0.1); color: #20c997; }
    .status-cold { background-color: rgba(250, 82, 82, 0.1); color: #fa5252; }
    .status-pending { background-color: rgba(0, 123, 255, 0.1); color: #007bff; }
    .status-selected { background-color: rgba(40, 167, 69, 0.1); color: #28a745; }
    .status-rejected { background-color: rgba(220, 53, 69, 0.1); color: #dc3545; }
    .status-not-interested { background-color: rgba(108, 117, 125, 0.1); color: #6c757d; }
    .status-connect-later { background-color: rgba(23, 162, 184, 0.1); color: #17a2b8; }
    .status-dnd { background-color: rgba(255, 193, 7, 0.1); color: #ffc107; }
    .status-other { background-color: rgba(102, 16, 242, 0.1); color: #6610f2; }
    .table-responsive.table-scrollable-body { position: relative; }
    #candidatesTable thead th { position: sticky; top: 0; background-color: var(--tblr-card-bg, white); z-index: 10; box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1); }
    .filter-dropdown-container { position: relative; width: 100%; flex-grow: 1; flex-basis: auto; }
    @media (min-width: 768px) { .filter-dropdown-container { flex-grow: 0; max-width: 200px; } }
    .dropdown-toggle-button { display: flex; align-items-center; justify-content: space-between; padding: 0.5rem 0.75rem; border: 1px solid var(--tblr-border-color); border-radius: var(--tblr-border-radius); background-color: var(--tblr-input-bg, white); color: var(--tblr-body-color); cursor: pointer; user-select: none; line-height: 1.5; transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out; }
    .dropdown-toggle-button:hover { border-color: var(--tblr-border-color-hover); }
    .dropdown-toggle-button:focus, .dropdown-toggle-button.active { border-color: var(--tblr-primary); box-shadow: var(--tblr-focus-ring-shadow); outline: 0; }
    .dropdown-icon { margin-left: 0.5rem; transition: transform 0.2s; }
    .dropdown-toggle-button.active .dropdown-icon { transform: rotate(180deg); }
    .filter-options-pane { position: absolute; top: calc(100% + 5px); left: 0; z-index: 1000; background-color: var(--tblr-card-bg, white); border: 1px solid var(--tblr-border-color); border-radius: var(--tblr-border-radius); padding: 0.75rem; box-shadow: var(--tblr-box-shadow-lg); min-width: 220px; max-height: 250px; overflow-y: auto; display: none; box-sizing: border-box; }
    .filter-options-pane.show { display: block; }
    .filter-options-pane .form-check { margin-bottom: 0.5rem; }
    .cursor-pointer { cursor: pointer; }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // --- STATE & CONFIG ---
    // MODIFIED: 'currentPage' now tracks the LAST successfully loaded page.
    // It starts at 1 because the server has already loaded page 1.
    let currentPage = 1;
    let isLoading = false;
    let currentFilters = {};
    let searchTimeout;

    // --- DOM ELEMENTS ---
    const tableBody = document.getElementById('candidates-tbody');
    const loadingIndicator = document.getElementById('loading-indicator');
    const noResultsMessage = document.getElementById('no-results-message');
    const filterOptions = JSON.parse(document.getElementById('filter-options-data').textContent);
    const rowTemplateEl = document.getElementById('candidate-row-template');
    const loadMoreContainer = document.getElementById('load-more-container');
    const loadMoreBtn = document.getElementById('load-more-btn');

    if (!rowTemplateEl) {
        console.error("Critical error: Candidate row template not found!");
        return;
    }
    const rowTemplate = rowTemplateEl.innerHTML;

    const filterSets = {
        connectionStatus: { container: document.getElementById('connectionStatusCheckboxes'), values: filterOptions.connection_statuses, countSpan: document.getElementById('connectionStatusSelectedCount'), allText: 'All' },
        leadSource: { container: document.getElementById('leadSourceCheckboxes'), values: filterOptions.lead_sources, countSpan: document.getElementById('leadSourceSelectedCount'), allText: 'All' },
        employee: { container: document.getElementById('employeeCheckboxes'), values: filterOptions.employees, countSpan: document.getElementById('employeeSelectedCount'), allText: 'All Employees' },
        status: { container: document.getElementById('statusCheckboxes'), values: filterOptions.lead_statuses, countSpan: document.getElementById('statusSelectedCount'), allText: 'All Statuses' }
    };

    // --- 1. UI INTERACTION LOGIC (Unchanged) ---
    function setupDropdownInteractions() {
        document.querySelectorAll('.dropdown-toggle-button').forEach(button => {
            button.addEventListener('click', (event) => {
                event.stopPropagation();
                const targetId = button.getAttribute('data-target');
                const targetPane = document.getElementById(targetId);
                document.querySelectorAll('.filter-options-pane').forEach(pane => {
                    if (pane !== targetPane) {
                        pane.classList.remove('show');
                        const otherButton = document.querySelector(`.dropdown-toggle-button[data-target="${pane.id}"]`);
                        if (otherButton) otherButton.classList.remove('active');
                    }
                });
                targetPane.classList.toggle('show');
                button.classList.toggle('active');
            });
        });

        document.addEventListener('click', (event) => {
            document.querySelectorAll('.filter-options-pane.show').forEach(pane => {
                if (!pane.parentElement.contains(event.target)) {
                    pane.classList.remove('show');
                    const button = document.querySelector(`.dropdown-toggle-button[data-target="${pane.id}"]`);
                    if (button) button.classList.remove('active');
                }
            });
        });

        document.querySelectorAll('.dropdown-search-input').forEach(input => {
            input.addEventListener('input', () => {
                const searchTerm = input.value.toLowerCase();
                const targetId = input.getAttribute('data-filter-target');
                const container = document.getElementById(targetId);
                container.querySelectorAll('.form-check').forEach(label => {
                    const labelText = label.querySelector('.form-check-label').textContent.toLowerCase();
                    label.style.display = labelText.includes(searchTerm) ? '' : 'none';
                });
            });
        });
    }

    // --- 2. DATA LOADING & RENDERING ---
    function createCandidateRowHTML(candidate, index) {
        const connectionStatus = candidate.call_connection ? candidate.call_connection.toLowerCase() : '';
        let badgeClass = 'bg-secondary', iconClass = 'fa-question-circle';
        if (connectionStatus === 'yes' || connectionStatus === 'connected') { badgeClass = 'bg-success'; iconClass = 'fa-check-circle'; }
        else if (connectionStatus === 'no') { badgeClass = 'bg-danger'; iconClass = 'fa-times-circle'; }
        else if (connectionStatus === 'pending') { badgeClass = 'bg-warning text-dark'; iconClass = 'fa-clock'; }
        const resumeButtons = candidate.resume_url ? `<a href="${candidate.resume_url}" target="_blank" class="btn btn-sm btn-icon" title="View Resume" data-bs-toggle="tooltip"><svg class="icon icon-tabler icon-tabler-file-text" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 3v4a1 1 0 0 0 1 1h4"/><path d="M17 21H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7l5 5v11a2 2 0 0 1-2 2z"/><path d="M9 9h1"/><path d="M9 13h6"/><path d="M9 17h6"/></svg></a><a href="${candidate.resume_url}" download class="btn btn-sm btn-icon" title="Download Resume" data-bs-toggle="tooltip"><svg class="icon icon-tabler icon-tabler-download" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2"/><path d="M7 11l5 5l5-5"/><path d="M12 4L12 16"/></svg></a>` : '';
        return rowTemplate.replace(/{index}/g, index).replace(/{id}/g, candidate.id).replace(/{connectionBadge}/g, candidate.call_connection ? `<span class="badge text-white ${badgeClass} px-3 py-1 rounded-pill text-capitalize" title="Call Connection: ${candidate.call_connection}"><i class="fa text-white ${iconClass} me-1"></i> ${candidate.call_connection}</span>` : `<span class="badge bg-secondary px-3 py-1 rounded-pill">Unknown</span>`).replace(/{avatar}/g, candidate.photo_url ? `<img src="${candidate.photo_url}" class="avatar avatar-md rounded-circle" alt="${candidate.name}">` : `<div class="avatar avatar-md rounded-circle bg-blue-lt">${candidate.name_initial}</div>`).replace(/{profile_url}/g, candidate.profile_url).replace(/{name}/g, candidate.name).replace(/{uniqueCode}/g, candidate.lead_source === 'EVMS' ? `<code>${candidate.refer_code}-${candidate.unique_id}</code>` : `<code>${candidate.unique_code}</code>`).replace(/{contactInfo}/g, `<a href="tel:${candidate.mobile}" class="text-reset d-block">${candidate.mobile}</a>${candidate.email ? `<a href="mailto:${candidate.email}" class="text-reset d-block small text-truncate" style="max-width: 150px;">${candidate.email}</a>` : ''}`).replace(/{leadSourceDisplay}/g, candidate.lead_source === 'Other' && candidate.other_lead_source ? candidate.other_lead_source : (candidate.lead_source || '-')).replace(/{data_status}/g, candidate.data_status).replace(/{leadStatusDisplay}/g, candidate.lead_status === 'Other' && candidate.other_lead_status ? candidate.other_lead_status : (candidate.lead_status || '-')).replace(/{experienceDisplay}/g, candidate.experience_year || candidate.experience_month ? `${candidate.experience_year || 0}y ${candidate.experience_month || 0}m` : 'Fresher').replace(/{employeeName}/g, candidate.employee_name || "Unassigned").replace(/{full_registered_time}/g, candidate.full_registered_time).replace(/{registered_time}/g, candidate.registered_time).replace(/{resumeButtons}/g, resumeButtons).replace(/{name_escaped}/g, candidate.name.replace(/'/g, "\\'")).replace(/{model_type}/g, candidate.model_type);
    }

    function loadCandidates() {
        if (isLoading) return Promise.resolve();
        isLoading = true;
        
        loadMoreContainer.style.display = 'none';
        loadingIndicator.style.display = 'block';
        noResultsMessage.style.display = 'none';

        // MODIFIED: We always request the NEXT page after the one we've loaded.
        const pageToFetch = currentPage + 1;
        const params = new URLSearchParams({ page: pageToFetch, ...currentFilters });

        return fetch(`/crm/api/get-candidates/?${params.toString()}`)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                // This checks for the very first load of a filtered set.
                if (pageToFetch === 1 && data.candidates.length === 0) {
                    noResultsMessage.style.display = 'block';
                }
                let currentCount = tableBody.rows.length;
                const newRowsHTML = data.candidates.map(c => createCandidateRowHTML(c, ++currentCount)).join('');
                tableBody.insertAdjacentHTML('beforeend', newRowsHTML);
                
                // MODIFIED: We successfully loaded a page, so we update our counter.
                currentPage = pageToFetch;

                if (data.has_next) {
                    loadMoreContainer.style.display = 'block';
                }

                document.getElementById('showingTo').textContent = tableBody.rows.length;
                document.getElementById('totalCount').textContent = data.total_count;
                document.getElementById('total-candidates').textContent = data.total_count;
                document.getElementById('showingFrom').textContent = tableBody.rows.length > 0 ? '1' : '0';
            })
            .catch(error => {
                console.error("Failed to load candidates:", error);
                const totalRows = tableBody.rows.length;
                const totalCount = parseInt(document.getElementById('totalCount').textContent, 10);
                if(totalRows < totalCount) loadMoreContainer.style.display = 'block';
            })
            .finally(() => {
                isLoading = false;
                loadingIndicator.style.display = 'none';
            });
    }

    // --- 3. FILTERING LOGIC ---
    function applyFilters() {
        const filters = {};
        filters.search = document.getElementById('searchInput').value.trim();
        filters.dateFrom = document.getElementById('dateFrom').value;
        filters.dateTo = document.getElementById('dateTo').value;
        for (const key in filterSets) {
            const selected = Array.from(filterSets[key].container.querySelectorAll('.filter-checkbox:checked')).map(cb => cb.value);
            if (selected.length > 0) filters[key] = selected.join(',');
        }
        
        currentFilters = Object.fromEntries(Object.entries(filters).filter(([_, v]) => v));
        tableBody.innerHTML = '';
        
        // MODIFIED: Reset to 0, because we haven't loaded any pages for this new filter set yet.
        currentPage = 0;
        loadCandidates();
    }

    function setupFilterCheckboxes() {
        for (const key in filterSets) { const config = filterSets[key]; config.values.forEach(value => { const label = document.createElement('label'); label.className = 'form-check cursor-pointer'; label.innerHTML = `<input class="form-check-input filter-checkbox" type="checkbox" value="${value}"><span class="form-check-label">${value}</span>`; config.container.appendChild(label); }); } document.querySelectorAll('.filter-checkbox').forEach(el => { el.addEventListener('change', () => { const parentPane = el.closest('.filter-options-pane'); const key = Object.keys(filterSets).find(k => filterSets[k].container.parentElement === parentPane); updateSelectedCount(key); applyFilters(); }); }); document.querySelectorAll('.select-all-checkbox').forEach(el => { el.addEventListener('change', (e) => { const pane = e.target.closest('.filter-options-pane'); pane.querySelectorAll('.filter-checkbox:not([style*="display: none"])').forEach(cb => cb.checked = e.target.checked); const key = Object.keys(filterSets).find(k => filterSets[k].container.parentElement === pane); updateSelectedCount(key); applyFilters(); }); });
        function updateSelectedCount(key) { const config = filterSets[key]; const checkedCount = config.container.querySelectorAll('.filter-checkbox:checked').length; const totalCount = config.values.length; if (checkedCount === 0 || checkedCount === totalCount) { config.countSpan.textContent = config.allText; } else { config.countSpan.textContent = `${checkedCount} selected`; } }
    }
    
    // --- 4. INITIALIZATION ---
    setupDropdownInteractions();
    setupFilterCheckboxes();
    
    loadMoreBtn.addEventListener('click', loadCandidates);

    document.getElementById('searchInput').addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(applyFilters, 300);
    });
    document.getElementById('dateFrom').addEventListener('change', applyFilters);
    document.getElementById('dateTo').addEventListener('change', applyFilters);

    function checkInitialLoad() {
        const initialCount = tableBody.rows.length;
        const totalCount = parseInt(document.getElementById('totalCount').textContent, 10);
        if (initialCount > 0 && initialCount < totalCount) {
            loadMoreContainer.style.display = 'block';
        } else {
            loadMoreContainer.style.display = 'none';
        }
    }
    checkInitialLoad();
});

function confirmDelete(candidateId, candidateName, modelType) {
    if (confirm(`Are you sure you want to delete candidate "${candidateName}"? This action cannot be undone.`)) {
        window.location.href = `/crm/candidate/${candidateId}/${modelType}/delete/`;
    }
}
</script> 
{% endblock content %}