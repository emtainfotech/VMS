{% extends 'crm/base.html' %}

{% block content %}
<div class="page-wrapper">
    <div class="page-header d-print-none">
        <div class="container-xl">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <h2 class="page-title">Candidate Management</h2>
                    <div class="text-muted mt-1">
                        <span id="total-candidates">{{ total_candidates_count }}</span> candidates found
                    </div>
                </div>
                <div class="col-auto ms-auto d-print-none">
                    <div class="btn-list">
                        <a href="{% url 'admin_candidate_registration' %}" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 5l0 14" /><path d="M5 12l14 0" /></svg>
                            Add New Candidate
                        </a>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#downloadFilterModal">
    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-download" width="24" height="24" viewBox="0 0 24" 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" /><path d="M7 11l5 5l5 -5" /><path d="M12 4l0 12" /></svg>
    Download Candidate Data
</button>
                        <a href="{% url 'admin_candidate_bulk_upload' %}" class="btn btn-primary">
                             <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-upload" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" /><path d="M7 9l5 -5l5 5" /><path d="M12 4l0 12" /></svg>
                            Bulk Upload Candidates
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal modal-blur fade" id="downloadFilterModal" tabindex="-1" role="dialog" aria-labelledby="downloadModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="downloadModalLabel">Filter and Download Candidate Data</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="{% url 'download_candidates' %}" method="GET">
        <div class="modal-body">
          <p class="text-muted">Select your criteria to download a customized report. Leave fields blank to include all.</p>
          
          <div class="mb-3">
            <label class="form-label">Employee Name</label>
            <select name="employee_name" class="form-select">
              <option value="">All Employees</option>
              {% for employee in employees %}
                <option value="{{ employee.first_name }} {{ employee.last_name }} ({{ employee.user.username }})">
                  {{ employee.first_name }} {{ employee.last_name }} ({{ employee.user.username }})
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Start Date (Registration)</label>
              <input type="date" name="start_date" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">End Date (Registration)</label>
              <input type="date" name="end_date" class="form-control">
            </div>
          </div>  
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-download" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" /><path d="M7 11l5 5l5 -5" /><path d="M12 4l0 12" /></svg>
            Download Filtered Data
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="successModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon mb-2 text-green icon-lg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path><path d="M9 12l2 2l4 -4"></path></svg>
        <h3>Download Started</h3>
        <div class="text-muted">Your file is being downloaded.</div>
      </div>
      <div class="modal-footer">
        <div class="w-100">
            <a href="#" class="btn btn-primary w-100" data-bs-dismiss="modal">
              Close
            </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const filterForm = document.querySelector('#downloadFilterModal form');
    const filterModalEl = document.getElementById('downloadFilterModal');
    const successModalEl = document.getElementById('successModal');

    // Create Bootstrap Modal instances
    const filterModal = new bootstrap.Modal(filterModalEl);
    const successModal = new bootstrap.Modal(successModalEl);

    filterForm.addEventListener('submit', function (event) {
        // 1. Prevent the default form submission
        event.preventDefault();

        const formData = new FormData(filterForm);
        const params = new URLSearchParams(formData).toString();
        
        // 2. The URL for downloading the data
        const downloadUrl = filterForm.action + '?' + params;
        
        // 3. Manually trigger the download
        const tempLink = document.createElement('a');
        tempLink.href = downloadUrl;
        tempLink.setAttribute('download', 'candidates_data.csv');
        document.body.appendChild(tempLink);
        tempLink.click();
        document.body.removeChild(tempLink);

        // 4. Close the filter modal
        filterModal.hide();

        // 5. Show the success modal
        successModal.show();
    });
});
</script>

    <div class="page-body">
        <div class="container-xl">
            <div class="card">
                <div class="card-header">
                    <div class="row g-2 align-items-center w-100">
                        <div class="col-12 col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" /><path d="M21 21l-6 -6" /></svg></span>
                                <input type="text" id="searchInput" class="form-control" placeholder="Search candidates..." aria-label="Search candidates">
                            </div>
                        </div>
                        <div class="col-12 col-md-8 d-flex justify-content-md-end">
                            <div class="btn-list">
                                <button id="clearAllFiltersBtn" class="btn btn-light" style="display: none;">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-filter-off" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M3 3l18 18"></path><path d="M8.5 8.5c.337 -1.33 .944 -2.528 1.772 -3.5h3.456a1 1 0 0 1 .8 1.6l-2.4 2.9a1 1 0 0 0 0 1l.594 .742m2.053 2.566l2.353 2.942a1 1 0 0 1 -.8 1.6h-12a1 1 0 0 1 -.8 -1.6l2.4 -2.9a1 1 0 0 0 0 -1l-2.4 -2.9a1 1 0 0 1 .8 -1.6h2.31"></path></svg>
                                    Clear Filters
                                </button>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#filterModal">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4h16v2.172a2 2 0 0 1 -.586 1.414l-4.414 4.414v7l-6 2v-8.5l-4.414 -4.414a2 2 0 0 1 -.586 -1.414v-2.172z" /></svg>
                                    Filter
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive table-scrollable-body" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-vcenter table-hover table-nowrap" id="candidatesTable">
                        <thead>
                            <tr>
                                <th class="w-1"><input class="form-check-input m-0 align-middle" type="checkbox" id="selectAllCheckbox" aria-label="Select all candidates"></th>
                                <th class="w-1">#</th>
                                <th>Connection Status</th>
                                <th>Candidate</th>
                                <th>Contact</th>
                                <th>Lead Source</th>
                                <th>Lead Status</th>
                                <th>Experience</th>
                                <th>Employee</th>
                                <th>Registered</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="candidates-tbody">
                            {% for candidate in candidates %}
                                {% include 'crm/partials/candidate_row.html' with forloop=forloop %}
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    <div id="load-more-container" class="p-4 text-center" style="display: none;">
                        <button id="load-more-btn" class="btn btn-primary">Load More Candidates</button>
                    </div>

                    <div id="loading-indicator" class="p-4 text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                    
                    <div id="no-results-message" class="p-5 text-center" style="display: none;">
                        <h4 class="text-muted">No candidates found matching your criteria.</h4>
                    </div>
                </div>

                <div class="card-footer d-flex align-items-center">
                    <div class="pagination-info">
                        Showing <span id="showingFrom">1</span> to <span id="showingTo">{{ candidates|length }}</span> of <span id="totalCount">{{ total_candidates_count }}</span> candidates
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions Bar -->
<div id="bulk-actions-bar" class="bulk-actions-bar">
    <div class="container-xl d-flex justify-content-between align-items-center h-100">
        <div>
            <span id="selected-count" class="fw-bold">0</span> candidates selected
        </div>
        <div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#assignModal">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" /><path d="M6 21v-2a4 4 0 0 1 4 -4h4" /><path d="M15 19l2 2l4 -4" /></svg>
                Assign Selected
            </button>
        </div>
    </div>
</div>

<!-- Assignment Modal -->
<div class="modal" id="assignModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Candidates</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Assign <strong id="assign-modal-count">0</strong> selected candidates to:</p>
                <div class="form-group">
                    <label for="employee-select" class="form-label">Employee</label>
                    <select class="form-select" id="employee-select">
                        <option value="">-- Select an Employee --</option>
                        {% for employee in all_employees %}
                            <option value="{{ employee.id }}">{{ employee.first_name }} {{ employee.last_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn me-auto" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAssignmentBtn">Confirm Assignment</button>
            </div>
        </div>
    </div>
</div>


<!-- Filter Modal -->
<div class="modal" id="filterModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Filter Candidates</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6 col-lg-3">
                        <label for="dateFrom" class="form-label">Date From</label>
                        <input type="date" id="dateFrom" class="form-control" title="From Date">
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <label for="dateTo" class="form-label">Date To</label>
                        <input type="date" id="dateTo" class="form-control" title="To Date">
                    </div>
                </div>
                <hr>
                <div class="row g-3">
                    <div class="col-md-6 col-lg-3">
                        <label class="form-label">Connection Status</label>
                        <div class="filter-options-pane-modal" id="connectionStatusFilterOptions">
                           <div class="input-icon mb-2"><input type="text" class="form-control dropdown-search-input" placeholder="Search..." data-filter-target="connectionStatusCheckboxes"><span class="input-icon-addon"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"/><path d="M21 21l-6 -6"/></svg></span></div>
                           <label class="form-check cursor-pointer"><input class="form-check-input select-all-checkbox" type="checkbox"><span class="form-check-label font-weight-bold">Select All</span></label>
                           <div id="connectionStatusCheckboxes"></div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <label class="form-label">Lead Source</label>
                        <div class="filter-options-pane-modal" id="leadSourceFilterOptions">
                             <div class="input-icon mb-2"><input type="text" class="form-control dropdown-search-input" placeholder="Search..." data-filter-target="leadSourceCheckboxes"><span class="input-icon-addon"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"/><path d="M21 21l-6 -6"/></svg></span></div>
                             <label class="form-check cursor-pointer"><input class="form-check-input select-all-checkbox" type="checkbox"><span class="form-check-label font-weight-bold">Select All</span></label>
                             <div id="leadSourceCheckboxes"></div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <label class="form-label">Employee</label>
                        <div class="filter-options-pane-modal" id="employeeFilterOptions">
                             <div class="input-icon mb-2"><input type="text" class="form-control dropdown-search-input" placeholder="Search..." data-filter-target="employeeCheckboxes"><span class="input-icon-addon"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"/><path d="M21 21l-6 -6"/></svg></span></div>
                             <label class="form-check cursor-pointer"><input class="form-check-input select-all-checkbox" type="checkbox"><span class="form-check-label font-weight-bold">Select All</span></label>
                             <div id="employeeCheckboxes"></div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <label class="form-label">Lead Status</label>
                        <div class="filter-options-pane-modal" id="statusFilterOptions">
                           <div class="input-icon mb-2"><input type="text" class="form-control dropdown-search-input" placeholder="Search..." data-filter-target="statusCheckboxes"><span class="input-icon-addon"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"/><path d="M21 21l-6 -6"/></svg></span></div>
                           <label class="form-check cursor-pointer"><input class="form-check-input select-all-checkbox" type="checkbox"><span class="form-check-label font-weight-bold">Select All</span></label>
                           <div id="statusCheckboxes"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn me-auto" id="modalClearFiltersBtn">Clear Filters</button>
                <button type="button" class="btn btn-primary" id="modalApplyFiltersBtn" data-bs-dismiss="modal">Apply Filters</button>
            </div>
        </div>
    </div>
</div>

{{ filter_options|json_script:"filter-options-data" }}

<!-- JAVASCRIPT TEMPLATE FOR CANDIDATE ROWS -->
<script type="text/template" id="candidate-row-template">
    <tr data-id="{id}">
        <td><input class="form-check-input m-0 align-middle candidate-checkbox" type="checkbox" data-id="{id}" data-model-type="{model_type}"></td>
        <td>{index}</td>
        <td>{connectionBadge}</td>
        <td>
            <div class="d-flex align-items-center">
                <div class="me-3">{avatar}</div>
                <div>
                    <div class="font-weight-medium"><a href="{profile_url}" class="text-truncate profile-link">{name}</a></div>
                    <div class="text-muted small">{uniqueCode}</div>
                </div>
            </div>
        </td>
        <td><div class="text-muted">{contactInfo}</div></td>
        <td><span class="text-muted">{leadSourceDisplay}</span></td>
        <td><span class="status-badge status-{data_status}">{leadStatusDisplay}</span></td>
        <td><div class="text-muted">{experienceDisplay}</div></td>
        <td class="text-muted">{employeeName}</td>
        <td class="text-muted" title="{full_registered_time}">{registered_time}</td>
        <td class="text-center actions-cell">{actions}</td>
    </tr>
</script>

<style>
    .status-badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 50rem; font-size: 0.75rem; font-weight: 600; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; }
    .status-hot { background-color: rgba(253, 126, 20, 0.1); color: #fd7e14; }
    .status-converted { background-color: rgba(32, 201, 151, 0.1); color: #20c997; }
    .status-cold { background-color: rgba(250, 82, 82, 0.1); color: #fa5252; }
    .status-pending { background-color: rgba(0, 123, 255, 0.1); color: #007bff; }
    .status-selected { background-color: rgba(40, 167, 69, 0.1); color: #28a745; }
    .status-rejected { background-color: rgba(220, 53, 69, 0.1); color: #dc3545; }
    .status-not-interested { background-color: rgba(108, 117, 125, 0.1); color: #6c757d; }
    .status-connect-later { background-color: rgba(23, 162, 184, 0.1); color: #17a2b8; }
    .status-dnd { background-color: rgba(255, 193, 7, 0.1); color: #ffc107; }
    .status-unknown { background-color: rgba(108, 117, 125, 0.1); color: #6c757d; }
    .status-other { background-color: rgba(102, 16, 242, 0.1); color: #6610f2; }
    .table-responsive.table-scrollable-body { position: relative; }
    #candidatesTable thead th { position: sticky; top: 0; background-color: var(--tblr-card-bg, white); z-index: 10; box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1); }
    .filter-options-pane-modal { max-height: 250px; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; border-radius: 4px; }
    .cursor-pointer { cursor: pointer; }

    .bulk-actions-bar {
        position: fixed;
        bottom: -100px; /* Start hidden */
        left: 0;
        width: 100%;
        height: 60px;
        background-color: var(--tblr-card-bg, white);
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1050;
        transition: bottom 0.3s ease-in-out;
    }

    .bulk-actions-bar.show {
        bottom: 0;
    }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // --- STATE & CONFIG ---
    let currentPage = 0;
    let isLoading = false;
    let searchTimeout;
    const FILTERS_STORAGE_KEY = 'adminCandidateFilters';
    let selectedCandidates = new Map();

    // --- DOM ELEMENTS ---
    const tableBody = document.getElementById('candidates-tbody');
    const loadingIndicator = document.getElementById('loading-indicator');
    const noResultsMessage = document.getElementById('no-results-message');
    const filterOptions = JSON.parse(document.getElementById('filter-options-data').textContent);
    const rowTemplateEl = document.getElementById('candidate-row-template');
    const loadMoreContainer = document.getElementById('load-more-container');
    const loadMoreBtn = document.getElementById('load-more-btn');
    const searchInput = document.getElementById('searchInput');
    const dateFromInput = document.getElementById('dateFrom');
    const dateToInput = document.getElementById('dateTo');
    const modalApplyBtn = document.getElementById('modalApplyFiltersBtn');
    const modalClearBtn = document.getElementById('modalClearFiltersBtn');
    const clearAllFiltersBtn = document.getElementById('clearAllFiltersBtn');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const bulkActionsBar = document.getElementById('bulk-actions-bar');
    const selectedCountSpan = document.getElementById('selected-count');
    const assignModalCountSpan = document.getElementById('assign-modal-count');
    const employeeSelect = document.getElementById('employee-select');
    const confirmAssignmentBtn = document.getElementById('confirmAssignmentBtn');
    const filterSets = {
        connectionStatus: { container: document.getElementById('connectionStatusCheckboxes'), values: filterOptions.connection_statuses },
        leadSource: { container: document.getElementById('leadSourceCheckboxes'), values: filterOptions.lead_sources },
        employee: { container: document.getElementById('employeeCheckboxes'), values: filterOptions.employees },
        status: { container: document.getElementById('statusCheckboxes'), values: filterOptions.lead_statuses }
    };

    if (!rowTemplateEl) {
        console.error("Critical error: Candidate row template not found!");
        return;
    }
    const rowTemplate = rowTemplateEl.innerHTML;

    // --- BULK ASSIGNMENT ---
    function updateBulkActionsUI() {
        const count = selectedCandidates.size;
        selectedCountSpan.textContent = count;
        assignModalCountSpan.textContent = count;
        bulkActionsBar.classList.toggle('show', count > 0);
        
        const visibleCheckboxes = tableBody.querySelectorAll('.candidate-checkbox').length;
        if (visibleCheckboxes > 0) {
            selectAllCheckbox.checked = count === visibleCheckboxes;
            selectAllCheckbox.indeterminate = count > 0 && count < visibleCheckboxes;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        }
    }
    
    function handleCheckboxChange(checkbox) {
        const id = checkbox.dataset.id;
        const modelType = checkbox.dataset.modelType;
        const key = `${id}_${modelType}`;
        if (checkbox.checked) {
            selectedCandidates.set(key, { id: id, model_type: modelType });
        } else {
            selectedCandidates.delete(key);
        }
        updateBulkActionsUI();
    }

    // --- FILTERS & LOCAL STORAGE ---
    function saveFiltersToStorage() {
        const filters = {
            search: searchInput.value.trim(),
            dateFrom: dateFromInput.value,
            dateTo: dateToInput.value,
        };
        for (const key in filterSets) {
            filters[key] = Array.from(filterSets[key].container.querySelectorAll('.filter-checkbox:checked')).map(cb => cb.value);
        }
        localStorage.setItem(FILTERS_STORAGE_KEY, JSON.stringify(filters));
        updateClearAllButtonVisibility();
    }

    function loadFiltersFromStorage() {
        const savedFilters = JSON.parse(localStorage.getItem(FILTERS_STORAGE_KEY) || '{}');
        searchInput.value = savedFilters.search || '';
        dateFromInput.value = savedFilters.dateFrom || '';
        dateToInput.value = savedFilters.dateTo || '';

        for (const key in filterSets) {
            const values = savedFilters[key] || [];
            if (values.length > 0) {
                filterSets[key].container.querySelectorAll('.filter-checkbox').forEach(cb => {
                    cb.checked = values.includes(cb.value);
                });
            }
        }
        updateAllCountsAndCheckboxes();
        updateClearAllButtonVisibility();
    }
    
    function clearAllFilters() {
        localStorage.removeItem(FILTERS_STORAGE_KEY);
        searchInput.value = '';
        dateFromInput.value = '';
        dateToInput.value = '';
        for (const key in filterSets) {
            filterSets[key].container.closest('.filter-options-pane-modal')
                .querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        }
        updateAllCountsAndCheckboxes();
        applyFilters();
    }

    function updateClearAllButtonVisibility() {
        const savedFilters = JSON.parse(localStorage.getItem(FILTERS_STORAGE_KEY) || '{}');
        let isFilterApplied = Object.values(savedFilters).some(val => Array.isArray(val) ? val.length > 0 : val);
        clearAllFiltersBtn.style.display = isFilterApplied ? 'inline-flex' : 'none';
    }
    
    function setupFilterCheckboxes() {
        for (const key in filterSets) {
            const config = filterSets[key];
            if (!config.container) continue;
            config.values.forEach(value => {
                const label = document.createElement('label');
                label.className = 'form-check cursor-pointer';
                label.innerHTML = `<input class="form-check-input filter-checkbox" type="checkbox" value="${value}"><span class="form-check-label">${value}</span>`;
                config.container.appendChild(label);
            });
        }
    }
    
    function updateSelectAllCheckbox(pane) {
        const checkboxes = pane.querySelectorAll('.filter-checkbox');
        const checkedCount = pane.querySelectorAll('.filter-checkbox:checked').length;
        const selectAll = pane.querySelector('.select-all-checkbox');
        if (!selectAll) return;
        if (checkedCount === 0) {
            selectAll.checked = false;
            selectAll.indeterminate = false;
        } else if (checkedCount === checkboxes.length) {
            selectAll.checked = true;
            selectAll.indeterminate = false;
        } else {
            selectAll.checked = false;
            selectAll.indeterminate = true;
        }
    }
    
    function updateAllCountsAndCheckboxes() {
        document.querySelectorAll('.filter-options-pane-modal').forEach(pane => {
            updateSelectAllCheckbox(pane);
        });
    }

    // --- DATA LOADING & RENDERING ---
    function createCandidateRowHTML(candidate, index) {
        const connectionBadge = candidate.call_connection 
            ? `<span class="badge text-white ${getConnectionBadgeClass(candidate.call_connection)} px-3 py-1 rounded-pill text-capitalize">${candidate.call_connection}</span>`
            : `<span class="badge bg-secondary px-3 py-1 rounded-pill">Unknown</span>`;

        const avatar = candidate.photo_url ? `<img src="${candidate.photo_url}" class="avatar avatar-md rounded-circle" alt="${candidate.name}">` : `<div class="avatar avatar-md rounded-circle bg-blue-lt">${candidate.name_initial}</div>`;
        const uniqueCode = candidate.lead_source === 'EVMS' ? `<code>${candidate.refer_code}-${candidate.unique_id}</code>` : `<code>${candidate.unique_code}</code>`;
        let contactInfo = `<a href="tel:${candidate.mobile}" class="text-reset d-block">${candidate.mobile}</a>`;
        if (candidate.email) contactInfo += `<a href="mailto:${candidate.email}" class="text-reset d-block small text-truncate" style="max-width: 150px;">${candidate.email}</a>`;
        
        const leadSourceDisplay = candidate.lead_source === 'Other' && candidate.other_lead_source ? candidate.other_lead_source : (candidate.lead_source || '-');
        const leadStatusDisplay = candidate.lead_status === 'Other' && candidate.other_lead_status ? candidate.other_lead_status : (candidate.lead_status || '-');
        const experienceDisplay = (candidate.experience_year || candidate.experience_month) ? `${candidate.experience_year || 0}y ${candidate.experience_month || 0}m` : 'Fresher';
        const nameEscaped = candidate.name.replace(/'/g, "\\'");
        
        let actions = `<div class="btn-list d-flex justify-content-center align-items-center flex-nowrap"><a href="${candidate.profile_url}" class="btn btn-sm btn-icon" title="View Profile" data-bs-toggle="tooltip"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" /><path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" /></svg></a>`;
        if (candidate.resume_url) {
            actions += `<a href="${candidate.resume_url}" target="_blank" class="btn btn-sm btn-icon" title="View Resume" data-bs-toggle="tooltip"><svg class="icon icon-tabler icon-tabler-file-text" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 3v4a1 1 0 0 0 1 1h4"/><path d="M17 21H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7l5 5v11a2 2 0 0 1-2 2z"/><path d="M9 9h1"/><path d="M9 13h6"/><path d="M9 17h6"/></svg></a><a href="${candidate.resume_url}" download class="btn btn-sm btn-icon" title="Download Resume" data-bs-toggle="tooltip"><svg class="icon icon-tabler icon-tabler-download" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2"/><path d="M7 11l5 5l5-5"/><path d="M12 4L12 16"/></svg></a>`;
        }
        actions += `<button onclick="confirmDelete('${candidate.id}', '${nameEscaped}', '${candidate.model_type}')" class="btn btn-sm btn-icon btn-danger" title="Delete Candidate" data-bs-toggle="tooltip"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-trash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M4 7l16 0"></path><path d="M10 11l0 6"></path><path d="M14 11l0 6"></path><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"></path><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"></path></svg></button></div>`;

        return rowTemplate.replace(/{id}/g, candidate.id).replace(/{model_type}/g, candidate.model_type).replace('{index}', index).replace('{connectionBadge}', connectionBadge).replace('{avatar}', avatar).replace('{profile_url}', candidate.profile_url).replace(/{name}/g, candidate.name).replace('{uniqueCode}', uniqueCode).replace('{contactInfo}', contactInfo).replace('{leadSourceDisplay}', leadSourceDisplay).replace('{data_status}', candidate.data_status).replace('{leadStatusDisplay}', leadStatusDisplay).replace('{experienceDisplay}', experienceDisplay).replace('{employeeName}', candidate.employee_name || "Unassigned").replace('{full_registered_time}', candidate.full_registered_time).replace('{registered_time}', candidate.registered_time).replace('{actions}', actions);
    }

    function getConnectionBadgeClass(status) {
        const s = status.toLowerCase();
        if (s === 'yes' || s === 'connected') return 'bg-success';
        if (s === 'no') return 'bg-danger';
        if (s === 'pending') return 'bg-warning text-dark';
        return 'bg-secondary';
    }

    function loadCandidates() {
        if (isLoading) return;
        isLoading = true;
        loadMoreContainer.style.display = 'none';
        loadingIndicator.style.display = 'block';
        if (currentPage === 0) noResultsMessage.style.display = 'none';

        const pageToFetch = currentPage + 1;
        const savedFilters = JSON.parse(localStorage.getItem(FILTERS_STORAGE_KEY) || '{}');
        const currentFilters = {};
        if (savedFilters.search) currentFilters.search = savedFilters.search;
        if (savedFilters.dateFrom) currentFilters.dateFrom = savedFilters.dateFrom;
        if (savedFilters.dateTo) currentFilters.dateTo = savedFilters.dateTo;
        Object.keys(savedFilters).forEach(key => {
            if (Array.isArray(savedFilters[key]) && savedFilters[key].length > 0) currentFilters[key] = savedFilters[key].join(',');
        });
        
        const params = new URLSearchParams({ page: pageToFetch, ...currentFilters });
        
        fetch(`/crm/api/get-candidates/?${params.toString()}`)
            .then(response => response.ok ? response.json() : Promise.reject(`HTTP error! status: ${response.status}`))
            .then(data => {
                if (pageToFetch === 1 && data.candidates.length === 0) noResultsMessage.style.display = 'block';
                let currentCount = tableBody.rows.length;
                const newRowsHTML = data.candidates.map(c => createCandidateRowHTML(c, ++currentCount)).join('');
                tableBody.insertAdjacentHTML('beforeend', newRowsHTML);
                currentPage = pageToFetch;
                loadMoreContainer.style.display = data.has_next ? 'block' : 'none';
                document.getElementById('showingTo').textContent = tableBody.rows.length;
                document.getElementById('totalCount').textContent = data.total_count;
                document.getElementById('total-candidates').textContent = data.total_count;
                document.getElementById('showingFrom').textContent = tableBody.rows.length > 0 ? '1' : '0';
            })
            .catch(error => console.error("Failed to load candidates:", error))
            .finally(() => {
                isLoading = false;
                loadingIndicator.style.display = 'none';
            });
    }

    function applyFilters() {
        selectedCandidates.clear();
        updateBulkActionsUI();
        saveFiltersToStorage();
        tableBody.innerHTML = '';
        currentPage = 0;
        loadCandidates();
    }
    
    // --- INITIALIZATION & EVENT LISTENERS ---
    function initializeEventListeners() {
        loadMoreBtn.addEventListener('click', loadCandidates);
        modalApplyBtn.addEventListener('click', applyFilters);
        clearAllFiltersBtn.addEventListener('click', clearAllFilters);
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applyFilters, 500);
        });
        modalClearBtn.addEventListener('click', () => {
            dateFromInput.value = '';
            dateToInput.value = '';
            document.querySelectorAll('.filter-options-pane-modal').forEach(pane => {
                pane.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                updateSelectAllCheckbox(pane);
            });
        });
        document.querySelectorAll('.dropdown-search-input').forEach(input => {
            input.addEventListener('input', () => {
                const searchTerm = input.value.toLowerCase();
                const targetId = input.getAttribute('data-filter-target');
                document.getElementById(targetId).querySelectorAll('.form-check').forEach(label => {
                    label.style.display = label.querySelector('.form-check-label').textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
                });
            });
        });
        document.querySelectorAll('.select-all-checkbox').forEach(el => {
            el.addEventListener('change', (e) => {
                const pane = e.target.closest('.filter-options-pane-modal');
                pane.querySelectorAll('.filter-checkbox:not([style*="display: none"])').forEach(cb => cb.checked = e.target.checked);
            });
        });
        document.querySelectorAll('.filter-options-pane-modal').forEach(pane => {
            pane.addEventListener('change', e => {
                if (e.target.classList.contains('filter-checkbox')) {
                    updateSelectAllCheckbox(pane);
                }
            });
        });
        confirmAssignmentBtn.addEventListener('click', () => {
            const employeeId = employeeSelect.value;
            if (!employeeId) {
                alert('Please select an employee.');
                return;
            }
            fetch("{% url 'bulk_assign_candidates_api' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({
                    candidates: Array.from(selectedCandidates.values()),
                    employee_id: employeeId,
                }),
            }).then(response => response.json()).then(data => {
                alert(data.status === 'success' ? data.message : 'Error: ' + data.message);
                if (data.status === 'success') {
                    bootstrap.Modal.getInstance(document.getElementById('assignModal')).hide();
                    applyFilters();
                }
            }).catch(error => console.error('Assignment Error:', error));
        });
        
        // ** FIX FOR SELECT ALL CHECKBOX **
        selectAllCheckbox.addEventListener('change', () => {
            const isChecked = selectAllCheckbox.checked;
            tableBody.querySelectorAll('.candidate-checkbox').forEach(checkbox => {
                // Only change state if it's different, to avoid unnecessary handleCheckboxChange calls
                if (checkbox.checked !== isChecked) {
                    checkbox.checked = isChecked;
                    handleCheckboxChange(checkbox);
                }
            });
            // A final single UI update after the loop
            updateBulkActionsUI();
        });

        tableBody.addEventListener('change', e => {
            if (e.target.classList.contains('candidate-checkbox')) {
                handleCheckboxChange(e.target);
            }
        });
    }

    // --- SCRIPT START ---
    setupFilterCheckboxes();
    loadFiltersFromStorage();
    initializeEventListeners();
    applyFilters();
});

function confirmDelete(candidateId, candidateName, modelType) {
    if (confirm(`Are you sure you want to delete candidate "${candidateName}"? This action cannot be undone.`)) {
        window.location.href = `/crm/candidate/${candidateId}/${modelType}/delete/`;
    }
}
</script> 
{% endblock content %}

