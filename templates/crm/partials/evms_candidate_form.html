<style>
  .sticky-section-header {
    position: sticky;
    top: -25px; /* Adjust based on your header height */
    background-color: white;
    z-index: 1000;
    padding: 10px 0;
    color: #000;
    font-size: 16px;
    font-weight: 600;
    border-bottom: 1px solid #eee;
    margin-top: 0;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
</style>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const modalBody = document.querySelector('.modal-body');
    const modalHeader = document.querySelector('.modal-header');
    const sections = document.querySelectorAll('.modal-body h5.text-secondary');
    
    // Create the sticky header element
    const stickyHeader = document.createElement('h5');
    stickyHeader.className = 'sticky-section-header text-secondary';
    stickyHeader.style.display = 'none';
    modalHeader.after(stickyHeader);
    
    // Add intersection observer to track which section is visible
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            // Find the currently visible section
            const visibleSection = Array.from(sections).find(section => {
              const rect = section.getBoundingClientRect();
              return rect.top >= 0 && rect.top <= window.innerHeight;
            });
            
            if (visibleSection) {
              stickyHeader.textContent = visibleSection.textContent;
              stickyHeader.style.display = 'block';
            } else {
              stickyHeader.style.display = 'none';
            }
          }
        });
      }, 
      {
        root: modalBody,
        threshold: 0.1,
        rootMargin: '-60px 0px -90% 0px' // Adjust based on your needs
      }
    );
    
    // Observe each section
    sections.forEach(section => {
      observer.observe(section);
    });
    
    // Also observe the form's top to hide the sticky header when at the very top
    const firstElement = document.querySelector('#candidateForm > *:first-child');
    if (firstElement) {
      observer.observe(firstElement);
    }
  });
  </script>

<div class="modal modal-blur fade" id="unified-candidate-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modal-title">Candidate Information - {{ candidate.candidate_name }}({{ candidate.candidate_mobile_number }})</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="overflow-y: auto; max-height: calc(100vh - 200px);">
        <form method="POST" enctype="multipart/form-data" id="unifiedCandidateForm" novalidate>
          {% csrf_token %}
          <input type="hidden" name="submit_by" value="{{user.username}}"/>
          
          <div class="tab-content" id="formTabContent">
            <!-- Profile Tab -->
            <div class="tab-pane fade show active" id="profile" role="tabpanel">
              <hr class="my-4">
              <h5 class="text-secondary mb-4 sticky-section-header">Candidate Profile</h5>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Candidate Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" name="candidate_name" id="candidateName" value="{{ candidate.candidate_name }}" 
                         required pattern="[A-Za-z ]+" minlength="3" maxlength="50" />
                  <div class="invalid-feedback">
                    Please enter a valid name (3-50 characters, letters only)
                  </div>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label class="form-label">Candidate Mobile Number <span class="text-danger">*</span></label>
                  <input type="tel" class="form-control" name="candidate_mobile_number" id="candidateMobile"
                         value="{{ candidate.candidate_mobile_number }}" required pattern="[0-9]{10}" />
                  <div class="invalid-feedback">
                    Please enter a valid 10-digit mobile number
                  </div>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label class="form-label">Candidate Email Address <span class="text-danger">*</span></label>
                  <input type="email" class="form-control" name="candidate_email_address" id="candidateEmail"
                         value="{{ candidate.candidate_email_address }}"  />
                  <div class="invalid-feedback">
                    Please enter a valid email address
                  </div>
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Gender <span class="text-danger">*</span></label>
                  <select class="form-select" name="gender" required>
                    <option value="" disabled>Select Gender</option>
                    <option value="Male" {% if candidate.gender == "Male" %}selected{% endif %}>Male</option>
                    <option value="Female" {% if candidate.gender == "Female" %}selected{% endif %}>Female</option>
                    <option value="Other" {% if candidate.gender == "Other" %}selected{% endif %}>Other</option>
                  </select>
                  <div class="invalid-feedback">
                    Please select a gender
                  </div>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label class="form-label">Candidate Image</label>
                  <input type="file" class="form-control" name="candidate_photo" 
                         accept="image/*" />
                  <div class="invalid-feedback">
                    Please upload a valid image file (JPEG, PNG, etc.)
                  </div>
                  <small class="text-muted">Max size: 2MB</small>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label class="form-label">Candidate Resume</label>
                  <input type="file" class="form-control" name="candidate_resume" 
                         accept=".pdf,.doc,.docx" />
                  <div class="invalid-feedback">
                    Please upload a valid resume (PDF, DOC, DOCX)
                  </div>
                  <small class="text-muted">Max size: 5MB</small>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label class="form-label">Lead Source</label>
                  <select name="lead_source" class="form-select" required id="leadSourceSelect">
                      <option value="" disabled selected>Select Lead Source</option>
                      <option value="EVMS" {% if candidate.lead_source == "EVMS" %}selected{% endif %}>EVMS</option>
                      <option value="Walk-In" {% if candidate.lead_source == "Walk-In" %}selected{% endif %}>Walk-In</option>
                      <option value="Job Hai" {% if candidate.lead_source == "Job Hai" %}selected{% endif %}>Job Hai</option>
                      <option value="Naukari" {% if candidate.lead_source == "Naukari" %}selected{% endif %}>Naukari</option>
                      <option value="Apna" {% if candidate.lead_source == "Apna" %}selected{% endif %}>Apna</option>
                      <option value="Expertia" {% if candidate.lead_source == "Expertia" %}selected{% endif %}>Expertia</option>
                      <option value="Instagram" {% if candidate.lead_source == "Instagram" %}selected{% endif %}>Instagram</option>
                      <option value="Website" {% if candidate.lead_source == "Website" %}selected{% endif %}>Website</option>
                      <option value="Indeed" {% if candidate.lead_source == "Indeed" %}selected{% endif %}>Indeed</option>
                      <option value="Facebook" {% if candidate.lead_source == "Facebook" %}selected{% endif %}>Facebook</option>
                      <option value="Linkedin" {% if candidate.lead_source == "Linkedin" %}selected{% endif %}>Linkedin</option>
                      <option value="Personal Refference" {% if candidate.lead_source == "Personal Refference" %}selected{% endif %}>Personal Refference</option>
                      <option value="Other" {% if candidate.lead_source == "Other" %}selected{% endif %}>Other</option>
                  </select>
                  <div id="otherLeadSourceContainer" style="display: none;" class="mt-2">
                    <label class="form-label">Specify Other Lead Source</label>
                    <input type="text" class="form-control" name="other_lead_source" 
                           value="{{ candidate.other_lead_source }}" maxlength="100">
                  </div>
                </div>
                
                <div class="col-md-6 col-md-3">
                  <div class="mb-3">
                    <label class="form-label">Follow-Up By <span class="text-danger">*</span></label>
                    <select class="form-select" name="employee_name" required>
                      <option value="" disabled>Select Employee</option>
                      {% for employee in employees %}
                        <option value="{{ employee.first_name }} {{ employee.last_name }} ({{ employee.employee_id }})" 
                                {% if candidate.employee_name == employee.first_name|add:" "|add:employee.last_name|add:" ("|add:employee.employee_id|add:")"  %}selected{% endif %}>
                          {{ employee.first_name }} {{ employee.last_name }} ({{ employee.employee_id }})
                        </option>
                      {% endfor %}
                    </select>
                    <div class="invalid-feedback">
                      Please select an employee for follow-up
                    </div>
                  </div>
                </div>

                <div class="col-md-6 mb-3">
              <label class="form-label">Assign To</label>
              <select class="form-select" name="employee_assigned" >
                <option value="" disabled>Select Employee</option>
               {% for employee in employees %}
                        <option value="{{ employee.first_name }} {{ employee.last_name }} ({{ employee.employee_id }})" 
                                {% if candidate.employee_name == employee.first_name|add:" "|add:employee.last_name|add:" ("|add:employee.employee_id|add:")"  %}selected{% endif %}>
                          {{ employee.first_name }} {{ employee.last_name }} ({{ employee.employee_id }})
                        </option>
                      {% endfor %}
              </select>
              <div class="invalid-feedback">
                Please select employee to assign
              </div>
            </div>
              </div>
              <hr class="my-4">
              <h5 class="text-secondary mb-4 sticky-section-header">Candidate Details</h5>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Alternate Mobile Number</label>
                  <input type="tel" class="form-control" name="candidate_alternate_mobile_number" 
                         value="{{candidate.candidate_alternate_mobile_number}}"
                         pattern="[0-9]{10}">
                  <div class="invalid-feedback">
                    Please enter a valid 10-digit mobile number
                  </div>
                </div>

                
              <div class="col-md-6 mb-3">
              <label class="form-label">Preferred State</label>
              <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" 
                        id="stateDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                  {% if candidate.state %}
                    {% if candidate.state|length > 2 %}
                      {{ candidate.state|length }} states selected
                    {% else %}
                      {{ candidate.state|join:", " }}
                    {% endif %}
                  {% else %}
                    Select states...
                  {% endif %}
                </button>
                <ul class="dropdown-menu w-100 p-2" aria-labelledby="stateDropdown">
                  <li>
                    <div class="px-2 mb-2">
                      <input type="text" class="form-control search-input" 
                             placeholder="Search states..." 
                             id="stateSearch">
                    </div>
                  </li>
                  <div class="dropdown-options" style="max-height: 250px; overflow-y: auto;">
                    {% for S in state %}
                    <li class="dropdown-item">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="preferred_state" 
                               value="{{ S }}" id="loc-{{ forloop.counter }}"
                               {% if S in candidate.preferred_state %}checked{% endif %}>
                        <label class="form-check-label w-100" for="loc-{{ forloop.counter }}">
                          {{ S }}
                        </label>
                      </div>
                    </li>
                    {% endfor %}
                  </div>
                </ul>
              </div>
              <div class="invalid-feedback">
                Please select at least one location
              </div>
            </div>
              
              <div class="col-md-6 mb-3">
  <label class="form-label">Preferred Location</label>
  <div class="dropdown">
    <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" 
            id="locationDropdown" data-bs-toggle="dropdown" aria-expanded="false">
      {% if candidate.preferred_location %}
        {% if candidate.preferred_location|length > 2 %}
          {{ candidate.preferred_location|length }} locations selected
        {% else %}
          {{ candidate.preferred_location|join:", " }}
        {% endif %}
      {% else %}
        Select locations...
      {% endif %}
    </button>
    <ul class="dropdown-menu w-100 p-2" aria-labelledby="locationDropdown">
      <li>
        <div class="px-2 mb-2">
          <input type="text" class="form-control search-input" 
                 placeholder="Search locations..." 
                 id="locationSearch">
        </div>
      </li>
      <div class="dropdown-options" style="max-height: 250px; overflow-y: auto;">
        {% for district in districts %}
        <li class="dropdown-item">
          <div class="form-check">
            <input class="form-check-input location-checkbox" type="checkbox" name="preferred_location" 
                   value="{{ district }}" id="loc-{{ forloop.counter }}"
                   {% if district in candidate.preferred_location %}checked{% endif %}>
            <label class="form-check-label w-100" for="loc-{{ forloop.counter }}">
              {{ district }}
            </label>
          </div>
        </li>
        {% endfor %}
        <li class="dropdown-item">
          <div class="form-check">
            <input class="form-check-input location-checkbox" type="checkbox" name="preferred_location" 
                   value="Others" id="loc-others"
                   {% if "Others" in candidate.preferred_location %}checked{% endif %}>
            <label class="form-check-label w-100" for="loc-others">
              Others
            </label>
          </div>
        </li>
      </div>
    </ul>
  </div>
  <div class="invalid-feedback">
    Please select at least one location
  </div>
</div>

<!-- Hidden 'Other Preferred Location' Field -->
<div class="col-md-6 mb-3" id="otherPreferredLocationField" style="display: none;">
  <label class="form-label">Please specify other location(s)</label>
  <input type="text" class="form-control" name="other_preferred_location" 
         placeholder="Enter other preferred locations (comma separated)"
         value="{% if candidate.other_preferred_location %}{{ candidate.other_preferred_location }}{% endif %}">
</div>

              
              <div class="col-md-6 mb-3">
  <label class="form-label">Candidate Origin Location</label>
  
  <!-- Custom searchable dropdown container -->
  <div class="custom-dropdown">
    <!-- Search input and dropdown toggle -->
    <div class="dropdown-input-container">
      <input type="text" class="form-control dropdown-search-input" 
             placeholder="Search locations..." 
             id="originLocationSearch"
             {% if candidate.origin_location %}value="{{ candidate.origin_location }}"{% endif %}>
      <button class="dropdown-toggle-btn" type="button">
        <i class="fas fa-chevron-down"></i>
      </button>
    </div>
    
    <!-- Dropdown options -->
    <div class="dropdown-options" id="originLocationOptions" style="display: none;">
      {% for district in districts %}
      <div class="dropdown-option" data-value="{{ district }}">
        {{ district }}
      </div>
      {% endfor %}
      <div class="dropdown-option" data-value="Other">
        Other
      </div>
    </div>
    
    <!-- Hidden select element for form submission -->
    <select name="origin_location" id="originLocation"  style="display: none;">
      {% if candidate.origin_location %}
        <option value="{{ candidate.origin_location }}" selected>{{ candidate.origin_location }}</option>
      {% endif %}
    </select>
  </div>
  
  <!-- Other location field -->
  <div id="otherOriginLocation" style="display: none;" class="mt-2">
    <label class="form-label">Specify Other Candidate Origin Location</label>
    <input type="text" class="form-control" name="other_origin_location" 
           value="{{ candidate.other_origin_location }}" maxlength="100">
  </div>
  <div class="invalid-feedback">
    Maximum 100 characters allowed
  </div>
</div>

<style>
.custom-dropdown {
  position: relative;
  width: 100%;
}

.dropdown-input-container {
  position: relative;
  display: flex;
}

.dropdown-search-input {
  padding-right: 35px;
}

.dropdown-toggle-btn {
  position: absolute;
  right: 0;
  top: 0;
  height: 100%;
  background: transparent;
  border: none;
  padding: 0 10px;
  color: #6c757d;
}

.dropdown-options {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  max-height: 250px;
  overflow-y: auto;
  border: 1px solid #ced4da;
  border-radius: 0.25rem;
  background: white;
  z-index: 1000;
  margin-top: 2px;
}

.dropdown-option {
  padding: 8px 12px;
  cursor: pointer;
}

.dropdown-option:hover {
  background-color: #f8f9fa;
}

.dropdown-option.active {
  background-color: #007bff;
  color: white;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('originLocationSearch');
  const optionsContainer = document.getElementById('originLocationOptions');
  const hiddenSelect = document.getElementById('originLocation');
  const otherLocationField = document.getElementById('otherOriginLocation');
  
  // Toggle dropdown visibility
  searchInput.addEventListener('focus', function() {
    optionsContainer.style.display = 'block';
    filterOptions();
  });
  
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.custom-dropdown')) {
      optionsContainer.style.display = 'none';
    }
  });
  
  // Filter options based on search input
  searchInput.addEventListener('input', filterOptions);
  
  function filterOptions() {
    const searchValue = searchInput.value.toLowerCase();
    const options = optionsContainer.querySelectorAll('.dropdown-option');
    
    options.forEach(option => {
      const text = option.textContent.toLowerCase();
      if (text.includes(searchValue)) {
        option.style.display = 'block';
      } else {
        option.style.display = 'none';
      }
    });
  }
  
  // Handle option selection
  optionsContainer.addEventListener('click', function(e) {
    const option = e.target.closest('.dropdown-option');
    if (option) {
      const value = option.getAttribute('data-value');
      const text = option.textContent;
      
      // Update search input and hidden select
      searchInput.value = text;
      hiddenSelect.innerHTML = `<option value="${value}" selected>${text}</option>`;
      
      // Toggle other location field
      if (value === 'Other') {
        otherLocationField.style.display = 'block';
      } else {
        otherLocationField.style.display = 'none';
      }
      
      // Close dropdown
      optionsContainer.style.display = 'none';
    }
  });
  
  // Initialize if value exists
  if (hiddenSelect.value === 'Other') {
    otherLocationField.style.display = 'block';
  }
  
  // Handle keyboard navigation
  searchInput.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowDown' || e.key === 'ArrowUp' || e.key === 'Enter') {
      e.preventDefault();
      const options = Array.from(optionsContainer.querySelectorAll('.dropdown-option:not([style*="display: none"])'));
      const activeOption = optionsContainer.querySelector('.dropdown-option.active');
      let currentIndex = activeOption ? options.indexOf(activeOption) : -1;
      
      if (e.key === 'ArrowDown') {
        currentIndex = (currentIndex + 1) % options.length;
      } else if (e.key === 'ArrowUp') {
        currentIndex = (currentIndex - 1 + options.length) % options.length;
      } else if (e.key === 'Enter' && activeOption) {
        activeOption.click();
        return;
      }
      
      // Update active option
      optionsContainer.querySelectorAll('.dropdown-option').forEach(opt => {
        opt.classList.remove('active');
      });
      if (currentIndex >= 0) {
        options[currentIndex].classList.add('active');
      }
    }
  });
});
</script>
              <div class="col-md-6 mb-3">
                <label class="form-label">Qualification</label>
                <select class="form-select" name="qualification" id="qualificationSelect">
                  <option value="">Select Qualification</option>
                  <option value="High School" {% if candidate.qualification == "High School" %}selected{% endif %}>High School</option>
                  <option value="Higher Secondary" {% if candidate.qualification == "Higher Secondary" %}selected{% endif %}>Higher Secondary</option>
                  <option value="Bachelor's Degree" {% if candidate.qualification == "Bachelor's Degree" %}selected{% endif %}>Bachelor's Degree</option>
                  <option value="Master's Degree" {% if candidate.qualification == "Master's Degree" %}selected{% endif %}>Master's Degree</option>
                  <option value="PhD" {% if candidate.qualification == "PhD" %}selected{% endif %}>PhD</option>
                  <option value="Other" {% if candidate.qualification == "Other" %}selected{% endif %}>Other</option>
                </select>
                <div id="otherQualificationContainer" style="display: none;" class="mt-2">
                  <label class="form-label">Specify Other Qualification</label>
                  <input type="text" class="form-control" name="other_qualification" 
                         value="{{ candidate.other_qualification }}" maxlength="100">
                </div>
              </div>
              
              <div class="col-md-6 mb-3">
                <label class="form-label">Diploma</label>
                <input type="text" class="form-control" name="diploma" 
                       value="{{candidate.diploma}}"
                       maxlength="100">
                <div class="invalid-feedback">
                  Maximum 100 characters allowed
                </div>
              </div>
              
              <!-- Sector -->
<div class="col-sm-6 col-md-6">
  <div class="mb-3">
    <label class="form-label">Sector</label>
    <div class="dropdown">
      <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" 
              id="sectorDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        {% if candidate.sector %}
          {% if candidate.sector|length > 2 %}
            {{ candidate.sector|length }} sectors selected
          {% else %}
            {{ candidate.sector|join:", " }}
          {% endif %}
        {% else %}
          Select sectors...
        {% endif %}
      </button>
      <ul class="dropdown-menu w-100 p-2" aria-labelledby="sectorDropdown">
        <li>
          <div class="px-2 mb-2">
            <input type="text" class="form-control sector-search-input" 
                   placeholder="Search sectors..." 
                   id="sectorSearch">
          </div>
        </li>
        <div class="dropdown-options" style="max-height: 250px; overflow-y: auto;">
          {% for job_sector in job_sectors %}
          <li class="dropdown-item">
            <div class="form-check">
              <input class="form-check-input sector-checkbox" type="checkbox" name="sector" 
                     value="{{ job_sector }}" id="sector-{{ forloop.counter }}"
                     {% if job_sector in candidate.sector %}checked{% endif %}>
              <label class="form-check-label w-100" for="sector-{{ forloop.counter }}">
                {{ job_sector }}
              </label>
            </div>
          </li>
          {% endfor %}
          <li class="dropdown-item">
            <div class="form-check">
              <input class="form-check-input sector-checkbox" type="checkbox" name="sector" 
                     value="Others" id="sector-others"
                     {% if "Others" in candidate.sector %}checked{% endif %}>
              <label class="form-check-label w-100" for="sector-others">
                Others
              </label>
            </div>
          </li>
        </div>
      </ul>
    </div>
    <div class="invalid-feedback">Please select at least one sector.</div>
  </div>
</div>

<!-- Hidden 'Other Sector' Field -->
<div class="col-sm-6 col-md-6 mb-3" id="otherSectorField" style="display: none;">
  <label class="form-label">Please specify other sector(s)</label>
  <input type="text" class="form-control" name="other_sector" 
         placeholder="Enter other sectors (comma separated)"
         value="{% if candidate.other_sector %}{{ candidate.other_sector }}{% endif %}">
</div>

<script>
// Search functionality for sectors
document.getElementById('sectorSearch').addEventListener('input', function() {
  const searchValue = this.value.toLowerCase();
  const options = document.querySelectorAll('#sectorDropdown ~ .dropdown-menu .dropdown-options .dropdown-item');
  
  options.forEach(option => {
    const text = option.textContent.toLowerCase();
    if (text.includes(searchValue)) {
      option.style.display = 'block';
    } else {
      option.style.display = 'none';
    }
  });
});

// Toggle 'Other Sector' field and update button text
document.addEventListener('DOMContentLoaded', function() {
  const sectorCheckboxes = document.querySelectorAll('.sector-checkbox');
  const otherSectorField = document.getElementById('otherSectorField');
  
  sectorCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      // Check if "Others" is selected
      const othersChecked = document.getElementById('sector-others').checked;
      otherSectorField.style.display = othersChecked ? 'block' : 'none';
      
      // Update dropdown button text
      updateSectorButtonText();
    });
  });
  
  // Initialize button text
  updateSectorButtonText();
  
  // Check if "Others" was previously selected
  if (document.getElementById('sector-others').checked) {
    otherSectorField.style.display = 'block';
  }
});

function updateSectorButtonText() {
  const checkedBoxes = document.querySelectorAll('.sector-checkbox:checked');
  const button = document.getElementById('sectorDropdown');
  
  if (checkedBoxes.length === 0) {
    button.textContent = 'Select sectors...';
  } else if (checkedBoxes.length > 2) {
    button.textContent = checkedBoxes.length + ' sectors selected';
  } else {
    const selectedValues = Array.from(checkedBoxes).map(cb => cb.value);
    button.textContent = selectedValues.join(', ');
  }
}
</script>
              
              <!-- Department -->
<div class="col-sm-6 col-md-6">
  <div class="mb-3">
    <label class="form-label">Department</label>
    <div class="dropdown">
      <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" 
              id="departmentDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        {% if candidate.department %}
          {% if candidate.department|length > 2 %}
            {{ candidate.department|length }} departments selected
          {% else %}
            {{ candidate.department|join:", " }}
          {% endif %}
        {% else %}
          Select departments...
        {% endif %}
      </button>
      <ul class="dropdown-menu w-100 p-2" aria-labelledby="departmentDropdown">
        <li>
          <div class="px-2 mb-2">
            <input type="text" class="form-control department-search-input" 
                   placeholder="Search departments..." 
                   id="departmentSearch">
          </div>
        </li>
        <div class="dropdown-options" style="max-height: 250px; overflow-y: auto;">
          {% for department in departments %}
          <li class="dropdown-item">
            <div class="form-check">
              <input class="form-check-input department-checkbox" type="checkbox" name="department" 
                     value="{{ department }}" id="dept-{{ forloop.counter }}"
                     {% if department in candidate.department %}checked{% endif %}>
              <label class="form-check-label w-100" for="dept-{{ forloop.counter }}">
                {{ department }}
              </label>
            </div>
          </li>
          {% endfor %}
          <li class="dropdown-item">
            <div class="form-check">
              <input class="form-check-input department-checkbox" type="checkbox" name="department" 
                     value="Others" id="dept-others"
                     {% if "Others" in candidate.department %}checked{% endif %}>
              <label class="form-check-label w-100" for="dept-others">
                Others
              </label>
            </div>
          </li>
        </div>
      </ul>
    </div>
    <div class="invalid-feedback">Please select at least one department.</div>
  </div>
</div>

<!-- Hidden 'Other Department' Field -->
<div class="col-sm-6 col-md-6 mb-3" id="otherDepartmentField" style="display: none;">
  <label class="form-label">Please specify other department(s)</label>
  <input type="text" class="form-control" name="other_department" 
         placeholder="Enter other departments (comma separated)"
         value="{% if candidate.other_department %}{{ candidate.other_department }}{% endif %}">
</div>

<script>
// Search functionality for departments
document.getElementById('departmentSearch').addEventListener('input', function() {
  const searchValue = this.value.toLowerCase();
  const options = document.querySelectorAll('#departmentDropdown ~ .dropdown-menu .dropdown-options .dropdown-item');
  
  options.forEach(option => {
    const text = option.textContent.toLowerCase();
    if (text.includes(searchValue)) {
      option.style.display = 'block';
    } else {
      option.style.display = 'none';
    }
  });
});

// Toggle 'Other Department' field and update button text
document.addEventListener('DOMContentLoaded', function() {
  const departmentCheckboxes = document.querySelectorAll('.department-checkbox');
  const otherDepartmentField = document.getElementById('otherDepartmentField');
  
  departmentCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      // Check if "Others" is selected
      const othersChecked = document.getElementById('dept-others').checked;
      otherDepartmentField.style.display = othersChecked ? 'block' : 'none';
      
      // Update dropdown button text
      updateDepartmentButtonText();
    });
  });
  
  // Initialize button text
  updateDepartmentButtonText();
  
  // Check if "Others" was previously selected
  if (document.getElementById('dept-others').checked) {
    otherDepartmentField.style.display = 'block';
  }
});

function updateDepartmentButtonText() {
  const checkedBoxes = document.querySelectorAll('.department-checkbox:checked');
  const button = document.getElementById('departmentDropdown');
  
  if (checkedBoxes.length === 0) {
    button.textContent = 'Select departments...';
  } else if (checkedBoxes.length > 2) {
    button.textContent = checkedBoxes.length + ' departments selected';
  } else {
    const selectedValues = Array.from(checkedBoxes).map(cb => cb.value);
    button.textContent = selectedValues.join(', ');
  }
}
</script>


<script>
// Search functionality
document.getElementById('locationSearch').addEventListener('input', function() {
  const searchValue = this.value.toLowerCase();
  const options = document.querySelectorAll('.dropdown-options .dropdown-item');
  
  options.forEach(option => {
    const text = option.textContent.toLowerCase();
    if (text.includes(searchValue)) {
      option.style.display = 'block';
    } else {
      option.style.display = 'none';
    }
  });
});

// Toggle 'Other Preferred Location' field
document.addEventListener('DOMContentLoaded', function() {
  const checkboxes = document.querySelectorAll('.location-checkbox');
  const otherField = document.getElementById('otherPreferredLocationField');
  
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      // Check if "Others" is selected
      const othersChecked = document.getElementById('loc-others').checked;
      otherField.style.display = othersChecked ? 'block' : 'none';
      
      // Update dropdown button text
      updateButtonText();
    });
  });
  
  // Initialize button text
  updateButtonText();
  
  // Check if "Others" was previously selected
  if (document.getElementById('loc-others').checked) {
    otherField.style.display = 'block';
  }
});

function updateButtonText() {
  const checkedBoxes = document.querySelectorAll('.location-checkbox:checked');
  const button = document.getElementById('locationDropdown');
  
  if (checkedBoxes.length === 0) {
    button.textContent = 'Select locations...';
  } else if (checkedBoxes.length > 2) {
    button.textContent = checkedBoxes.length + ' locations selected';
  } else {
    const selectedValues = Array.from(checkedBoxes).map(cb => cb.value);
    button.textContent = selectedValues.join(', ');
  }
}
</script>
                
                <div class="col-md-6 mb-3">
                  <label class="form-label">Experience (In Years)</label>
                  <input type="number" class="form-control" name="experience_year" 
                         value="{{candidate.experience_year}}"
                         min="0" max="50" step="1">
                  <div class="invalid-feedback">
                    Please enter a value between 0-50 years
                  </div>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label class="form-label">Experience (In Months)</label>
                  <input type="number" class="form-control" name="experience_month" 
                         value="{{candidate.experience_month}}"
                         min="0" max="11" step="1">
                  <div class="invalid-feedback">
                    Please enter a value between 0-11 months
                  </div>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label class="form-label">Current Company</label>
                  <input type="text" class="form-control" name="current_company" 
                         value="{{candidate.current_company}}" maxlength="100">
                  <div class="invalid-feedback">
                    Maximum 100 characters allowed
                  </div>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label class="form-label">Working Status</label>
                  <select class="form-select" name="current_working_status" id="workingStatusSelect">
                    <option value="">Select Status</option>
                    <option value="Employed" {% if candidate.current_working_status == "Employed" %}selected{% endif %}>Employed</option>
                    <option value="Unemployed" {% if candidate.current_working_status == "Unemployed" %}selected{% endif %}>Unemployed</option>
                    <option value="Student" {% if candidate.current_working_status == "Student" %}selected{% endif %}>Student</option>
                    <option value="Freelancer" {% if candidate.current_working_status == "Freelancer" %}selected{% endif %}>Freelancer</option>
                    <option value="Other" {% if candidate.current_working_status == "Other" %}selected{% endif %}>Other</option>
                  </select>
                  <div id="otherWorkingStatusContainer" style="display: none;" class="mt-2">
                    <label class="form-label">Specify Other Working Status</label>
                    <input type="text" class="form-control" name="other_working_status" 
                           value="{{ candidate.other_working_status }}" maxlength="100">
                  </div>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label class="form-label">Current Salary (₹)</label>
                  <div class="input-group">
                    <input type="number" class="form-control" name="current_salary"
                           value="{{ candidate.current_salary }}" min="0" step="1">
                    <select class="form-select" name="current_salary_type">
                      <option value="(CTC)" {% if candidate.current_salary_type == '(CTC)' %}selected{% endif %}>CTC</option>
                      <option value="(Per Month)" {% if candidate.current_salary_type == '(Per Month)' %}selected{% endif %}>Per Month</option>
                      <option value="(In Hand)" {% if candidate.current_salary_type == '(In Hand)' %}selected{% endif %}>In Hand</option>
                      <option value="(Per Annum)" {% if candidate.current_salary_type == '(Per Annum)' %}selected{% endif %}>Per Annum</option>
                    </select>
                  </div>
                  <div class="invalid-feedback">
                    Please enter a valid salary
                  </div>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label class="form-label">Expected Salary (₹)</label>
                  <div class="input-group">
                    <input type="number" class="form-control" name="expected_salary"
                           value="{{ candidate.expected_salary }}" min="0" step="1">
                    <select class="form-select" name="expected_salary_type">
                      <option value="(CTC)" {% if candidate.expected_salary_type == '(CTC)' %}selected{% endif %}>CTC</option>
                      <option value="(Per Month)" {% if candidate.expected_salary_type == '(Per Month)' %}selected{% endif %}>Per Month</option>
                      <option value="(In Hand)" {% if candidate.expected_salary_type == '(In Hand)' %}selected{% endif %}>In Hand</option>
                      <option value="(Per Annum)" {% if candidate.expected_salary_type == '(Per Annum)' %}selected{% endif %}>Per Annum</option>
                    </select>
                  </div>
                  <div class="invalid-feedback">
                    Please enter a valid salary
                  </div>
                </div>
              </div>
              <hr class="my-4">
              <h5 class="text-secondary mb-4 sticky-section-header">Candidate Calling Details</h5>
              <div class="row">
                <!-- Call Connection Status -->
                <div class="col-md-6 mb-3">
                  <label class="form-label">Call Connection Status <span class="text-danger">*</span></label>
                  <select class="form-select" name="call_connection" id="callConnection" required>
                    <option value="" disabled selected>Select Status</option>
                    <option value="Connected" {% if candidate.call_connection == "Connected" %}selected{% endif %}>Connected</option>
                    <option value="Not Reachable" {% if candidate.call_connection == "Not Reachable" %}selected{% endif %}>Not Reachable</option>
                    <option value="Busy" {% if candidate.call_connection == "Busy" %}selected{% endif %}>Busy</option>
                    <option value="Wrong Number" {% if candidate.call_connection == "Wrong Number" %}selected{% endif %}>Wrong Number</option>
                    <option value="Other" {% if candidate.call_connection == "Other" %}selected{% endif %}>Other</option>
                  </select>
                  <div id="otherCallConnectionContainer" style="display: none;" class="mt-2">
                    <label class="form-label">Specify Other Call Connection Status</label>
                    <input type="text" class="form-control" name="other_call_connection" 
                           value="{{ candidate.other_call_connection }}" maxlength="100">
                  </div>
                  <div class="invalid-feedback">Please select call connection status</div>
                </div>
              </div>

              <div class="row" id="connectedFields" style="display: none;">
                <div class="col-md-12 mb-3">
                  <label class="form-label">Lead Status <span class="text-danger">*</span></label>
                  <select class="form-select" name="lead_generate" id="leadGenerateSelect" >
                    <option value="" disabled selected>Select Status</option>
    <option value="Hot" {% if candidate.lead_generate == "Hot" %}selected{% endif %}>
      Hot <span class="text-muted">(Positive prospect but pending for Conversion for Interview scheduling)</span>
    </option>
    <option value="Cold" {% if candidate.lead_generate == "Cold" %}selected{% endif %}>
      Cold <span class="text-muted">(Not so interested)</span>
    </option>
    <option value="Converted" {% if candidate.lead_generate == "Converted" %}selected{% endif %}>
      Converted <span class="text-muted">(for Scheduling Interview)</span>
    </option>
    <option value="Not interested" {% if candidate.lead_generate == "Not interested" %}selected{% endif %}>
      Not interested <span class="text-muted">(Looking for different Jobs/Salary Range - mention in Remarks)</span>
    </option>
    <option value="Connect later" {% if candidate.lead_generate == "Connect later" %}selected{% endif %}>
      Connect later <span class="text-muted">(mention Follow-up date and time)</span>
    </option>
    <option value="DND" {% if candidate.lead_generate == "DND" %}selected{% endif %}>
      DND <span class="text-muted">(Candidate does not want to receive calls/messages)</span>
    </option>
    <option value="Other" {% if candidate.lead_generate == "Other" %}selected{% endif %}>
      Other <span class="text-muted">(mention in remarks)</span>
    </option>
                  </select>
                  <div id="otherLeadGenerateContainer" style="display: none;" class="mt-2">
                    <label class="form-label">Specify Other Lead Generate Status</label>
                    <input type="text" class="form-control" name="other_lead_generate" 
                           value="{{ candidate.other_lead_generate }}" maxlength="100">
                  </div>
                  <div class="invalid-feedback">
                    Please select lead generation status
                  </div>
                </div>
                
                <div class="col-md-12 mb-3">
                  <label class="form-label">Send for Interview Status <span class="text-danger">*</span></label>
                  <select class="form-select" name="send_for_interview" id="interviewStatusSelect" >
                    <option value="" disabled selected>Select Status</option>
                    <option value="Yes" {% if candidate.send_for_interview == "Yes" %}selected{% endif %}>Yes</option>
                    <option value="No" {% if candidate.send_for_interview == "No" %}selected{% endif %}>No</option>
                    <option value="Scheduled" {% if candidate.send_for_interview == "Scheduled" %}selected{% endif %}>Scheduled</option>
                    <option value="Not Interested" {% if candidate.send_for_interview == "Not Interested" %}selected{% endif %}>Not Interested</option>
                    <option value="Rescheduled" {% if candidate.send_for_interview == "Rescheduled" %}selected{% endif %}>Rescheduled</option>
                    <option value="Completed" {% if candidate.send_for_interview == "Completed" %}selected{% endif %}>Completed</option>
                    <option value="Other" {% if candidate.send_for_interview == "Other" %}selected{% endif %}>Other</option>
                  </select>
                  <div id="otherInterviewStatusContainer" style="display: none;" class="mt-2">
                    <label class="form-label">Specify Other Interview Status</label>
                    <input type="text" class="form-control" name="other_interview_status" 
                           value="{{ candidate.other_interview_status }}" maxlength="100">
                  </div>
                  <div class="invalid-feedback">
                    Please select interview status
                  </div>
                </div>
                
                <div class="col-md-12 mb-3">
                  <label class="form-label">Next Follow-Up Date <span class="text-danger">*</span></label>
                  <input type="datetime-local" name="next_follow_up_date_time" class="form-control" 
                        value="{{ candidate.next_follow_up_date_time|date:'Y-m-d H:i' }}" >
                  <div class="invalid-feedback">
                    Please select a valid future date
                  </div>
                </div>

                <div class="col-md-12 mb-3">
                  <label class="form-label">Calling Remark <span class="text-danger">*</span></label>
                  <textarea class="form-control" name="calling_remark" rows="3"  maxlength="500">{{ candidate.calling_remark }}</textarea>
                  <div class="invalid-feedback">
                    Please enter calling remarks (max 500 characters)
                  </div>
                  <small class="text-muted">Characters remaining: <span id="remarkCounter">500</span></small>
                </div>
              </div>
              <hr class="my-4">
              <h5 class="text-secondary mb-4 sticky-section-header">Candidate Selection</h5>
              <div class="row">
                <div class="col-md-12 mb-3">
                  <label class="form-label">Selection Status <span class="text-danger">*</span></label>
                  <select class="form-select" name="selection_status" id="selectionStatus">
                    <option value="" disabled selected>Select Status</option>
                    <option value="Selected" {% if candidate.selection_status == "Selected" %}selected{% endif %}>Selected</option>
                    <option value="Rejected" {% if candidate.selection_status == "Rejected" %}selected{% endif %}>Rejected</option>
                    <option value="Pending" {% if candidate.selection_status == "Pending" %}selected{% endif %}>Pending</option>
                    <option value="Not Join" {% if candidate.selection_status == "Not Join" %}selected{% endif %}>Not Join</option>
                    <option value="Other" {% if candidate.selection_status == "Other" %}selected{% endif %}>Other</option>
                  </select>

                  <div id="otherSelectionStatusContainer" class="mt-2" style="display: none;">
                    <label class="form-label">Specify Other Selection Status</label>
                    <input type="text" class="form-control" name="other_selection_status" value="{{ candidate.other_selection_status }}" maxlength="100">
                  </div>
                  <div class="invalid-feedback">Please select candidate selection status</div>
                </div>
              </div>

              <div class="row" id="selectionFields" style="display: none;">
                <div class="col-md-6 mb-3">
              <label class="form-label">Company Name</label>
              <select class="form-select" name="company_name">
                {% for c in companies %}
                  <option value="{{ c.company_name }}"
                    {% if candidate.company_name == c.company_name %}selected{% endif %}>
                    {{ c.company_name }}
                  </option>
                {% endfor %}
                <option value="Other" {% if candidate.company_name == "Other" %}selected{% endif %}>Other</option>
              </select>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">Job Profile</label>
              <select class="form-select" name="job_title">
                {% for v in vacancies %}
                  <option value="{{ v.job_profile }}"
                    {% if candidate.job_title == v.job_profile %}selected{% endif %}>
                    {{ v.job_profile }} - {{ v.company__company_name }}
                  </option>
                {% endfor %}
                <option value="Other" {% if candidate.job_title == "Other" %}selected{% endif %}>Other</option>
              </select>
            </div>

                <div class="col-md-12 mb-3">
                  <label class="form-label">Selection Date <span class="text-danger">*</span></label>
                  <input type="date" name="selection_date" class="form-control"
                         value="{{ candidate.selection_date|date:'Y-m-d' }}" max="{% now 'Y-m-d' %}">
                  <div class="invalid-feedback">Please select a valid selection date</div>
                </div>

                <div class="col-md-12 mb-3">
                  <label class="form-label">Offered Salary (₹) <span class="text-danger">*</span></label>
                  <input type="number" name="offered_salary" class="form-control"
                         value="{{ candidate.offered_salary }}" min="0" step="1">
                  <div class="invalid-feedback">Please enter a valid salary</div>
                </div>

                <div class="col-md-12 mb-3">
                  <label class="form-label">Joining Status <span class="text-danger">*</span></label>
                  <select class="form-select" name="joining_status" id="joiningStatus">
                    <option value="" disabled>Select Candidate Joining Status</option>
                    <option value="Pending" {% if candidate.joining_status == "Pending" %}selected{% endif %}>Pending</option>
                    <option value="Joined" {% if candidate.joining_status == "Joined" %}selected{% endif %}>Joined</option>
                    <option value="Not Joined" {% if candidate.joining_status == "Not Joined" %}selected{% endif %}>Not Joined</option>
                  </select>
                  <div class="invalid-feedback">Please select candidate joining status</div>
                </div>
              </div>

              <div class="row" id="joinedFields" style="display: none;">
                <div class="col-md-12 mb-3">
                  <label class="form-label">Joining Date</label>
                  <input type="date" name="candidate_joining_date" class="form-control"
                         value="{{ candidate.candidate_joining_date|date:'Y-m-d' }}">
                  <div class="invalid-feedback">Joining date must be after selection date</div>
                </div>

                <div class="col-md-12 mb-3">
                  <label class="form-label">Our Commission (₹)</label>
                  <input type="number" name="emta_commission" class="form-control"
                         value="{{ candidate.emta_commission }}" min="0" step="1">
                  <div class="invalid-feedback">Please enter a valid commission amount</div>
                </div>

                <div class="col-md-12 mb-3">
                  <label class="form-label">Payout Date</label>
                  <input type="date" name="payout_date" class="form-control"
                         value="{{ candidate.payout_date|date:'Y-m-d' }}">
                  <div class="invalid-feedback">Payout date must be after joining date</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="modal-footer" style="position: sticky; bottom: -30px; z-index: 1050; background: var(--tblr-bg-surface); border-top: 1px solid var(--tblr-border-color);">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" name="submit_all" class="btn btn-primary">Save All Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Main form elements
  const form = document.getElementById('unifiedCandidateForm');
  const currentDate = new Date().toISOString().split('T')[0];
  
  // Field change confirmation for name, mobile, email
  const originalValues = {
    name: document.getElementById('candidateName').value,
    mobile: document.getElementById('candidateMobile').value,
    email: document.getElementById('candidateEmail').value
  };

  function checkChanges() {
    const currentValues = {
      name: document.getElementById('candidateName').value,
      mobile: document.getElementById('candidateMobile').value,
      email: document.getElementById('candidateEmail').value
    };

    const changes = [];
    if (currentValues.name !== originalValues.name) {
      changes.push('Name');
    }
    if (currentValues.mobile !== originalValues.mobile) {
      changes.push('Mobile Number');
    }
    if (currentValues.email !== originalValues.email) {
      changes.push('Email');
    }

    if (changes.length > 0) {
      const message = `You have modified the following fields:\n${changes.join('\n')}\n\nAre you sure you want to save these changes?`;
      if (!confirm(message)) {
        // Reset to original values if user cancels
        document.getElementById('candidateName').value = originalValues.name;
        document.getElementById('candidateMobile').value = originalValues.mobile;
        document.getElementById('candidateEmail').value = originalValues.email;
        return false;
      }
    }
    return true;
  }

  // Add change event listeners for confirmation
  document.getElementById('candidateName').addEventListener('change', checkChanges);
  document.getElementById('candidateMobile').addEventListener('change', checkChanges);
  document.getElementById('candidateEmail').addEventListener('change', checkChanges);

  // Initialize dropdown search functionality
  function initializeDropdownSearch(dropdownType) {
    const searchInput = document.getElementById(`${dropdownType}Search`);
    if (!searchInput) return;

    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      const options = document.querySelectorAll(`#${dropdownType}Dropdown + .dropdown-menu .dropdown-item`);
      
      options.forEach(option => {
        const text = option.textContent.toLowerCase();
        option.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });
  }

  // Initialize all dropdown searches
  initializeDropdownSearch('location');
  initializeDropdownSearch('sector');
  initializeDropdownSearch('department');

  // Update dropdown button text based on selected items
  function updateDropdownButtonText(dropdownType) {
    const button = document.getElementById(`${dropdownType}Dropdown`);
    const checkboxes = document.querySelectorAll(`input[name="${dropdownType}"]:checked`);
    const selectedItems = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedItems.length === 0) {
      button.textContent = `Select ${dropdownType}s...`;
    } else if (selectedItems.length > 2) {
      button.textContent = `${selectedItems.length} ${dropdownType}s selected`;
    } else {
      button.textContent = selectedItems.join(', ');
    }
  }

  // Initialize dropdown button text
  ['location', 'sector', 'department'].forEach(type => {
    updateDropdownButtonText(type);
    document.querySelectorAll(`input[name="${type}"]`).forEach(checkbox => {
      checkbox.addEventListener('change', () => updateDropdownButtonText(type));
    });
  });

  // Toggle "Other" input fields based on select value
  function toggleOtherInput(selectElement, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    if (selectElement.value === 'Other') {
      container.style.display = 'block';
      const input = container.querySelector('input');
      if (input) input.required = false;
    } else {
      container.style.display = 'none';
      const input = container.querySelector('input');
      if (input) input.required = false;
    }
  }

  // Initialize all "Other" input fields
  const otherInputMappings = [
    { selectId: 'leadSourceSelect', containerId: 'otherLeadSourceContainer' },
    { selectId: 'qualificationSelect', containerId: 'otherQualificationContainer' },
    { selectId: 'workingStatusSelect', containerId: 'otherWorkingStatusContainer' },
    { selectId: 'callConnection', containerId: 'otherCallConnectionContainer' },
    { selectId: 'originLocation', containerId: 'otherOriginLocation' },
    { selectId: 'leadGenerateSelect', containerId: 'otherLeadGenerateContainer' },
    { selectId: 'interviewStatusSelect', containerId: 'otherInterviewStatusContainer' },
    { selectId: 'selectionStatus', containerId: 'otherSelectionStatusContainer' }
  ];

  otherInputMappings.forEach(mapping => {
    const select = document.getElementById(mapping.selectId);
    if (select) {
      select.addEventListener('change', function() {
        toggleOtherInput(this, mapping.containerId);
      });
      // Initialize on load
      toggleOtherInput(select, mapping.containerId);
    }
  });

  // Call connection status handling
  const callConnection = document.getElementById('callConnection');
  const connectedFields = document.getElementById('connectedFields');

  function toggleConnectedFields() {
    if (callConnection && callConnection.value === 'Connected') {
      connectedFields.style.display = 'block';
      connectedFields.querySelectorAll('[required]').forEach(el => {
        el.required = false;
      });
    } else {
      connectedFields.style.display = 'none';
      connectedFields.querySelectorAll('[required]').forEach(el => {
        el.required = false;
      });
    }
  }

  if (callConnection) {
    callConnection.addEventListener('change', toggleConnectedFields);
    // Initialize on load
    toggleConnectedFields();
  }

  // Selection status handling
  const selectionStatus = document.getElementById('selectionStatus');
  const selectionFields = document.getElementById('selectionFields');
  const joiningStatus = document.getElementById('joiningStatus');
  const joinedFields = document.getElementById('joinedFields');

  function toggleSelectionFields() {
    if (!selectionStatus) return;

    const isSelected = selectionStatus.value === 'Selected';
    selectionFields.style.display = isSelected ? 'block' : 'none';
    
    if (isSelected && joiningStatus && joiningStatus.value === 'Joined') {
      joinedFields.style.display = 'block';
      joinedFields.querySelectorAll('[required]').forEach(el => {
        el.required = false;
      });
    } else {
      joinedFields.style.display = 'none';
      joinedFields.querySelectorAll('[required]').forEach(el => {
        el.required = false;
      });
    }
  } 

  if (selectionStatus) {
    selectionStatus.addEventListener('change', toggleSelectionFields);
    // Initialize on load
    toggleSelectionFields();
  }

  if (joiningStatus) {
    joiningStatus.addEventListener('change', toggleSelectionFields);
  }

  // Date validation for selection and joining dates
  const selectionDateInput = document.querySelector('input[name="selection_date"]');
  const joiningDateInput = document.querySelector('input[name="candidate_joining_date"]');
  const payoutDateInput = document.querySelector('input[name="payout_date"]');

  function validateSelectionDates() {
    if (selectionDateInput && selectionDateInput.value && joiningDateInput && joiningDateInput.value) {
      const selectionDate = new Date(selectionDateInput.value);
      const joiningDate = new Date(joiningDateInput.value);
      
      if (joiningDate < selectionDate) {
        joiningDateInput.setCustomValidity('Joining date must be after selection date');
      } else {
        joiningDateInput.setCustomValidity('');
      }
      joiningDateInput.reportValidity();
    }
    
    if (joiningDateInput && joiningDateInput.value && payoutDateInput && payoutDateInput.value) {
      const joiningDate = new Date(joiningDateInput.value);
      const payoutDate = new Date(payoutDateInput.value);
      
      if (payoutDate < joiningDate) {
        payoutDateInput.setCustomValidity('Payout date must be after joining date');
      } else {
        payoutDateInput.setCustomValidity('');
      }
      payoutDateInput.reportValidity();
    }
  }

  if (selectionDateInput) selectionDateInput.addEventListener('change', validateSelectionDates);
  if (joiningDateInput) joiningDateInput.addEventListener('change', validateSelectionDates);
  if (payoutDateInput) payoutDateInput.addEventListener('change', validateSelectionDates);

  // Character counter for remarks
  const remarkTextarea = document.querySelector('textarea[name="calling_remark"]');
  const remarkCounter = document.getElementById('remarkCounter');

  if (remarkTextarea && remarkCounter) {
    remarkTextarea.addEventListener('input', function() {
      const remaining = 500 - this.value.length;
      remarkCounter.textContent = remaining;
      
      if (remaining < 0) {
        this.setCustomValidity('Maximum 500 characters allowed');
      } else {
        this.setCustomValidity('');
      }
      this.reportValidity();
    });
    
    // Initialize counter
    remarkTextarea.dispatchEvent(new Event('input'));
  }

  // Salary validation
  const currentSalaryInput = document.querySelector('input[name="current_salary"]');
  const expectedSalaryInput = document.querySelector('input[name="expected_salary"]');
  
  function validateSalaries() {
    if (currentSalaryInput && expectedSalaryInput) {
      const currentSalary = parseFloat(currentSalaryInput.value) || 0;
      const expectedSalary = parseFloat(expectedSalaryInput.value) || 0;
      
      if (expectedSalary > 0 && currentSalary > 0 && expectedSalary < currentSalary) {
        expectedSalaryInput.setCustomValidity('Expected salary should be equal to or higher than current salary');
      } else {
        expectedSalaryInput.setCustomValidity('');
      }
      expectedSalaryInput.reportValidity();
    }
  }
  
  if (currentSalaryInput) currentSalaryInput.addEventListener('input', validateSalaries);
  if (expectedSalaryInput) expectedSalaryInput.addEventListener('input', validateSalaries);

  // File validation
  function validateFileInput(input, maxSizeMB, validTypes, errorMessage) {
    if (input.files.length > 0) {
      const file = input.files[0];
      const fileSize = file.size / 1024 / 1024; // in MB
      
      if (!validTypes.includes(file.type)) {
        input.setCustomValidity(errorMessage);
      } else if (fileSize > maxSizeMB) {
        input.setCustomValidity(`File size should not exceed ${maxSizeMB}MB`);
      } else {
        input.setCustomValidity('');
      }
      input.reportValidity();
    }
  }

  const photoInput = document.querySelector('input[name="candidate_photo"]');
  if (photoInput) {
    photoInput.addEventListener('change', function() {
      validateFileInput(
        this, 
        2, 
        ['image/jpeg', 'image/png', 'image/gif'], 
        'Please upload an image file (JPEG, PNG, GIF)'
      );
    });
  }

  const resumeInput = document.querySelector('input[name="candidate_resume"]');
  if (resumeInput) {
    resumeInput.addEventListener('change', function() {
      validateFileInput(
        this, 
        5, 
        ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'], 
        'Please upload a PDF or Word document'
      );
    });
  }

  // Form submission
  form.addEventListener('submit', function(event) {
    if (!checkChanges() || !form.checkValidity()) {
      event.preventDefault();
      event.stopPropagation();
      
      // Find the first invalid field and scroll to it
      const firstInvalid = form.querySelector(':invalid');
      if (firstInvalid) {
        firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
        firstInvalid.focus();
      }
    }
    
    form.classList.add('was-validated');
  }, false);
});
</script>
<div class="modal modal-blur fade" id="modal-vendor-data" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Vendor Data</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="post" enctype="multipart/form-data" id="vendorDataForm" novalidate>
          {% csrf_token %}
          <div class="row">
            <!-- admin status -->
            <div class="col-md-6 mb-3">
              <label class="form-label">Admin Status <span class="text-danger">*</span></label>
              <select class="form-select" name="admin_status" >
                <option value="" disabled selected>Select Admin Status</option>
                <option value="Pending" {% if candidate.admin_status == "Pending" %}selected{% endif %}>Pending</option>
                <option value="Complete" {% if candidate.admin_status == "Complete" %}selected{% endif %}>Complete</option>
                <option value="Failed" {% if candidate.admin_status == "Failed" %}selected{% endif %}>Failed</option>
                <option value="In Process" {% if candidate.admin_status == "In Process" %}selected{% endif %}>In Process</option>
              </select>
              <div class="invalid-feedback">
                Please select admin status
              </div>
            </div>
            <!-- Vendor Commission -->
            <div class="col-md-6 mb-3">
              <label class="form-label">Vendor Commission (₹) <span class="text-danger">*</span></label>
              <input type="number" name="vendor_commission" class="form-control" 
                     value="{{ candidate.vendor_commission|default:0 }}" 
                     min="0" step="1">
              <div class="invalid-feedback">
                Please enter a valid commission amount (minimum ₹0)
              </div>
            </div>

            <!-- Expected Vendor Payout Date -->
            <div class="col-md-6 mb-3">
              <label class="form-label">Commission Generate Date <span class="text-danger">*</span></label>
              <input type="date" name="commission_generation_date" class="form-control" 
                     value="{{ candidate.commission_generation_date|date:'Y-m-d' }}" 
                     >
              <div class="invalid-feedback">
                Please select a valid date
              </div>
            </div>
            
            <!-- Expected Vendor Payout Date -->
            <div class="col-md-6 mb-3">
              <label class="form-label">Expected Vendor Payout Date <span class="text-danger">*</span></label>
              <input type="date" name="vendor_payout_date" class="form-control" 
                     value="{{ candidate.vendor_payout_date|date:'Y-m-d' }}" 
                     >
              <div class="invalid-feedback">
                Please select a valid future date
              </div>
            </div>
            
            <!-- Payment Status -->
            <div class="col-md-6 mb-3">
              <label class="form-label">Payment Status <span class="text-danger">*</span></label>
              <select class="form-select" name="vendor_commission_status" >
                <option value="" disabled selected>Select Payment Status</option>
                <option value="Complete" {% if candidate.vendor_commission_status == "Complete" %}selected{% endif %}>Complete</option>
                <option value="Failed" {% if candidate.vendor_commission_status == "Failed" %}selected{% endif %}>Failed</option>
                <option value="In Process" {% if candidate.vendor_commission_status == "In Process" %}selected{% endif %}>In Process</option>
                <option value="Pending" {% if candidate.vendor_commission_status == "Pending" %}selected{% endif %}>Pending</option>
              </select>
              <div class="invalid-feedback">
                Please select payment status
              </div>
            </div>

            <!-- Payment Done By -->
            <div class="col-md-6 mb-3">
              <label class="form-label">Payment Done By</label>
              <input type="text" name="payment_done_by" class="form-control" 
                     value="{{ candidate.payment_done_by|default:request.user.get_full_name }}">
              <div class="invalid-feedback">
                Please enter who processed this payment
              </div>
            </div>

            <!-- Payment Done Date -->
            <div class="col-md-6 mb-3">
              <label class="form-label">Payment Done Date</label>
              <input type="date" name="payment_done_by_date" class="form-control" 
                     value="{{ candidate.payment_done_by_date|date:'Y-m-d' }}"
                     max="{% now 'Y-m-d' %}">
              <div class="invalid-feedback">
                Please select a valid date (cannot be future date)
              </div>
            </div>

            <!-- Payment Receipt Upload -->
            <div class="col-md-12 mb-3">
              <label class="form-label">Payment Receipt</label>
              <input type="file" name="submit_recipt" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
              {% if candidate.submit_recipt %}
                <div class="mt-2">
                  <small class="text-muted">Current file: 
                    <a href="{{ candidate.submit_recipt.url }}" target="_blank">View Receipt</a>
                  </small>
                </div>
              {% endif %}
              <div class="invalid-feedback">
                Please upload a valid receipt (PDF, JPG, PNG)
              </div>
            </div>

            <!-- Vendor Remark for Payment -->
            <div class="col-md-12 mb-3">
              <label class="form-label">Vendor Remark for Payment <span class="text-danger">*</span></label>
              <textarea class="form-control" name="vendor_payment_remark" rows="3"  maxlength="500">{{ candidate.vendor_payment_remark }}</textarea>
              <div class="invalid-feedback">
                Please enter Vendor Remark for Payments (max 500 characters)
              </div>
            </div>
          </div>
          
          <!-- Submit and Cancel Buttons -->
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" name="submit_vendor_related_data" class="btn btn-primary">Submit</button>
          </div>
        </form>

        <script>
        // Client-side form validation
        document.addEventListener('DOMContentLoaded', function() {
          const form = document.getElementById('vendorDataForm');
          const today = new Date().toISOString().split('T')[0];
          
          
          
          // Set max date for payment done date (today)
          const paymentDoneDateInput = form.querySelector('input[name="payment_done_by_date"]');
          paymentDoneDateInput.max = today;
          
          form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
              event.preventDefault();
              event.stopPropagation();
            }
            
            // Additional validation for commission when status is Complete
            const commission = parseFloat(form.querySelector('input[name="vendor_commission"]').value);
            const status = form.querySelector('select[name="vendor_commission_status"]').value;
            
            if (status === "Complete") {
              // Validate commission is positive
              if (isNaN(commission) || commission <= 0) {
                const commissionInput = form.querySelector('input[name="vendor_commission"]');
                commissionInput.setCustomValidity('Commission must be positive when status is Complete');
                commissionInput.classList.add('is-invalid');
                event.preventDefault();
              }
              
              // Validate payment done by 
              const paymentDoneBy = form.querySelector('input[name="payment_done_by"]').value;
              if (!paymentDoneBy) {
                const paymentDoneByInput = form.querySelector('input[name="payment_done_by"]');
                paymentDoneByInput.setCustomValidity('Payment processor name is required when status is Complete');
                paymentDoneByInput.classList.add('is-invalid');
                event.preventDefault();
              }
              
              // Validate payment done date is not empty
              const paymentDoneDate = form.querySelector('input[name="payment_done_by_date"]').value;
              if (!paymentDoneDate) {
                const paymentDoneDateInput = form.querySelector('input[name="payment_done_by_date"]');
                paymentDoneDateInput.setCustomValidity('Payment date is required when status is Complete');
                paymentDoneDateInput.classList.add('is-invalid');
                event.preventDefault();
              }
            }
            
            form.classList.add('was-validated');
          }, false);
          
          // Clear validation when inputs change
          form.querySelectorAll('input, select').forEach(input => {
            input.addEventListener('change', function() {
              this.setCustomValidity('');
              this.classList.remove('is-invalid');
            });
          });
          
          // Auto-fill payment done by with current user's name if empty
          const paymentDoneByInput = form.querySelector('input[name="payment_done_by"]');
          if (!paymentDoneByInput.value) {
            paymentDoneByInput.value = "{{ request.user.get_full_name }}";
          }
          
          // Auto-fill payment done date with today if empty and status is Complete
          const statusSelect = form.querySelector('select[name="vendor_commission_status"]');
          statusSelect.addEventListener('change', function() {
            if (this.value === "Complete" && !paymentDoneDateInput.value) {
              paymentDoneDateInput.value = today;
            }
          });
        });
        </script>
      </div>
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="modal-invoice-data" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Invoice Data</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="post" enctype="multipart/form-data" id="invoiceDataForm" novalidate>
          {% csrf_token %}
          <div class="row">

            <!-- Invoice Number -->
            <div class="col-md-6 mb-3">
              <label class="form-label">Invoice Number</label>
              <input type="text" name="invoice_number" class="form-control" 
                     value="{{ candidate.invoice_number|default:'' }}">
              <div class="invalid-feedback">
                Please enter a valid invoice number
              </div>
            </div>
            
            <!-- Invoice Status -->
            <div class="col-md-6 mb-3">
              <label class="form-label">Invoice Status <span class="text-danger">*</span></label>
              <select class="form-select" name="invoice_status" >
                <option value="" disabled selected>Select Invoice Status</option>
                <option value="Complete" {% if candidate.invoice_status == "Complete" %}selected{% endif %}>Complete</option>
                <option value="Failed" {% if candidate.invoice_status == "Failed" %}selected{% endif %}>Failed</option>
                <option value="In Process" {% if candidate.invoice_status == "In Process" %}selected{% endif %}>In Process</option>
                <option value="Pending" {% if candidate.invoice_status == "Pending" %}selected{% endif %}>Pending</option>
              </select>
              <div class="invalid-feedback">
                Please select invoice status
              </div>
            </div>

            <!-- Invoice Paid Status -->
            <div class="col-md-6 mb-3">
              <label class="form-label">Invoice Paid Status <span class="text-danger">*</span></label>
              <select class="form-select" name="invoice_paid_status" >
                <option value="" disabled selected>Select Invoice Paid Status</option>
                <option value="Paid" {% if candidate.invoice_paid_status == "Paid" %}selected{% endif %}>Paid</option>
                <option value="Unpaid" {% if candidate.invoice_paid_status == "Unpaid" %}selected{% endif %}>Unpaid</option>
                <option value="Hold" {% if candidate.invoice_paid_status == "Hold" %}selected{% endif %}>Hold</option>
              </select>
              <div class="invalid-feedback">
                Please select invoice paid status
              </div>
            </div>

            <!-- Invoice Date -->
            <div class="col-md-6 mb-3">
              <label class="form-label">Invoice Date</label>
              <input type="date" name="invoice_date" class="form-control" 
                     value="{{ candidate.invoice_date|date:'Y-m-d' }}"
                     max="{% now 'Y-m-d' %}">
              <div class="invalid-feedback">
                Please select a valid date (cannot be future date)
              </div>
            </div>

            <!-- Invoice Amount -->
            <div class="col-md-6 mb-3">
              <label class="form-label">Invoice Amount</label>
              <input type="number" name="invoice_amount" class="form-control" 
                     value="{{ candidate.invoice_amount|default:0 }}"
                     max="{% now 'Y-m-d' %}">
              <div class="invalid-feedback">
                Please enter a valid invoice amount (minimum ₹0)
              </div>
            </div>

            <!-- Payment Receipt Upload -->
            <div class="col-md-6 mb-3">
              <label class="form-label">Invoice Attachment</label>
              <input type="file" name="invoice_attachment" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
              {% if candidate.invoice_attachment %}
                <div class="mt-2">
                  <small class="text-muted">Current file: 
                    <a href="{{ candidate.invoice_attachment.url }}" target="_blank">View Attachment</a>
                  </small>
                </div>
              {% endif %}
              <div class="invalid-feedback">
                Please upload a valid invoice attachment (PDF, JPG, PNG)
              </div>
            </div>

            <!-- Invoice Remark -->
            <div class="col-md-12 mb-3">
              <label class="form-label">Invoice Remark <span class="text-danger">*</span></label>
              <textarea class="form-control" name="invoice_remark" rows="3"  maxlength="500">{{ candidate.invoice_remark }}</textarea>
              <div class="invalid-feedback">
                Please enter Invoice Remark (max 500 characters)
              </div>
            </div>
          </div>
          
          <!-- Submit and Cancel Buttons -->
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" name="invoice_releted_data" class="btn btn-primary">Submit</button>
          </div>
        </form>

        <script>
        // Client-side form validation
        document.addEventListener('DOMContentLoaded', function() {
          const form = document.getElementById('invoiceDataForm');
          const today = new Date().toISOString().split('T')[0];
          
          
          
          // Set max date for payment done date (today)
          const paymentDoneDateInput = form.querySelector('input[name="payment_done_by_date"]');
          paymentDoneDateInput.max = today;
          
          form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
              event.preventDefault();
              event.stopPropagation();
            }
            
            // Additional validation for commission when status is Complete
            const commission = parseFloat(form.querySelector('input[name="vendor_commission"]').value);
            const status = form.querySelector('select[name="vendor_commission_status"]').value;
            
            if (status === "Complete") {
              // Validate commission is positive
              if (isNaN(commission) || commission <= 0) {
                const commissionInput = form.querySelector('input[name="vendor_commission"]');
                commissionInput.setCustomValidity('Commission must be positive when status is Complete');
                commissionInput.classList.add('is-invalid');
                event.preventDefault();
              }
              
              // Validate payment done by 
              const paymentDoneBy = form.querySelector('input[name="payment_done_by"]').value;
              if (!paymentDoneBy) {
                const paymentDoneByInput = form.querySelector('input[name="payment_done_by"]');
                paymentDoneByInput.setCustomValidity('Payment processor name is required when status is Complete');
                paymentDoneByInput.classList.add('is-invalid');
                event.preventDefault();
              }
              
              // Validate payment done date is not empty
              const paymentDoneDate = form.querySelector('input[name="payment_done_by_date"]').value;
              if (!paymentDoneDate) {
                const paymentDoneDateInput = form.querySelector('input[name="payment_done_by_date"]');
                paymentDoneDateInput.setCustomValidity('Payment date is required when status is Complete');
                paymentDoneDateInput.classList.add('is-invalid');
                event.preventDefault();
              }
            }
            
            form.classList.add('was-validated');
          }, false);
          
          // Clear validation when inputs change
          form.querySelectorAll('input, select').forEach(input => {
            input.addEventListener('change', function() {
              this.setCustomValidity('');
              this.classList.remove('is-invalid');
            });
          });
          
          // Auto-fill payment done by with current user's name if empty
          const paymentDoneByInput = form.querySelector('input[name="payment_done_by"]');
          if (!paymentDoneByInput.value) {
            paymentDoneByInput.value = "{{ request.user.get_full_name }}";
          }
          
          // Auto-fill payment done date with today if empty and status is Complete
          const statusSelect = form.querySelector('select[name="vendor_commission_status"]');
          statusSelect.addEventListener('change', function() {
            if (this.value === "Complete" && !paymentDoneDateInput.value) {
              paymentDoneDateInput.value = today;
            }
          });
        });
        </script>
      </div>
    </div>
  </div>
</div>