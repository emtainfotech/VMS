<div class="border rounded p-3">
    <h5>All Activities by {{ employee.first_name }} {{ employee.last_name }} ({{ employee.user.username }})</h5>
    
    {% if processed_activities %}
    <table id="activity-table" class="table table-sm table-striped mt-3">
        <thead>
            <tr>
                <th>S.No</th>
                <th>Candidate Name</th>
                <th>Activity Type</th>
                <th>Activity Time</th>
                <th>Historical Call Status</th>
                <th>Historical Lead Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for item in processed_activities %}
                {% if item.type == 'gap' %}
                    <tr>
                        <td colspan="7" class="text-center text-muted fst-italic py-2" style="background-color: #f8f9fa; border-top: 1px dashed #ccc; border-bottom: 1px dashed #ccc;">
                            &mdash; {{ item.duration }} &mdash;
                        </td>
                    </tr>
                {% elif item.type == 'activity' %}
                    {% with activity=item.data %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ activity.candidate.candidate_name }}</td>
                        <td>
                            {% if activity.action == 'call_made' %}
                                <span class="badge bg-blue-lt">Call Made</span>
                            {% elif activity.action == 'created' %}
                                <span class="badge bg-green-lt">Created</span>
                            {% else %}
                                <span class="badge bg-secondary-lt">{{ activity.action }}</span>
                            {% endif %}
                        </td>
                        <td class="activity-timestamp">{{ activity.timestamp|date:"M d, Y H:i" }}</td>
                        <td>
                            {% with logged_status=activity.changes.call_connection.new %}
                                {% if activity.action == 'call_made' and logged_status is not None %}
                                    {% if logged_status == 'Connected' %}
                                        <span class="badge bg-success me-1"></span> Connected
                                    {% else %}
                                        <span class="badge bg-danger me-1"></span> {{ logged_status }}
                                    {% endif %}
                                {% else %}
                                    {% if activity.candidate.call_connection == 'Connected' %}
                                        <span class="badge bg-success me-1"></span> Connected
                                    {% elif activity.candidate.call_connection %}
                                        <span class="badge bg-danger me-1"></span> {{ activity.candidate.call_connection }}
                                    {% else %}
                                        <span class="badge bg-secondary me-1"></span> N/A
                                    {% endif %}
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td>
                            {% with lead_status=activity.changes.lead_generate.new %}
                                {% if activity.action == 'call_made' and lead_status is not None %}
                                    {% if lead_status == 'Hot' or lead_status == 'Converted' %}
                                        <span class="badge bg-warning-lt">{{ lead_status }}</span>
                                    {% else %}
                                        {{ activity.candidate.calling_remark }}
                                    {% endif %}
                                {% else %}
                                    {{ activity.candidate.lead_generate|default:'-' }}
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td>
                            <a href="{% url 'admin_candidate_profile' activity.candidate.id %}" class="btn btn-sm btn-outline-primary">View Profile</a>
                        </td>
                    </tr>
                    {% endwith %}
                {% endif %}
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted mt-3">No activities found for this employee in the selected period.</p>
    {% endif %}
</div>