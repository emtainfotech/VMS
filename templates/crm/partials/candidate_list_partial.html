<div class="border rounded p-3">
    <h5>All Activities by {{ employee.first_name }} {{ employee.last_name }} ({{ employee.user.username }})</h5>
    {% if activities %}
    <table id="activity-table" class="table table-sm table-striped mt-3">
        <thead>
            <tr>
                <th>S.No</th>
                <th>Candidate Name</th>
                <th>Activity Type</th>
                <th>Activity Time</th>
                <th>Historical Call Status</th>
                <th>Historical Lead Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for activity in activities %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ activity.candidate.candidate_name }}</td>
                <td>
                    {% if activity.action == 'call_made' %}
                        <span class="badge bg-blue-lt">Call Made</span>
                    {% elif activity.action == 'created' %}
                        <span class="badge bg-green-lt">Created</span>
                    {% else %}
                        <span class="badge bg-secondary-lt">{{ activity.action }}</span>
                    {% endif %}
                </td>
                <td class="activity-timestamp">{{ activity.timestamp|date:"M d, Y H:i" }}</td>
                <td>
                    {% with logged_status=activity.changes.call_connection.new %}
                        {% if activity.action == 'call_made' and logged_status is not None %}
                            {% if logged_status == 'Connected' %}
                                <span class="badge bg-success me-1"></span> Connected
                            {% else %}
                                <span class="badge bg-danger me-1"></span> {{ logged_status }}
                            {% endif %}
                        {% else %}
                            {% if activity.candidate.call_connection == 'Connected' %}
                                <span class="badge bg-success me-1"></span> Connected
                            {% elif activity.candidate.call_connection %}
                                <span class="badge bg-danger me-1"></span> {{ activity.candidate.call_connection }}
                            {% else %}
                                <span class="badge bg-secondary me-1"></span> N/A
                            {% endif %}
                        {% endif %}
                    {% endwith %}
                </td>
                <td>
                    {% with lead_status=activity.changes.lead_generate.new %}
                        {% if activity.action == 'call_made' and lead_status is not None %}
                            {% if lead_status == 'Hot' or lead_status == 'Converted' %}
                                <span class="badge bg-warning-lt">{{ lead_status }}</span>
                            {% else %}
                                {{ activity.candidate.calling_remark }}
                            {% endif %}
                        {% else %}
                            {{ activity.candidate.lead_generate|default:'-' }}
                        {% endif %}
                    {% endwith %}
                </td>
                <td>
                    <a href="{% url 'admin_candidate_profile' activity.candidate.id %}" class="btn btn-sm btn-outline-primary">View Profile</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted mt-3">No activities found for this employee in the selected period.</p>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('activity-table');
    if (!table) return; // Exit if the table doesn't exist

    const tbody = table.querySelector('tbody');
    if (!tbody) return; // Exit if there's no table body

    const rows = tbody.querySelectorAll('tr');
    // Ensure there are at least 2 rows to compare
    if (rows.length < 2) return;

    const columnCount = table.querySelector('thead tr').children.length;
    const timeGapThreshold = 20; // Time difference in minutes

    // Loop through rows from the second one to the end
    for (let i = 1; i < rows.length; i++) {
        const currentRow = rows[i];
        const previousRow = rows[i - 1];

        // Get the timestamp cells.
        const currentTimeCell = currentRow.querySelector('.activity-timestamp');
        const previousTimeCell = previousRow.querySelector('.activity-timestamp');

        if (currentTimeCell && previousTimeCell) {
            // Parse the text content into Date objects
            const previousTime = new Date(previousTimeCell.textContent.trim());
            const currentTime = new Date(currentTimeCell.textContent.trim());

            // Check if dates are valid before comparing
            if (!isNaN(previousTime) && !isNaN(currentTime)) {
                // Calculate the difference in minutes
                const diffMs = previousTime - currentTime; // Difference in milliseconds
                const diffMinutes = Math.abs(diffMs / (1000 * 60));

                // If the difference is greater than the threshold, insert a separator
                if (diffMinutes > timeGapThreshold) {
                    const separatorRow = document.createElement('tr');
                    const separatorCell = document.createElement('td');
                    
                    separatorCell.setAttribute('colspan', columnCount);
                    separatorCell.innerHTML = '|'; // The separator character
                    separatorCell.style.textAlign = 'center';
                    separatorCell.style.border = 'none';
                    separatorCell.style.padding = '4px 0';
                    separatorCell.style.color = '#adb5bd'; // A muted color

                    separatorRow.appendChild(separatorCell);

                    // Insert the new separator row before the current row
                    tbody.insertBefore(separatorRow, currentRow);
                }
            }
        }
    }
});
</script>