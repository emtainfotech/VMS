<div class="card mt-4">
    <div class="card-header">
        <h3 class="card-title">{{ list_title }}</h3>
        <div class="ms-auto">
            <button class="btn btn-sm btn-close" id="close-details-table" aria-label="Close"></button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table card-table table-vcenter text-nowrap table-striped table-hover">
            <thead>
                <tr>
                    <th>S.No</th>
                    <th>Employee Name</th>
                    <th>Candidate Name</th>
                    <th>Activity Type</th>
                    <th>Activity Time</th>
                    <th>Historical Call Status</th>
                    <th>Historical Lead Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for activity in activities %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>
                        {% if activity.employee and activity.employee.user %}
                            {{ activity.employee.first_name }} {{ activity.employee.last_name }} ({{ activity.employee.user.username }})
                        {% else %}
                            <span class="text-muted fst-italic">Unknown Employee</span>
                        {% endif %}
                    </td>
                    <td>{{ activity.candidate.candidate_name }}</td>
                    <td>
                        {% if activity.action == 'call_made' %}
                            <span class="badge bg-blue-lt">Call Made</span>
                        {% elif activity.action == 'created' %}
                            <span class="badge bg-green-lt">Created</span>
                        {% endif %}
                    </td>
                    <td>{{ activity.timestamp|date:"M d, Y H:i" }}</td>
                    <td>
                        {% with logged_status=activity.changes.call_connection.new %}
                            {% if activity.action == 'call_made' and logged_status is not None %}
                                {% if logged_status == 'Connected' %}
                                    <span class="badge bg-success me-1"></span> Connected
                                {% else %}
                                    <span class="badge bg-danger me-1"></span> {{ logged_status }}
                                {% endif %}
                            {% else %}
                                {% if activity.candidate.call_connection == 'Connected' %}
                                    <span class="badge bg-success me-1"></span> Connected
                                {% else %}
                                    <span class="badge bg-danger me-1"></span> {{ activity.candidate.call_connection|default:'N/A' }}
                                {% endif %}
                            {% endif %}
                        {% endwith %}
                    </td>
                    <td>
                        {% with lead_status=activity.changes.lead_generate.new %}
                            {% if activity.action == 'call_made' and lead_status is not None %}
                                {# Show the status from the historical log #}
                                {% if lead_status == 'Hot' or lead_status == 'Converted' %}
                                    <span class="badge bg-warning-lt">{{ lead_status }}</span>
                                {% else %}
                                    {{ lead_status|default:'-' }}
                                {% endif %}
                            {% else %}
                                {# For 'created' events, show the candidate's current status #}
                                {{ activity.candidate.lead_generate|default:'-' }}
                            {% endif %}
                        {% endwith %}
                    </td>
                    <td class="text-end">
                        <a href="{% url 'admin_candidate_profile' activity.candidate.id %}" class="btn btn-sm btn-outline-primary">View Profile</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center">No activities found matching this criteria.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>