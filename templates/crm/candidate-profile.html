{% extends 'crm/base.html' %}

{% block content %}

<style>
    .card {
      border: none;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .object-cover {
      object-fit: cover;
    }
    .card-body h3 {
      font-size: 1.5rem;
      font-weight: 600;
    }
    .card-body .btn {
      background-color: #6c63ff;
      color: #fff;
      font-weight: 500;
    }
    .card-body .btn:hover {
      background-color: #574bce;
    }
    .edit-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
      color: #6c63ff;
    }
    .detail-label {
      color: #6c757d;
      font-size: 0.85rem;
    }
    .detail-value {
      font-weight: 500;
      margin-bottom: 10px;
    }
    .empty-value {
      color: #adb5bd;
      font-style: italic;
    }
    .badge-custom {
      background-color: #e9ecef;
      color: #495057;
      font-weight: normal;
      margin-right: 5px;
      margin-bottom: 5px;
    }
    .timeline {
      position: relative;
      padding-left: 40px;
    }
    .timeline-item {
      position: relative;
      padding-bottom: 20px;
    }
    .timeline-line {
      position: absolute;
      left: 19px;
      top: 0;
      bottom: 0;
      width: 2px;
      background-color: #e9ecef;
    }
    .timeline-icon {
      position: absolute;
      left: 0;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #dee2e6;
    }
    .timeline-content {
      padding-left: 20px;
    }
    .fixed-candidate-info {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1030;
        background-color: #ffffff;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border: 1px solid #e0e0e0;
        width: 280px;
        transition: top 0.3s ease-in-out;
    }
    .fixed-candidate-info h5 {
        font-weight: 600;
        color: #333;
    }
  </style>

<div class="fixed-candidate-info">
    <h5 class="mb-1">{{ candidate.candidate_name }}</h5>
    <p class="mb-0 text-muted small">
        <i class="bi bi-telephone-fill me-2"></i>{{ candidate.candidate_mobile_number }}
    </p>
</div>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center py-3">
        <h4 class="sticky-top">Candidate Details <span class="text-muted small">- {{candidate.candidate_name|default:"-"}} ({{candidate.candidate_mobile_number|default:"-"}})</span></h4>
        <div>
            <a href="{% url 'admin_candidate_chat_list' candidate.id %}" class="btn btn-sm btn-outline-primary me-2">
                <i class="bi bi-chat-left-text"></i> Chat
            </a>
            <a href="{% url 'admin_interview_list' candidate.id %}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-calendar-check"></i> Interviews
            </a>
        </div>
    </div>
    
    <div class="row g-4">
        <!-- Personal Information Card -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center ">
                    <h5 class="mb-0">Personal Information</h5>
                    <a href="#" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modal-candidate">
                        <i class="bi bi-pencil"></i> Edit
                    </a>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-column flex-md-row gap-4 align-items-start">
                        <!-- Candidate Photo -->
                        <div class="text-center">
    
    
                            {% if candidate.candidate_photo %}
                            <img src="{{candidate.candidate_photo.url}}" 
                                 class="rounded-circle object-cover border" 
                                 style="width: 120px; height: 120px;" 
                                 alt="Candidate Photo">
                            {% else %}
                            <div class="d-flex align-items-center justify-content-center  rounded-circle border" 
                                 style="width: 120px; height: 120px;">
                                <span class="text-muted small">No Photo</span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Candidate Details -->
                        <div class="flex-grow-1">
                            <h3 class="mb-2">{{ candidate.candidate_name|default:"-" }}</h3>
                            <p class="text-muted mb-3 small">ID: {{ candidate.unique_code|default:"-" }}</p>
                            
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <span class="d-block detail-label">Mobile Number</span>
                                        <span class="detail-value">{{ candidate.candidate_mobile_number|default:"-" }}</span>
                                    </div>
                                    <div class="mb-3">
                                        <span class="d-block detail-label">Alternate Mobile</span>
                                        <span class="detail-value">{{ candidate.candidate_alternate_mobile_number|default:"-" }}</span>
                                    </div>
                                    <div class="mb-3">
                                        <span class="d-block detail-label">Email</span>
                                        <span class="detail-value">{{ candidate.candidate_email_address|default:"-" }}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <span class="d-block detail-label">Gender</span>
                                        <span class="detail-value">{{ candidate.gender|default:"-" }}</span>
                                    </div>
                                    <div class="mb-3">
                                        <span class="d-block detail-label">Source</span>
                                        <span class="detail-value">
                                            {% if candidate.lead_source == 'Other' and candidate.other_lead_source %}
                                                {{ candidate.other_lead_source }}
                                            {% else %}
                                                {{ candidate.lead_source|default:"-" }}
                                            {% endif %}
                                        </span>
                                    </div>
                                    <div class="mb-3">
                                        <span class="d-block detail-label">Registered</span>
                                        <span class="detail-value">{{ candidate.register_time|date:"M d, Y"|default:"-" }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <span class="d-block detail-label">Address</span>
                                {% if candidate.other_origin_location %}
                                    <span class="detail-value">{{ candidate.other_origin_location }}</span>
                                {% else %}
                                    <span class="detail-value">{{ candidate.origin_location|default:"-" }}</span>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <span class="d-block detail-label">Resume</span>
                                <span class="detail-value">
                                    {% if candidate.candidate_resume %}
                                    <a href="{{candidate.candidate_resume.url}}" target="_blank" class="text-primary">
                                        <i class="bi bi-file-earmark-text"></i> View Resume
                                    </a>
                                    {% else %}
                                    <span class="empty-value">No Resume</span>
                                    {% endif %}
                                </span>
                            </div>
                            
                            <div class="mb-3">
                                <span class="d-block detail-label">Follow-Up By</span>
                                <span class="detail-value">{{ candidate.employee_name|default:"-" }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Professional Details Card -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center ">
                    <h5 class="mb-0">Professional Details</h5>
                    <a href="#" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modal-candidate">
                        <i class="bi bi-pencil"></i> Edit
                    </a>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <span class="d-block detail-label">Preferred Location</span>
                                <span class="detail-value">{{ candidate.preferred_location|default:"-" }}</span>
                            </div>

                            <div class="mb-3">
                                <span class="d-block detail-label">Preferred State</span>
                                <span class="detail-value">{{ candidate.preferred_state|default:"-" }}</span>
                            </div>
                            
                            <div class="mb-3">
                                <span class="d-block detail-label">Highest Qualification</span>
                                <span class="detail-value">
                                    {% if candidate.qualification == 'Other' and candidate.other_qualification %}
                                        {{ candidate.other_qualification }}
                                    {% else %}
                                        {{ candidate.qualification|default:"-" }}
                                    {% endif %}
                                </span>
                            </div>
                            
                            <div class="mb-3">
                                <span class="d-block detail-label">Diploma</span>
                                <span class="detail-value">{{ candidate.diploma|default:"-" }}</span>
                            </div>
                            
                            <div class="mb-3">
                                <span class="d-block detail-label">Sector</span>
                                <span class="detail-value">{{ candidate.sector|default:"-" }}</span>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <span class="d-block detail-label">Department</span>
                                <span class="detail-value">{{ candidate.department|default:"-" }}</span>
                            </div>
                            
                            <div class="mb-3">
                                <span class="d-block detail-label">Experience</span>
                                <span class="detail-value">
                                    {{ candidate.experience_year|default:"0" }} years 
                                    {{ candidate.experience_month|default:"0" }} months
                                </span>
                            </div>
                            
                            <div class="mb-3">
                                <span class="d-block detail-label">Current Company</span>
                                <span class="detail-value">{{ candidate.current_company|default:"-" }}</span>
                            </div>
                            
                            <div class="mb-3">
                                <span class="d-block detail-label">Working Status</span>
                                <span class="detail-value">
                                    {% if candidate.current_working_status == 'Other' and candidate.other_working_status %}
                                        {{ candidate.other_working_status }}
                                    {% else %}
                                        {{ candidate.current_working_status|default:"-" }}
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <span class="d-block detail-label">Current Salary</span>
                                <span class="detail-value">{{ candidate.current_salary|default:"-" }}</span>
                                <span class="detail-value">{{ candidate.current_salary_type|default:"-" }}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <span class="d-block detail-label">Expected Salary</span>
                                <span class="detail-value">{{ candidate.expected_salary|default:"-" }}</span>
                                <span class="detail-value">{{ candidate.expected_salary_type|default:"-" }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calling & Follow-Up Card -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center ">
                    <h5 class="mb-0">Calling & Follow-Up</h5>
                    <a href="#" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modal-candidate">
                        <i class="bi bi-pencil"></i> Edit
                    </a>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <span class="d-block detail-label">Call Connection</span>
                                <span class="detail-value">
                                    {% if candidate.call_connection == 'Other' and candidate.other_call_connection %}
                                        {{ candidate.other_call_connection }}
                                    {% else %}
                                        {{ candidate.call_connection|default:"-" }}
                                    {% endif %}
                                </span>
                            </div>
                            
                            <div class="mb-3">
                                <span class="d-block detail-label">Calling Remark</span>
                                <span class="detail-value">{{ candidate.calling_remark|default:"-" }}</span>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <span class="d-block detail-label">Lead Status</span>
                                <span class="detail-value">
                                    {% if candidate.lead_generate == 'Other' and candidate.other_lead_generate %}
                                        {{ candidate.other_lead_generate }}
                                    {% else %}
                                        {{ candidate.lead_generate|default:"-" }}
                                    {% endif %}
                                </span>
                            </div>
                            
                            <div class="mb-3">
                                <span class="d-block detail-label">Interview Status</span>
                                <span class="detail-value">
                                    {% if candidate.send_for_interview == 'Other' and candidate.other_interview_status %}
                                        {{ candidate.other_interview_status }}
                                    {% else %}
                                        {{ candidate.send_for_interview|default:"-" }}
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <span class="d-block detail-label">Next Follow-Up</span>
                                <span class="detail-value">{{ candidate.next_follow_up_date_time|date:"M d, Y H:i"|default:"-" }}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <span class="d-block detail-label">Remarks</span>
                                <span class="detail-value">{{ candidate.remark|default:"-" }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Selection Status Card -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center ">
                    <h5 class="mb-0">Selection Status</h5>
                    <a href="#" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modal-candidate">
                        <i class="bi bi-pencil"></i> Edit
                    </a>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <span class="d-block detail-label">Selection Status</span>
                                <span class="detail-value">
                                    {% if candidate.selection_status == 'Other' and candidate.other_selection_status %}
                                        {{ candidate.other_selection_status }}
                                    {% else %}
                                        {{ candidate.selection_status|default:"-" }}
                                    {% endif %}
                                </span>
                            </div>
                            
                            <div class="mb-3">
                                <span class="d-block detail-label">Company</span>
                                <span class="detail-value">{{ candidate.company_name|default:"-" }}</span>
                            </div>
                            
                            <div class="mb-3">
                                <span class="d-block detail-label">Offered Salary</span>
                                <span class="detail-value">{{ candidate.offered_salary|default:"-" }}</span>
                            </div>
                            <div class="mb-3">
                                <span class="d-block detail-label">Payout Date</span>
                                <span class="detail-value">{{ candidate.payout_date|date:"M d, Y"|default:"-" }}</span>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <span class="d-block detail-label">Selection Date</span>
                                <span class="detail-value">{{ candidate.selection_date|date:"M d, Y"|default:"-" }}</span>
                            </div>
                            
                            <div class="mb-3">
                                <span class="d-block detail-label">Joining Date</span>
                                <span class="detail-value">{{ candidate.candidate_joining_date|date:"M d, Y"|default:"-" }}</span>
                            </div>
                            
                            <div class="mb-3">
                                <span class="d-block detail-label">Commission</span>
                                <span class="detail-value">{{ candidate.emta_commission|default:"-" }}</span>
                            </div>
                            
                            

                            <div class="mb-3">
                                <span class="d-block detail-label">Selection Remark</span>
                                <span class="detail-value">{{ candidate.selection_remark|default:"-" }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>

        <div class="container-fluid">
    <h2 class="mt-4">Candidate Profile: {{ candidate.candidate_name }}</h2>
    <hr>

    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}

    {# ... Your existing HTML for candidate details forms ... #}

    <div class="card my-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3>Interview Records</h3>
            <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addInterviewModal">
                Add New Interview
            </button>
        </div>
        <div class="card-body">
            

            {% if interviews %}
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Job Position</th>
                                <th>Date & Time</th>
                                <th>Mode</th>
                                <th>Status</th>
                                <th>Interviewer</th>
                                <th>Feedback</th>
                                <th>Rating</th>
                                <th>Attachment</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for interview in interviews %}
                                <tr>
                                    <td>{{ interview.company_name }}</td>
                                    <td>{{ interview.job_position }}</td>
                                    <td>{{ interview.interview_date_time|date:"Y-m-d H:i" }}</td>
                                    <td>{{ interview.get_interview_mode_display }}</td>
                                    <td>{{ interview.get_status_display }}</td>
                                    <td>{{ interview.interviewer_name }}</td>
                                    <td>{{ interview.feedback|truncatechars:50 }}</td>
                                    <td>{% if interview.rating %}{{ interview.rating }}/10{% else %}N/A{% endif %}</td>
                                    <td>
                                        {% if interview.attachment %}
                                            <a href="{{ interview.attachment.url }}" target="_blank">View</a>
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-info edit-interview-btn"
                                                data-bs-toggle="modal" data-bs-target="#editInterviewModal"
                                                data-id="{{ interview.id }}"
                                                data-company-name="{{ interview.company_name }}"
                                                data-job-position="{{ interview.job_position }}"
                                                data-date-time="{{ interview.interview_date_time|date:'Y-m-d\TH:i' }}"
                                                data-interviewer-name="{{ interview.interviewer_name }}"
                                                data-interviewer-email="{{ interview.interviewer_email }}"
                                                data-interviewer-phone="{{ interview.interviewer_phone }}"
                                                data-status="{{ interview.status }}"
                                                data-interview-mode="{{ interview.interview_mode }}"
                                                data-location="{{ interview.location }}"
                                                data-meeting-link="{{ interview.meeting_link }}"
                                                data-notes="{{ interview.notes }}"
                                                data-feedback="{{ interview.feedback }}"
                                                data-rating="{{ interview.rating }}"
                                                data-is-technical="{% if interview.is_technical %}true{% else %}false{% endif %}"
                                                data-duration="{{ interview.duration }}"
                                                data-requirements="{{ interview.requirements }}"
                                                data-attachment-url="{% if interview.attachment %}{{ interview.attachment.url }}{% else %}#{% endif %}"
                                                data-attachment-name="{% if interview.attachment %}{{ interview.attachment.name}}{% else %}None{% endif %}"
                                                >
                                            Edit
                                        </button>
                                        <button type="button" class="btn btn-sm btn-danger delete-interview-btn"
                                                data-bs-toggle="modal" data-bs-target="#deleteInterviewModal"
                                                data-id="{{ interview.id }}"
                                                data-company-name="{{ interview.company_name }}"
                                                data-job-position="{{ interview.job_position }}"
                                                >
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>No interview records found for this candidate.</p>
            {% endif %}
        </div>
    </div>

</div>

<div class="modal fade" id="addInterviewModal" tabindex="-1" aria-labelledby="addInterviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addInterviewModalLabel">Add New Interview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{% url 'admin_candidate_profile' id=candidate.id %}" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="add_interview_submit" value="true">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="interview_company_name" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="interview_company_name" name="interview_company_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="job_position" class="form-label">Job Position</label>
                            <input type="text" class="form-control" id="job_position" name="job_position" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="interview_date_time" class="form-label">Interview Date & Time</label>
                            <input type="datetime-local" class="form-control" id="interview_date_time" name="interview_date_time">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="interviewer_name" class="form-label">Interviewer Name</label>
                            <input type="text" class="form-control" id="interviewer_name" name="interviewer_name">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="interviewer_email" class="form-label">Interviewer Email</label>
                            <input type="email" class="form-control" id="interviewer_email" name="interviewer_email">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="interviewer_phone" class="form-label">Interviewer Phone</label>
                            <input type="text" class="form-control" id="interviewer_phone" name="interviewer_phone">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status" required>
                                {% for key, value in interview_statuses %}
                                    <option value="{{ key }}">{{ value }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="interview_mode" class="form-label">Interview Mode</label>
                            <select class="form-select" id="interview_mode" name="interview_mode" required>
                                {% for key, value in interview_modes %}
                                    <option value="{{ key }}">{{ value }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="location" name="location">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="meeting_link" class="form-label">Meeting Link</label>
                            <input type="url" class="form-control" id="meeting_link" name="meeting_link">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="feedback" class="form-label">Feedback</label>
                        <textarea class="form-control" id="feedback" name="feedback" rows="3"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="rating" class="form-label">Rating (out of 10)</label>
                            <input type="number" class="form-control" id="rating" name="rating" min="0" max="10">
                        </div>
                        <div class="col-md-6 d-flex align-items-end mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_technical" name="is_technical">
                                <label class="form-check-label" for="is_technical">
                                    Technical Interview
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="duration" class="form-label">Duration (minutes)</label>
                            <input type="number" class="form-control" id="duration" name="duration" min="1">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="interview_attachment" class="form-label">Attachment</label>
                            <input type="file" class="form-control" id="interview_attachment" name="interview_attachment">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="requirements" class="form-label">Special Requirements</label>
                        <textarea class="form-control" id="requirements" name="requirements" rows="2"></textarea>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Add Interview</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editInterviewModal" tabindex="-1" aria-labelledby="editInterviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editInterviewModalLabel">Edit Interview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{% url 'admin_candidate_profile' id=candidate.id %}" method="POST" enctype="multipart/form-data" id="editInterviewForm">
                    {% csrf_token %}
                    <input type="hidden" name="edit_interview_submit" value="true">
                    <input type="hidden" name="interview_id" id="edit_interview_id">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_interview_company_name" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="edit_interview_company_name" name="interview_company_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_job_position" class="form-label">Job Position</label>
                            <input type="text" class="form-control" id="edit_job_position" name="job_position" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_interview_date_time" class="form-label">Interview Date & Time</label>
                            <input type="datetime-local" class="form-control" id="edit_interview_date_time" name="interview_date_time">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_interviewer_name" class="form-label">Interviewer Name</label>
                            <input type="text" class="form-control" id="edit_interviewer_name" name="interviewer_name">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_interviewer_email" class="form-label">Interviewer Email</label>
                            <input type="email" class="form-control" id="edit_interviewer_email" name="interviewer_email">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_interviewer_phone" class="form-label">Interviewer Phone</label>
                            <input type="text" class="form-control" id="edit_interviewer_phone" name="interviewer_phone">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_status" class="form-label">Status</label>
                            <select class="form-select" id="edit_status" name="status" required>
                                {% for key, value in interview_statuses %}
                                    <option value="{{ key }}">{{ value }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_interview_mode" class="form-label">Interview Mode</label>
                            <select class="form-select" id="edit_interview_mode" name="interview_mode" required>
                                {% for key, value in interview_modes %}
                                    <option value="{{ key }}">{{ value }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="edit_location" name="location">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_meeting_link" class="form-label">Meeting Link</label>
                            <input type="url" class="form-control" id="edit_meeting_link" name="meeting_link">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="edit_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="edit_notes" name="notes" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="edit_feedback" class="form-label">Feedback</label>
                        <textarea class="form-control" id="edit_feedback" name="feedback" rows="3"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_rating" class="form-label">Rating (out of 10)</label>
                            <input type="number" class="form-control" id="edit_rating" name="rating" min="0" max="10">
                        </div>
                        <div class="col-md-6 d-flex align-items-end mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="edit_is_technical" name="is_technical">
                                <label class="form-check-label" for="edit_is_technical">
                                    Technical Interview
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_duration" class="form-label">Duration (minutes)</label>
                            <input type="number" class="form-control" id="edit_duration" name="duration" min="1">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_interview_attachment" class="form-label">Attachment</label>
                            <input type="file" class="form-control" id="edit_interview_attachment" name="interview_attachment">
                            <small id="currentAttachment" class="form-text text-muted">Current: <a id="edit_current_attachment_link" href="#" target="_blank"></a></small>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="clear_interview_attachment" name="clear_interview_attachment">
                                <label class="form-check-label" for="clear_interview_attachment">Clear current attachment</label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="edit_requirements" class="form-label">Special Requirements</label>
                        <textarea class="form-control" id="edit_requirements" name="requirements" rows="2"></textarea>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteInterviewModal" tabindex="-1" aria-labelledby="deleteInterviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteInterviewModalLabel">Delete Interview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the interview for <strong id="delete_interview_company_name"></strong> - <strong id="delete_job_position"></strong>?</p>
                <form action="{% url 'admin_candidate_profile' id=candidate.id %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="delete_interview_submit" value="true">
                    <input type="hidden" name="interview_id" id="delete_interview_id">
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>




<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle Edit Interview Modal Populating Data
        var editInterviewModal = document.getElementById('editInterviewModal');
        editInterviewModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget; // Button that triggered the modal
            
            var interviewId = button.getAttribute('data-id');
            var companyName = button.getAttribute('data-company-name');
            var jobPosition = button.getAttribute('data-job-position');
            var dateTime = button.getAttribute('data-date-time'); // Format YYYY-MM-DDTHH:MM
            var interviewerName = button.getAttribute('data-interviewer-name');
            var interviewerEmail = button.getAttribute('data-interviewer-email');
            var interviewerPhone = button.getAttribute('data-interviewer-phone');
            var status = button.getAttribute('data-status');
            var interviewMode = button.getAttribute('data-interview-mode');
            var location = button.getAttribute('data-location');
            var meetingLink = button.getAttribute('data-meeting-link');
            var notes = button.getAttribute('data-notes');
            var feedback = button.getAttribute('data-feedback');
            var rating = button.getAttribute('data-rating');
            var isTechnical = button.getAttribute('data-is-technical') === 'true';
            var duration = button.getAttribute('data-duration');
            var requirements = button.getAttribute('data-requirements');
            var attachmentUrl = button.getAttribute('data-attachment-url');
            var attachmentName = button.getAttribute('data-attachment-name');

            var modalForm = editInterviewModal.querySelector('#editInterviewForm');
            modalForm.querySelector('#edit_interview_id').value = interviewId;
            modalForm.querySelector('#edit_interview_company_name').value = companyName;
            modalForm.querySelector('#edit_job_position').value = jobPosition;
            modalForm.querySelector('#edit_interview_date_time').value = dateTime; // Set directly
            modalForm.querySelector('#edit_interviewer_name').value = interviewerName;
            modalForm.querySelector('#edit_interviewer_email').value = interviewerEmail;
            modalForm.querySelector('#edit_interviewer_phone').value = interviewerPhone;
            modalForm.querySelector('#edit_status').value = status;
            modalForm.querySelector('#edit_interview_mode').value = interviewMode;
            modalForm.querySelector('#edit_location').value = location;
            modalForm.querySelector('#edit_meeting_link').value = meetingLink;
            modalForm.querySelector('#edit_notes').value = notes;
            modalForm.querySelector('#edit_feedback').value = feedback;
            modalForm.querySelector('#edit_rating').value = rating;
            modalForm.querySelector('#edit_is_technical').checked = isTechnical;
            modalForm.querySelector('#edit_duration').value = duration;
            modalForm.querySelector('#edit_requirements').value = requirements;
            
            var currentAttachmentLink = modalForm.querySelector('#edit_current_attachment_link');
            if (attachmentUrl && attachmentUrl !== '#') {
                currentAttachmentLink.href = attachmentUrl;
                currentAttachmentLink.textContent = attachmentName;
                currentAttachmentLink.style.display = 'inline'; // Show the link
            } else {
                currentAttachmentLink.textContent = 'None';
                currentAttachmentLink.href = '#';
                currentAttachmentLink.style.display = 'none'; // Hide the link if no attachment
            }
            modalForm.querySelector('#clear_interview_attachment').checked = false; // Uncheck by default
        });

        // Handle Delete Interview Modal Populating Data
        var deleteInterviewModal = document.getElementById('deleteInterviewModal');
        deleteInterviewModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget; // Button that triggered the modal
            var interviewId = button.getAttribute('data-id');
            var companyName = button.getAttribute('data-company-name');
            var jobPosition = button.getAttribute('data-job-position');

            var modalBody = deleteInterviewModal.querySelector('.modal-body');
            modalBody.querySelector('#delete_interview_id').value = interviewId;
            modalBody.querySelector('#delete_interview_company_name').textContent = companyName;
            modalBody.querySelector('#delete_job_position').textContent = jobPosition;
        });

        // Initialize multi-select dropdowns (if you are using a library like Select2)
        // If you are using a library like Select2 for `preferred_location`, `sector`, `department`,
        // ensure you initialize them here. Example:
        // $('.select2').select2(); // Assuming your select elements have class 'select2'
    });
</script>

        <!-- BFSI Details Card -->
        {% if candidate.calling_remark == "Shortlisted for Banking Counselling" %}
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center ">
                    <h5 class="mb-0">BFSI Details</h5>
                    <a href="#" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modal-bfsi-data">
                        <i class="bi bi-pencil"></i> Edit
                    </a>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <span class="d-block detail-label">BFSI Batch Date</span>
                                <span class="detail-value">{{ candidate.bfsi_batch_date|date:"M d, Y"|default:"-" }}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <span class="d-block detail-label">BFSI Payment Status</span>
                                <span class="detail-value">{{ candidate.bfsi_payment_status|default:"-" }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <span class="d-block detail-label">BFSI Payment Date</span>
                                <span class="detail-value">{{ candidate.bfsi_payment_date|date:"M d, Y"|default:"-" }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <span class="d-block detail-label">BFSI Payment Remark</span>
                                <span class="detail-value">{{ candidate.bfsi_payment_remark|default:"-" }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <span class="d-block detail-label">BFSI Payment Attachment</span>
                                <span class="detail-value">
                                    {% if candidate.bfsi_payment_attachment %}
                                    <a href="{{candidate.bfsi_payment_attachment.url}}" target="_blank" class="text-primary">
                                        <i class="bi bi-file-earmark-text"></i> View Attachment
                                    </a>
                                    {% else %}
                                    <span class="empty-value">No Attachment</span>
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <span class="d-block detail-label">BFSI Candidature Status</span>
                                <span class="detail-value">{{ candidate.bfsi_candidature_status|default:"-" }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if candidate.selection_status == "Selected" %}
        <!-- Invoice Details Card -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center ">
                    <h5 class="mb-0">Invoice Details</h5>
                    <a href="#" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modal-invoice-data">
                        <i class="bi bi-pencil"></i> Edit
                    </a>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <span class="d-block detail-label">Invoice Status</span>
                                <span class="detail-value">
                                    {% if candidate.invoice_status == 'Other' and candidate.other_invoice_status %}
                                        {{ candidate.other_invoice_status }}
                                    {% else %}
                                        {{ candidate.invoice_status|default:"-" }}
                                    {% endif %}
                                </span>
                            </div>
                            <div class="mb-3">
                                <span class="d-block detail-label">Invoice Date</span>
                                <span class="detail-value">{{ candidate.invoice_date|date:"M d, Y"|default:"-" }}</span>
                            </div>
                            <div class="mb-3">
                                <span class="d-block detail-label">Invoice Amount</span>
                                <span class="detail-value">{{ candidate.invoice_amount|default:"-" }}</span>
                            </div>
                            <div class="mb-3">
                                <span class="d-block detail-label">Invoice Attachment</span>
                                <span class="detail-value">
                                    {% if candidate.invoice_attachment %}
                                    <a href="{{candidate.invoice_attachment.url}}" target="_blank" class="text-primary">
                                        <i class="bi bi-file-earmark-text"></i> View Attachment
                                    </a>
                                    {% else %}
                                    <span class="empty-value">No Attachment</span>
                                    {% endif %}
                                </span>
                            </div>
                            <div class="mb-3">
                                <span class="d-block detail-label">Invoice Remark</span>
                                <span class="detail-value">{{ candidate.invoice_remark|default:"-" }}</span>
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

<style>
  .activity-feed {
    padding: 0 1.5rem;
  }
  
  .activity-item {
    display: flex;
    padding: 1.5rem 0;
    border-bottom: 1px solid #f0f0f0;
    position: relative;
  }
  
  .activity-item.first-item {
    padding-top: 1rem;
  }
  
  .activity-avatar {
    margin-right: 1rem;
    flex-shrink: 0;
  }
  
  .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    background-size: cover;
    background-position: center;
  }
  
  .activity-content {
    flex-grow: 1;
  }
  
  .activity-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
  }
  
  .activity-user {
    line-height: 1.2;
  }
  
  .activity-user span {
    display: block;
    font-size: 0.8rem;
  }
  
  .activity-meta {
    text-align: right;
  }
  
  .activity-meta span {
    display: block;
    font-size: 0.8rem;
  }
  
  .activity-changes, .activity-remark {
    margin-top: 1rem;
    
    border-radius: 6px;
    padding: 0.75rem;
  }
  
  .changes-header, .remark-header {
    display: flex;
    align-items: center;
    color: #666;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.5rem;
  }
  
  .changes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 0.75rem;
  }
  
  .change-item {
    font-size: 0.9rem;
  }
  
  .change-field {
    font-weight: 500;
    margin-bottom: 0.25rem;
  }
  
  .change-values div {
    margin-bottom: 0.2rem;
  }
  
  .change-label {
    font-size: 0.8rem;
    color: #666;
    margin-right: 0.5rem;
  }
  
  .remark-content {
    font-size: 0.9rem;
    line-height: 1.5;
  }
  
  .empty-state {
    text-align: center;
    padding: 3rem 0;
  }
  
  .empty-icon {
    font-size: 2.5rem;
    color: #ddd;
    margin-bottom: 1rem;
  }
  
  .empty-state h5 {
    margin-bottom: 0.5rem;
  }
  
  @media (max-width: 768px) {
    .activity-header {
      flex-direction: column;
    }
    
    .activity-meta {
      text-align: left;
      margin-top: 0.5rem;
    }
    
    .changes-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
    </div>
    
    <div class="row mt-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header  border-bottom d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-primary">Activity History</h5>
                <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#activityCollapse" aria-expanded="true" aria-controls="activityCollapse">
                    <i class="bi bi-chevron-down"></i> <span class="d-none d-md-inline">Toggle View</span>
                </button>
            </div>
            <div class="collapse show" id="activityCollapse">
                <div class="card-body">
                    <div class="timeline-modern">
                        {% for activity in candidate.activities.all %}
                        <div class="timeline-item-modern mb-4">
                            <div class="timeline-icon-modern">
                                {% if activity.employee %}
                                    {% if activity.employee.employee_photo %}
                                    <img src="{{ activity.employee.employee_photo.url }}" class="rounded-circle shadow-sm" width="40" height="40" alt="{{ activity.employee.first_name }} {{ activity.employee.last_name }}">
                                    {% else %}
                                    <div class="d-flex align-items-center justify-content-center bg-info text-white rounded-circle shadow-sm" style="width: 40px; height: 40px; font-size: 1rem;">
                                        {{ activity.employee.first_name|first }}{{ activity.employee.last_name|first }}
                                    </div>
                                    {% endif %}
                                {% else %}
                                <div class="d-flex align-items-center justify-content-center bg-secondary text-white rounded-circle shadow-sm" style="width: 40px; height: 40px; font-size: 1rem;">
                                    <i class="bi bi-gear-fill"></i>
                                </div>
                                {% endif %}
                            </div>
                            <div class="timeline-content-modern p-3 border rounded">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <strong class="text-dark">
                                            {% if activity.employee %}
                                            {{ activity.employee.first_name }} {{ activity.employee.last_name }}
                                            <small class="text-muted">({{ activity.employee.designation }})</small>
                                            {% else %}
                                            System
                                            {% endif %}
                                        </strong>
                                    </div>
                                    <div class="text-muted small">{{ activity.timestamp|date:"M d, Y H:i" }}</div>
                                </div>

                                <div class="mb-2">
                                    <span class="badge text-white rounded-pill bg-{% if activity.action == 'created' %}success{% elif activity.action == 'updated' %}info{% elif activity.action == 'deleted' %}danger{% else %}primary{% endif %}">
                                        {{ activity.get_action_display }}
                                    </span>
                                </div>

                                {% if activity.changes %}
                                <div class="card p-2 mb-2  border">
                                    <h6 class="small text-muted mb-1">Changes:</h6>
                                    <table class="table table-sm table-borderless mb-0">
                                        <tbody>
                                            {% for field, values in activity.changes.items %}
                                            <tr>
                                                <td class="text-muted small py-0">{{ field|title }}</td>
                                                <td class="py-0">
                                                    {% if values.old %}
                                                    <span class="text-danger text-decoration-line-through small me-2">{{ values.old }}</span>
                                                    {% endif %}
                                                    {% if values.new %}
                                                    <span class="text-success small">{{ values.new }}</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% endif %}

                                {% if activity.remark %}
                                <div class="card p-2 bg-white border">
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="bi bi-chat-square-text-fill me-2 text-primary"></i>
                                        <h6 class="small text-muted mb-0">Remark:</h6>
                                    </div>
                                    <div class="small text-dark">{{ activity.remark }}</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-5">
                            <i class="bi bi-journal-check display-4 text-muted mb-3"></i>
                            <div class="text-muted">No activity recorded yet.</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<style>
    /* Custom CSS for Modern Timeline */
.timeline-modern {
    position: relative;
    padding-left: 50px; /* Space for the icons and line */
}

.timeline-modern::before {
    content: '';
    position: absolute;
    top: 0;
    left: 20px; /* Aligns with the center of the icon */
    width: 2px;
    height: 100%;
    background-color: #e0e0e0; /* Light grey line */
    z-index: 0;
}

.timeline-item-modern {
    position: relative;
    margin-bottom: 20px;
    display: flex;
    align-items: flex-start; /* Align content to the top */
}

.timeline-icon-modern {
    position: absolute;
    left: 0;
    top: 0;
    width: 40px;
    height: 40px;
    background-color: #fff; /* White background for the icon circle */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1; /* Ensure icon is above the line */
    border: 2px solid #e0e0e0; /* Light border around the icon */
}

.timeline-content-modern {
    flex-grow: 1;
    margin-left: 20px; /* Space between icon and content */
    border-left: 3px solid var(--bs-primary); /* Accent border */
    padding-left: 15px !important; /* Padding for the accent border */
}

/* Adjustments for badges and table in changes */
.timeline-content-modern .badge {
    font-size: 0.75rem;
    padding: 0.4em 0.7em;
}

.timeline-content-modern table td {
    padding-top: 0.2rem !important;
    padding-bottom: 0.2rem !important;
}
</style>

{% include "crm/partials/candidate_form.html" %}



{% endblock %}