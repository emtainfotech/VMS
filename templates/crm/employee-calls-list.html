{% extends 'crm/base.html' %}

{% block content %}
<div class="page-wrapper">
    <div class="page-header d-print-none">
        <div class="container-xl">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <h2 class="page-title">Employee Call Report</h2>
                    <div class="text-muted mt-1">
                        Showing call data from <strong>{{ start_date|date:"M d, Y" }}</strong> to <strong>{{ end_date|date:"M d, Y" }}</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="page-body">
        <div class="container-xl">
            <div class="card">
                <div class="card-header"><h3 class="card-title">Filter Report</h3></div>
                <div class="card-body">
                    <form method="get" action="{% url 'admin_calls_list' %}">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label class="form-label">Period</label>
                                <select name="period" class="form-select">
                                    <option value="today" {% if period == 'today' %}selected{% endif %}>Today</option>
                                    <option value="week" {% if period == 'week' %}selected{% endif %}>This Week</option>
                                    <option value="month" {% if period == 'month' %}selected{% endif %}>This Month</option>
                                    <option value="year" {% if period == 'year' %}selected{% endif %}>This Year</option>
                                    <option value="custom" {% if period == 'custom' %}selected{% endif %}>Custom Range</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Start Date</label>
                                <input type="date" name="start_date" class="form-control" value="{{ start_date|date:'Y-m-d' }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">End Date</label>
                                <input type="date" name="end_date" class="form-control" value="{{ end_date|date:'Y-m-d' }}">
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary w-100">Apply Filter</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header"><h3 class="card-title">All Employees: Call Volume Trend</h3></div>
                <div class="card-body">
                    <div id="mainChart"></div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header"><h3 class="card-title">Employee Breakdown</h3></div>
                <div class="table-responsive">
                    <table class="table card-table table-vcenter text-nowrap">
                        <thead>
                            <tr>
                                <th>Employee Name</th>
                                <th>Total Activities</th>
                                <th>Connected</th>
                                <th>Not Connected</th>
                                <th>Last Activity</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in employee_stats %}
                            <tr class="employee-row" data-employee-id="{{ stat.id }}" data-employee-name="{{ stat.user.get_full_name|default:stat.user.username }}" style="cursor: pointer;">
                                <td>{{ stat.user.get_full_name|default:stat.user.username }} ({{ stat.employee_id }})</td>
                                <td><span class="badge bg-blue text-blue-fg">{{ stat.total_calls }}</span></td>
                                <td><span class="badge bg-green text-green-fg">{{ stat.connected_calls }}</span></td>
                                <td><span class="badge bg-red text-red-fg">{{ stat.not_connected_calls }}</span></td>
                                <td>{% if stat.last_call_made %}{{ stat.last_call_made|date:"M d, Y H:i" }}{% else %}N/A{% endif %}</td>
                            </tr>
                            <tr class="candidate-details-row" id="details-for-{{ stat.id }}" style="display: none;">
                                <td colspan="5" class="p-0">
                                    <div class="details-container p-3">
                                        <div class="card mb-3">
                                             <div class="card-header"><h3 class="card-title" id="chart-title-for-{{ stat.id }}">Call Volume Trend</h3></div>
                                            <div class="card-body">
                                                <div id="chart-for-{{ stat.id }}"></div>
                                            </div>
                                        </div>
                                        <div class="candidate-list-container"></div>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="5" class="text-center">No call data found for the selected period.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const chartInstances = {};

    function getBaseChartOptions(labels, seriesData, chartTitle) {
        return {
            chart: { type: 'area', height: 300, zoom: { enabled: false }, toolbar: { show: true, tools: { download: true, selection: false, zoom: false, zoomin: false, zoomout: false, pan: false, reset: false } } },
            series: [{ name: chartTitle, data: seriesData }],
            labels: labels,
            xaxis: { type: 'category', labels: { rotate: -20, rotateAlways: false, hideOverlappingLabels: true, trim: true } },
            yaxis: { min: 0, tickAmount: 5, labels: { formatter: (val) => val.toFixed(0) } },
            dataLabels: { enabled: false },
            stroke: { curve: 'smooth', width: 2 },
            fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.2, stops: [0, 90, 100] } },
            tooltip: { theme: 'dark' }
        };
    }

    const mainChartOptions = getBaseChartOptions({{ main_chart_labels|safe }}, {{ main_chart_data|safe }}, 'Total Activities');
    const mainChart = new ApexCharts(document.querySelector("#mainChart"), mainChartOptions);
    mainChart.render();

    document.querySelectorAll('.employee-row').forEach(row => {
        row.addEventListener('click', async function () {
            const employeeId = this.dataset.employeeId;
            const employeeName = this.dataset.employeeName;
            const detailsRow = document.getElementById(`details-for-${employeeId}`);
            const candidateContainer = detailsRow.querySelector('.candidate-list-container');
            const chartContainer = detailsRow.querySelector(`#chart-for-${employeeId}`);
            const chartTitle = detailsRow.querySelector(`#chart-title-for-${employeeId}`);
            const isVisible = detailsRow.style.display === 'table-row';

            detailsRow.style.display = isVisible ? 'none' : 'table-row';
            this.classList.toggle('active', !isVisible);

            if (!isVisible && candidateContainer.innerHTML.trim() === '') {
                candidateContainer.innerHTML = '<div class="text-center p-4">Loading details...</div>';
                chartTitle.innerText = `Activity Trend for ${employeeName}`;

                const startDate = "{{ start_date|date:'Y-m-d' }}";
                const endDate = "{{ end_date|date:'Y-m-d' }}";
                const url = `{% url 'get_employee_candidates' %}?employee_id=${employeeId}&start_date=${startDate}&end_date=${endDate}`;
                
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    
                    const result = await response.json();
                    candidateContainer.innerHTML = result.html;

                    if (chartInstances[employeeId]) {
                        chartInstances[employeeId].destroy();
                    }
                    const employeeChartOptions = getBaseChartOptions(result.chart_data.labels, result.chart_data.data, 'Activities');
                    chartInstances[employeeId] = new ApexCharts(chartContainer, employeeChartOptions);
                    chartInstances[employeeId].render();

                } catch (error) {
                    console.error('Failed to fetch employee details:', error);
                    candidateContainer.innerHTML = '<div class="text-center p-4 text-danger">Failed to load data.</div>';
                }
            }
        });
    });
});
</script>
{% endblock %}