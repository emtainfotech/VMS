{% extends 'crm/base.html' %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
<style>
    .clickable-card .card:hover {
        border-color: #206bc4;
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15);
        cursor: pointer;
        transform: translateY(-2px);
        transition: all .2s ease-in-out;
    }
    .employee-row.active {
        background-color: #e9f2ff !important;
    }
    .ts-control {
        padding: .5rem .75rem !important;
        font-size: .875rem;
    }
</style>

<div class="page-wrapper">
    <div class="page-header d-print-none">
        <div class="container-xl">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <h2 class="page-title">Employee Call Report</h2>
                    <div class="text-muted mt-1">
                        Showing call data from <strong>{{ start_date|date:"M d, Y" }}</strong> to <strong>{{ end_date|date:"M d, Y" }}</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="page-body">
        <div class="container-xl">
            <div class="card card-body mb-4">
    <form method="get" action="{% url 'admin_calls_list' %}" id="main-filter-form">
        <div class="row g-3 align-items-end">
            
            <div class="col-md-4">
                <label class="form-label">Filter by Employee(s)</label>
                <select name="employees" id="employee_filter" multiple>
                    <option value="all">All Employees</option>
                    {% for employee in all_employees %}
                        <option value="{{ employee.id }}" {% if employee.id in selected_employee_ids %}selected{% endif %}>
                            {{ employee.first_name }} {{ employee.last_name }} ({{ employee.user.username }})
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label">Period</label>
                <select name="period" id="period_filter" class="form-select">
                    <option value="today" {% if period == 'today' %}selected{% endif %}>Today</option>
                    <option value="week" {% if period == 'week' %}selected{% endif %}>This Week</option>
                    <option value="month" {% if period == 'month' %}selected{% endif %}>This Month</option>
                    <option value="year" {% if period == 'year' %}selected{% endif %}>This Year</option>
                    <option value="custom" {% if period == 'custom' %}selected{% endif %}>Custom Range</option>
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label">Start Date</label>
                <input type="date" name="start_date" id="start_date_filter" class="form-control" value="{{ start_date|date:'Y-m-d' }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">End Date</label>
                <input type="date" name="end_date" id="end_date_filter" class="form-control" value="{{ end_date|date:'Y-m-d' }}">
            </div>

            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Apply Filter</button>
            </div>
        </div>
    </form>
</div>
            
            <div class="row g-4 mb-4">
                <div class="col-md-6 col-lg-2 clickable-card" data-filter-type="total"><div class="card"><div class="card-body text-center"><div class="h1 mb-3">{{ total_stats.total_activities }}</div><div class="text-muted">Total Calls</div></div></div></div>
                <div class="col-md-6 col-lg-2 clickable-card" data-filter-type="connected"><div class="card"><div class="card-body text-center"><div class="h1 mb-3 text-success">{{ total_stats.total_connected }}</div><div class="text-muted">Total Connected</div></div></div></div>
                <div class="col-md-6 col-lg-2 clickable-card" data-filter-type="not_connected"><div class="card"><div class="card-body text-center"><div class="h1 mb-3 text-danger">{{ total_stats.total_not_connected }}</div><div class="text-muted">Total Not Connected</div></div></div></div>
                <div class="col-md-6 col-lg-2 clickable-card" data-filter-type="leads"><div class="card"><div class="card-body text-center"><div class="h1 mb-3 text-warning">{{ total_stats.total_leads_generated }}</div><div class="text-muted">Total Leads Generated</div></div></div></div>
                <div class="col-md-6 col-lg-2 clickable-card" data-filter-type="selected"><div class="card"><div class="card-body text-center"><div class="h1 mb-3 text-success">{{ total_stats.total_selections }}</div><div class="text-muted">Total Selection's</div></div></div></div>
                <div class="col-md-6 col-lg-2 clickable-card" data-filter-type="converted"><div class="card"><div class="card-body text-center"><div class="h1 mb-3 text-primary">{{ total_stats.total_conversion_percentage|default:0 }}%</div><div class="text-muted">Total Conversion</div></div></div></div>
            </div>

            <div id="activity-details-container" class="mb-4"></div>

            <div class="card mb-4">
                <div class="card-header"><h3 class="card-title">Employee Breakdown</h3></div>
                <div class="table-responsive">
                    <table class="table card-table table-vcenter text-nowrap table-striped table-hover">
                        <thead><tr><th>Employee Name</th><th>Total Activities</th><th>Connected</th><th>Not Connected</th><th>Leads Generated</th><th>Selections</th><th>H-C Conv. %</th><th>Last Activity</th></tr></thead>
                        <tbody>
                            {% for stat in employee_stats %}
                            <tr class="employee-row" data-employee-id="{{ stat.id }}" data-employee-name="{{ stat.first_name }} {{ stat.last_name }} ({{ stat.user.username }})" style="cursor: pointer;">
                                <td>{{ stat.first_name }} {{ stat.last_name }} ({{ stat.user.username }})</td>
                                <td><span class="badge bg-blue text-blue-fg">{{ stat.total_calls }}</span></td>
                                <td><span class="badge bg-green text-green-fg">{{ stat.connected_calls }}</span></td>
                                <td><span class="badge bg-red text-red-fg">{{ stat.not_connected_calls }}</span></td>
                                <td><span class="badge bg-warning text-warning-fg">{{ stat.leads_generated }}</span></td>
                                <td><span class="badge bg-info text-info-fg">{{ stat.selections }}</span></td>
                                <td><span class="badge" style="background-color: #e5dff6; color: #6f42c1;">{{ stat.conversion_percentage }}%</span></td>
                                <td>{% if stat.last_call_made %}{{ stat.last_call_made|date:"M d, Y H:i" }}{% else %}N/A{% endif %}</td>
                            </tr>
                            <tr class="candidate-details-row" id="details-for-{{ stat.id }}" style="display: none;">
                                <td colspan="8" class="p-0">
                                    <div class="details-container p-3">
                                        <div class="candidate-list-container"></div>
                                        <div class="row g-4 mt-3">
                                            <div class="col-lg-6"><div class="card"><div class="card-header"><h3 class="card-title" id="activity-chart-title-for-{{ stat.id }}">Activity Trend</h3></div><div class="card-body"><div id="activity-chart-for-{{ stat.id }}"></div></div></div></div>
                                            <div class="col-lg-6"><div class="card"><div class="card-header"><h3 class="card-title" id="leads-chart-title-for-{{ stat.id }}">Lead Gen Trend</h3></div><div class="card-body"><div id="leads-chart-for-{{ stat.id }}"></div></div></div></div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="8" class="text-center">No activity data found for the selected filters.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="row g-4"><div class="col-lg-6"><div class="card"><div class="card-header"><h3 class="card-title">All Employees: Activity Volume Trend</h3></div><div class="card-body"><div id="mainActivityChart"></div></div></div></div><div class="col-lg-6"><div class="card"><div class="card-header"><h3 class="card-title">All Employees: Lead Generation Trend</h3></div><div class="card-body"><div id="mainLeadsChart"></div></div></div></div></div>
            <div class="row mt-4">
                <div class="col-lg-12 mb-4">
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Scheduled Interviews</h3></div>
                        <div class="card-body"><div class="table-responsive"><table class="table table-vcenter table-hover"><thead><tr><th>Candidate</th><th>Status</th><th>Employee</th><th>Time</th><th class="w-1"></th></tr></thead><tbody>{% for interview in interview_detail %}<tr class="interview-row clickable-row" data-date="{{ interview.interview_date_time|date:'Y-m-d' }}" data-interview-id="{{ interview.id }}" data-url="{% if interview.candidate.lead_source == 'EVMS' %}{% url 'evms_candidate_profile' interview.candidate.id %}{% else %}{% url 'admin_candidate_profile' interview.candidate.id %}{% endif %}"><td>{{ interview.candidate.candidate_name }}</td><td>{{ interview.status }}</td><td>{{ interview.candidate.employee_name }}</td><td class="interview-time" data-time="{{ interview.interview_date_time|date:'H:i' }}">{{ interview.interview_date_time|date:"M d, Y H:i" }}</td><td><a href="{% if interview.candidate.lead_source == 'EVMS' %}{% url 'evms_candidate_profile' interview.candidate.id %}{% else %}{% url 'admin_candidate_profile' interview.candidate.id %}{% endif %}" class="btn btn-link">View</a></td></tr>{% empty %}<tr><td colspan="7" class="text-center py-4"><div class="empty"><div class="empty-icon"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /><path d="M9 10l.01 0" /><path d="M15 10l.01 0" /><path d="M9.5 15.25a3.5 3.5 0 0 1 5 0" /></svg></div><p class="empty-title">No interviews found for the selected period.</p></div></td></tr>{% endfor %}</tbody></table></div></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header"><h3 class="card-title">Scheduled Follow Ups</h3></div>
                    <div class="card-body"><div class="table-responsive"><table class="table table-vcenter table-hover"><thead><tr><th>Candidate</th><th>Unique Code</th><th>Mobile Number</th><th>Employee</th><th>Time</th><th class="w-1"></th></tr></thead><tbody>{% for follow_up in follow_up_candidates %}<tr class="followup-row clickable-row" data-date="{{ follow_up.next_follow_up_date_time|date:'Y-m-d' }}" data-followup-id="{{ follow_up.id }}" data-url="{% if follow_up.lead_source == 'EVMS' %}{% url 'evms_candidate_profile' follow_up.id %}{% else %}{% url 'admin_candidate_profile' follow_up.id %}{% endif %}"><td>{{ follow_up.candidate_name }}</td><td>{% if follow_up.lead_source == 'EVMS' %}{{ follow_up.refer_code|default:"-" }}-{{ follow_up.unique_id|default:"-" }}{% else %}{{ follow_up.unique_code|default:"-" }}{% endif %}</td><td>{{ follow_up.candidate_mobile_number|default:"-" }}</td><td>{{ follow_up.employee_name }}</td><td class="followup-time" data-time="{{ follow_up.next_follow_up_date_time|date:'H:i' }}">{{ follow_up.next_follow_up_date_time|date:"M d, Y H:i" }}</td><td>{% if follow_up.lead_source == 'EVMS' %}<a href="{% url 'evms_candidate_profile' follow_up.id %}" class="btn btn-link btn-sm">View</a>{% else %}<a href="{% url 'admin_candidate_profile' follow_up.id %}" class="btn btn-link btn-sm">View</a>{% endif %}</td></tr>{% empty %}<tr><td colspan="7" class="text-center py-4">No follow-ups found for the selected period.</td></tr>{% endfor %}</tbody></table></div></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    
    // --- Initialize Tom Select (if the element exists) ---
    const employeeFilterElement = document.getElementById('employee_filter');
    if (employeeFilterElement) {
        let employeeSelect = new TomSelect('#employee_filter', {
            plugins: ['remove_button'],
            onItemAdd: function(value, item) {
                if (value !== 'all' && this.items.includes('all')) {
                    this.removeItem('all', true);
                }
                if (value === 'all' && this.items.length > 1) {
                    let currentItems = [...this.items];
                    currentItems.forEach(itemId => {
                        if (itemId !== 'all') {
                            this.removeItem(itemId, true);
                        }
                    });
                }
            },
        });

        if ({{ selected_employee_ids|length }} === 0) {
            employeeSelect.addItem('all', true);
        }
    }
    
    // --- General Filter and AJAX Logic with safety checks ---
    const periodSelect = document.getElementById('period_filter');
    const startDateInput = document.getElementById('start_date_filter');
    const endDateInput = document.getElementById('end_date_filter');

    function toggleDateInputs() {
        // This function will only run if all date-related elements exist
        if (periodSelect && startDateInput && endDateInput) {
            const isCustom = periodSelect.value === 'custom';
            startDateInput.disabled = !isCustom;
            endDateInput.disabled = !isCustom;
        }
    }

    // Add event listener only if the period select element exists
    if (periodSelect) {
        periodSelect.addEventListener('change', toggleDateInputs);
        toggleDateInputs(); // Run on page load
    }

    function getCurrentFilters() {
        const params = new URLSearchParams();
        if (startDateInput && endDateInput) {
            params.append('start_date', startDateInput.value);
            params.append('end_date', endDateInput.value);
        }
        
        const tomSelectInstance = employeeFilterElement ? employeeFilterElement.tomselect : null;
        if (tomSelectInstance) {
            for (const value of tomSelectInstance.items) {
                params.append('employees', value);
            }
        }
        return params.toString();
    }
    
    function toggleDateInputs() {
        const isCustom = periodSelect.value === 'custom';
        startDateInput.disabled = !isCustom;
        endDateInput.disabled = !isCustom;
    }
    periodSelect.addEventListener('change', toggleDateInputs);
    toggleDateInputs();

    const detailsContainer = document.getElementById('activity-details-container');
    document.querySelectorAll('.clickable-card').forEach(card => {
        card.addEventListener('click', async function() {
            const filterType = this.dataset.filterType;
            detailsContainer.innerHTML = '<div class="card card-body text-center">Loading details...</div>';

            const filterParams = getCurrentFilters();
            const url = `{% url 'get_filtered_activity_list' %}?list_type=${filterType}&${filterParams}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                const html = await response.text();
                detailsContainer.innerHTML = html;
                window.scrollTo({ top: detailsContainer.offsetTop - 80, behavior: 'smooth' });
            } catch (error) {
                console.error('Failed to fetch details:', error);
                detailsContainer.innerHTML = '<div class="card card-body text-center text-danger">Failed to load details.</div>';
            }
        });
    });
    
    document.addEventListener('click', function(event) {
        if (event.target && event.target.id === 'close-details-table') {
            detailsContainer.innerHTML = '';
        }
    });

    const chartInstances = {};
    document.querySelectorAll('.employee-row').forEach(row => {
        row.addEventListener('click', async function () {
            const employeeId = this.dataset.employeeId;
            const detailsRow = document.getElementById(`details-for-${employeeId}`);
            const isVisible = detailsRow.style.display === 'table-row';

            document.querySelectorAll('.candidate-details-row').forEach(r => r.style.display = 'none');
            document.querySelectorAll('.employee-row').forEach(r => r.classList.remove('active'));

            detailsRow.style.display = isVisible ? 'none' : 'table-row';
            if (!isVisible) {
                this.classList.add('active');
            }

            const candidateContainer = detailsRow.querySelector('.candidate-list-container');
            if (!isVisible && candidateContainer.innerHTML.trim() === '') {
                candidateContainer.innerHTML = '<div class="text-center p-4">Loading details...</div>';
                
                const filterParams = getCurrentFilters();
                const url = `{% url 'get_employee_candidates' %}?employee_id=${employeeId}&${filterParams}`;
                
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    const result = await response.json();
                    candidateContainer.innerHTML = result.html;

                    if (chartInstances[employeeId]) {
                        chartInstances[employeeId].activity.destroy();
                        chartInstances[employeeId].leads.destroy();
                    }
                    const activityChartContainer = detailsRow.querySelector(`#activity-chart-for-${employeeId}`);
                    const leadsChartContainer = detailsRow.querySelector(`#leads-chart-for-${employeeId}`);
                    
                    const empActivityChart = new ApexCharts(activityChartContainer, getBaseChartOptions(result.activity_chart_data.labels, result.activity_chart_data.data, 'Activities', ['#206bc4']));
                    empActivityChart.render();

                    const empLeadsChart = new ApexCharts(leadsChartContainer, getBaseChartOptions(result.leads_chart_data.labels, result.leads_chart_data.data, 'Leads', ['#f59f00']));
                    empLeadsChart.render();
                    
                    chartInstances[employeeId] = { activity: empActivityChart, leads: empLeadsChart };
                } catch (error) {
                    console.error('Failed to fetch employee details:', error);
                    candidateContainer.innerHTML = '<div class="text-center p-4 text-danger">Failed to load data.</div>';
                }
            }
        });
    });

    function getBaseChartOptions(labels, seriesData, chartTitle, colors) {
        return {
            chart: { type: 'area', height: 300, zoom: { enabled: false }, toolbar: { show: true, tools: { download: true, selection: false, zoom: false, zoomin: false, zoomout: false, pan: false, reset: false } } },
            colors: colors, series: [{ name: chartTitle, data: seriesData }], labels: labels,
            xaxis: { type: 'category', labels: { rotate: -45, rotateAlways: false, hideOverlappingLabels: true, trim: true, style: { fontSize: '10px' } } },
            yaxis: { min: 0, tickAmount: 5, labels: { formatter: (val) => val.toFixed(0) } },
            dataLabels: { enabled: false }, stroke: { curve: 'smooth', width: 2 },
            fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.2, stops: [0, 90, 100] } },
            tooltip: { theme: 'dark' }
        };
    }

    if (document.querySelector("#mainActivityChart")) {
        const mainActivityChart = new ApexCharts(document.querySelector("#mainActivityChart"), getBaseChartOptions({{ main_chart_labels|safe }}, {{ main_chart_data|safe }}, 'Total Activities', ['#206bc4']));
        mainActivityChart.render();
    }
    if (document.querySelector("#mainLeadsChart")) {
        const mainLeadsChart = new ApexCharts(document.querySelector("#mainLeadsChart"), getBaseChartOptions({{ leads_chart_labels|safe }}, {{ leads_chart_data|safe }}, 'Leads Generated', ['#f59f00']));
        mainLeadsChart.render();
    }
});
</script>

{% endblock %}